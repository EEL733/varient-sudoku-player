/*! @license pzpr.js v63f82a3 (c) 2009-2025 sabo2, MIT license
 *   https://github.com/sabo2/pzprv3 */
!function(){var t,e,i,s,n,r,o,a,h,l,c,u,d,f,b,p={version:"63f82a3"},m=("object"==typeof module&&module.exports?module.exports=p:this.pzpr=p,!function(){var L=this.document,t={exports:{}};!function(t,e){var l,c,u,d,f,r,s,n,b=void 0!==L?L:void 0,p=2*Math.PI,i=[],o=function(){for(var t=[],e=256;e<512;e++)t[e-256]=e.toString(16).substr(1);return t}(),m={version:"0.8.2",env:{node:"object"==typeof t&&"object"==typeof e&&"function"==typeof require,browser:"object"==typeof L&&"object"==typeof window&&"object"==typeof location},wrapper:{},addWrapper:function(t,e){function i(){this.initialize&&this.initialize.apply(this,arguments)}for(var s in this.wrapperbase)i.prototype[s]=this.wrapperbase[s];for(s in e)i.prototype[s]=e[s];this.wrapper[t]=i.prototype.constructor=i,this.addType(t)},_order:[],enable:{},addType:function(t){this._order.push(t),this.enable[t]=!0,this.current||(this.current=t)},TypeList:function(t){for(var e=0;e<m._order.length;e++)this[m._order[e]]=m._order[e]===t},current:"",select:function(t){return!!this.enable[t]&&(this.current=t,!0)},ME:null,initME:function(){var t=b.createElement("div");t.style.display="inline",t.style.position="absolute",t.style.top="0px",t.style.left="-9000px",t.innerHTML="",b.body.appendChild(t),void 0!==t.offsetHeight?this.ME=t:b.body.removeChild(t)},getoffsetHeight:function(t,e){var i,s;return e.match(/(.+\s)?([0-9]+)px (.+)$/)?i=+RegExp.$2:this.ME&&((s=this.ME).style.font=e,s.style.lineHeight="100%",s.innerHTML=t,i=s.offsetHeight),i},color:i,parse:function(t){var e;return i[t]||("rgb("===t.substr(0,4)?(e=t.match(/\d+/g),i[t]=["#",o[e[0]],o[e[1]],o[e[2]]].join("")):i[t]=t),i[t]},getRectSize:function(t){return{width:t.offsetWidth||t.clientWidth||0,height:t.offsetHeight||t.clientHeight||0}},_counter:-1,getcanvasid:function(){return this._counter++,"_candle_"+this._counter},start:function(t,e,i){var s;if(this.ME||"undefined"==typeof window||this.initME(),t.getContext)s=t.getContext("2d");else{if(!(e=this.enable[e]?e:this.current)||!this.enable[e])throw"No canvas environment is installed";s=new this.wrapper[e](t)}i&&i(s)}};function g(t){return b.createElementNS(c,t)}function a(){var t,e;if(this.parentNode)return 0<=(e=(t=this.parentNode._children).indexOf(this))?t[e+1]:null}function h(t){t.parentNode&&t.parentNode.removeChild(t),this._children.push(t),t.parentNode=this}function v(t){var e=this._children.indexOf(t);return 0<=e&&(this._children.splice(e,1),t.parentNode=null),t}function y(t,e){t.parentNode&&t.parentNode.removeChild(t);var i=-1;-1===(i=e?this._children.indexOf(e):i)?this.appendChild(t):this._children.splice(i,0,t)}function x(t,e){t=(t=(t=t.replace(/\*/g,"[^/]+")).replace(/([\w#]+|\*)/g,"[^/]*$1[^/]*")).replace(/\s+/g,"/([^/]+/)?"),t=new RegExp(t+"[^/]*$");for(var i=this.firstChild?[this.firstChild]:[],s=[];0<i.length;){var n=i.pop();if(function(t,e){for(var i="";t&&t!==e;){var s="";t.createElement||(s=t.tagName+(t._attr.id?"#"+t._attr.id:"")),i=s+(i?"/"+i:""),t=t.parentNode}return i}(n,this).match(t)&&(s.push(n),e))break;n.nextSibling&&i.push(n.nextSibling),0<n.childNodes.length&&i.push(n.firstChild)}return s}function k(t){return x.call(this,t,!1)}function w(t){return x.call(this,t,!0)[0]||null}function C(){return this._children.reduce(function(t,e,i,s){return t+e.outerHTML},"")}function q(t,e){for(;;){var i=e.match(/^\s*([\w\-\:]+)(\=)?(?:['"](.+?)['"]|([^\s]+))?\s*/);if(!i)break;var s=i[1],n=i[3]||i[4]||"";e=RegExp["$'"],s&&("="===i[2]?"style"!==s?t.setAttribute(s,n):t.style=function(t,e){for(;;){var i=e.match(/^\s*([^:]+?):([^;]+?);?/);if(!i)break;t.style[i[1]]=i[2],e=RegExp["$'"]}}(t,n):t.setAttribute(s,!0))}}function z(t){this.tagName=t,this._attr={},this.style={},this._children=[]}if("object"==typeof t&&"object"==typeof e?t.exports=m:this.Candle=m,z.prototype={tagName:"",style:null,_attr:null,_children:null,parentNode:null,nodeType:1,get nodeName(){return this.tagName},get firstChild(){return this._children[0]},get lastChild(){return this._children[this._children.length-1]},get childNodes(){return this._children},get nextSibling(){return a.call(this)},appendChild:h,removeChild:v,insertBefore:y,setAttribute:function(t,e){this._attr[t]=e},setAttributeNS:function(t,e,i){this._attr[e]=i},getAttribute:function(t){return t in this._attr?this._attr[t]:null},getAttributeNS:function(t,e){return e in this._attr?this._attr[e]:null},removeAttribute:function(t){delete this._attr[t]},get id(){return this._attr.id||""},get innerHTML(){return C.call(this)},get outerHTML(){return function(){var t,e,i=this.tagName,s="",n="";for(t in this._attr)s+=" "+t+'="'+this._attr[t]+'"';for(e in this.style)n+=e+":"+this.style[e]+";";return n&&(s+=' style="'+n+'"'),0===this._children.length?"<"+i+s+"/>":"<"+i+s+">"+this.innerHTML+"</"+i+">"}.call(this)},get textContent(){return this.innerHTML.replace(/<.+?>/g,"")},set textContent(t){this._children.forEach(function(t){this.removeChild(t)}.bind(this)),this.appendChild(new r(t))},querySelector:w,querySelectorAll:k},(r=function(t){this.data=t}).prototype={_attr:{},parentNode:null,nodeType:3,nodeName:"#text",data:"",firstChild:null,chilsNodes:[],get nextSibling(){return a.call(this)},get outerHTML(){return this.data}},(s=m.MockDocument=function(){this._children=[]}).prototype={_children:null,nodeType:9,nodeName:"#document",createElement:function(t){return new z(t)},createElementNS:function(t,e){return new z(e)},createTextNode:function(t){return new r(t)},get firstChild(){return this._children[0]},get lastChild(){return this._children[this._children.length-1]},get childNodes(){return this._children},appendChild:h,removeChild:v,insertBefore:y,get innerHTML(){return C.call(this)},get outerHTML(){return C.call(this)},querySelector:w,querySelectorAll:k,getElementById:function(t){return this.querySelector("#"+t)}},(e=m.MockXMLSerializer=function(){}).prototype.serializeToString=function(t){return t.outerHTML},(t=m.MockDOMParser=function(){}).prototype.parseFromString=function(t,e){return i=new s,n=[i],t.split(/(<.+?>)/g).forEach(function(t){var e,i,s=n[n.length-1];t.match(/^<\?xml/)||(t.match(/^<\w/)?(e=t.match(/<(\w+)\s*(.*)\/?>/),q(i=new z(e[1]),e[2]),s.appendChild(i),t.match(/\/>$/)||n.push(i)):t.match(/^<\//)?n.pop():t.match(/^[\s\t\r\n]*$/)||s.appendChild(new r(t)))}),i;var i,n},b=b||new s,m.document=b,m.XMLSerializer=e,m.DOMParser=t,m.wrapperbase={initialize:function(t){this.fillStyle="black",this.strokeStyle="black",this.lineWidth=1,this.font="14px system",this.textAlign="center",this.textBaseline="middle",this.canvas=t,this.canvasid=m.getcanvasid(),this.child=null,this.enableTextLengthWA=!1,this.initElement(),this.initFunction(),this.initLayer();var e=this;this.canvas.getContext=function(t){return e}},rectcenter:function(t,e,i,s){this.rect(t-i,e-s,2*i,2*s)},fillRectCenter:function(t,e,i,s){this.fillRect(t-i,e-s,2*i,2*s)},strokeRectCenter:function(t,e,i,s){this.strokeRect(t-i,e-s,2*i,2*s)},shapeRectCenter:function(t,e,i,s){this.shapeRect(t-i,e-s,2*i,2*s)},vhide:function(){}},void 0===b||!b.createElementNS||"object"==typeof window&&window.opera||(c=m.SVGNS="http://www.w3.org/2000/svg",u=m.XLINKNS="http://www.w3.org/1999/xlink",d=(e=m.env.browser&&navigator.userAgent||"").match(/Trident\//)||e.match(/Safari\//)&&e.match(/Edge\//),f={left:"start",center:"middle",right:"end"},m.addWrapper("svg",{initialize:function(t){var e;this.use=new m.TypeList("svg"),l||(e="undefined"!=typeof navigator&&navigator.userAgent||"",l=e.match(/Chrome/)?{"candle-top":-.72,top:-.95,hanging:-.72,middle:-.35,alphabetic:0,bottom:.25}:e.match(/AppleWebKit/)?{"candle-top":-.7,top:-.9,hanging:-.9,middle:-.35,alphabetic:0,bottom:.25}:e.match(/Trident/)?{"candle-top":-.74,top:-1.02,hanging:-1.02,middle:-.32,alphabetic:0,bottom:.45}:e.match(/Win/)?{"candle-top":-.7,top:-.85,hanging:-.85,middle:-.34,alphabetic:0,bottom:.15}:{"candle-top":-.76,top:-.9,hanging:-.9,middle:-.38,alphabetic:0,bottom:.08}),this.vid="",this.elements={},this._textcache={},this.target=null,this.layers={},this.cpath=[],this.lastpath="",this.freezepath=!1,m.wrapperbase.initialize.call(this,t),this.enableTextLengthWA=d},initElement:function(){m.env.browser&&(this.canvas.style.overflow="hidden");var t=m.getRectSize(this.canvas),e=this.child=b.createElementNS(c,"svg");e.setAttribute("xmlns",c),e.setAttribute("xmlns:xlink",u),e.setAttribute("font-size","10px"),e.setAttribute("font-family","sans-serif"),e.setAttribute("width",t.width),e.setAttribute("height",t.height),e.setAttribute("viewBox",[0,0,t.width,t.height].join(" ")),this.canvas.appendChild&&this.canvas.appendChild(e)},initFunction:function(){function s(t){return(t.outerHTML||(new m.XMLSerializer).serializeToString(t)).replace(/^<\?xml.+?\?>[\r\n]*/,"")}var n='<?xml version="1.0" encoding="UTF-8"?>\n',r=this.child;this.canvas.toDataURL=function(t,e){return"data:image/svg+xml;base64,"+(i=s(r),m.env.browser?window.btoa(i):(Buffer.isBuffer(i)?i:new Buffer(i.toString(),"binary")).toString("base64"));var i},this.canvas.toBlob=function(t,e,i){t(new Blob([n+s(r)],{type:"image/svg+xml"}))},this.canvas.toBuffer=function(t,e){return n+s(r)}},initLayer:function(){this.setLayer();var t=m.getRectSize(this.canvas);this.rect(0,0,t.width,t.height),this.addVectorElement(!1,!1)},clear:function(){for(var t=this.child,e=t.firstChild;e;)t.removeChild(e),e=t.firstChild;this.vid="",this.elements={},this.layers={},this.target=this.child,this.setLayer(),this._textcache={}},setLayer:function(t,e){var i;e=e||{},this.vid="",t?((i=this.layers[t])||(i=this.layers[t]=g("g"),this.child.appendChild(i)),this.target=i):this.target=this.child,e.rendering&&this.setRendering(e.rendering),this.freezepath=!!e&&e.freeze},setRendering:function(t){this.target.setAttribute("shape-rendering",t)},changeSize:function(t,e){m.env.browser&&(this.canvas.style.width=t+"px",this.canvas.style.height=e+"px");var i=this.child,s=(i.setAttribute("width",t),i.setAttribute("height",e),i.getAttribute("viewBox").split(/ /));i.setAttribute("viewBox",[s[0],s[1],t,e].join(" "))},translate:function(t,e){var i=this.child.getAttribute("viewBox").split(/ /);i[0]=-t,i[1]=-e,this.child.setAttribute("viewBox",i.join(" "))},beginPath:function(){this.cpath=[],this.lastpath=""},closePath:function(){this.cpath.push("z"),this.lastpath="z"},moveTo:function(t,e){this.cpath.push("M",t,e),this.lastpath="M"},lineTo:function(t,e){"L"!==this.lastpath&&this.cpath.push("L"),this.cpath.push(t,e),this.lastpath="L"},rect:function(t,e,i,s){this.cpath.push("M",t,e,"L",t+i,e,t+i,e+s,t,e+s,"z"),this.lastpath="z"},arc:function(t,e,i,s,n,r){var o,a,h,t=p<=n-s?(h=o=t+i,a=e):(o=t+i*Math.cos(s),a=e+i*Math.sin(s),h=t+i*Math.cos(n),e+i*Math.sin(n)),e=(p<=n-s&&(a+=.125),n<s!=Math.abs(n-s)>Math.PI),n=r^e?1:0;this.cpath.push("M",o,a,"A",i,i,0,n,0==n^e?1:0,h,t),this.lastpath="A"},fill:function(){this.addVectorElement(!0,!1)},stroke:function(){this.addVectorElement(!1,!0)},shape:function(){this.addVectorElement(!0,!0)},fillRect:function(t,e,i,s){var n=this.cpath;this.cpath=[],this.rect(t,e,i,s),this.addVectorElement(!0,!1),this.cpath=n},strokeRect:function(t,e,i,s){var n=this.cpath;this.cpath=[],this.rect(t,e,i,s),this.addVectorElement(!1,!0),this.cpath=n},shapeRect:function(t,e,i,s){var n=this.cpath;this.cpath=[],this.rect(t,e,i,s),this.addVectorElement(!0,!0),this.cpath=n},setLinePath:function(){for(var t=arguments,e=t.length,i=e-(1|e?1:2),s=[],n=0;n<i;n+=2)s[n>>1]=[t[n],t[n+1]];this.beginPath(),this.setLinePath_com.call(this,s),t[e-1]&&this.cpath.push("z")},setOffsetLinePath:function(){for(var t=arguments,e=t.length,i=e-(1|e?1:2),s=[],n=0;n<i-2;n+=2)s[n>>1]=[t[n+2]+t[0],t[n+3]+t[1]];this.beginPath(),this.setLinePath_com.call(this,s),t[e-1]&&this.cpath.push("z")},setLinePath_com:function(t){for(var e=0,i=t.length;e<i;e++)this.cpath.push(0===e?"M":"L"),this.cpath.push(t[e][0],t[e][1])},strokeLine:function(t,e,i,s){var n=this.cpath;this.cpath=["M",t,e,"L",i,s],this.addVectorElement(!1,!0),this.cpath=n},strokeDashedLine:function(t,e,i,s,n){var r=this.cpath;this.cpath=["M",t,e,"L",i,s],this.addVectorElement(!1,!0).setAttribute("stroke-dasharray",n.join(" ")),this.cpath=r},strokeCross:function(t,e,i){var s=this.cpath;this.cpath=["M",t-i,e-i,"L",t+i,e+i,"M",t-i,e+i,"L",t+i,e-i],this.addVectorElement(!1,!0),this.cpath=s},fillCircle:function(t,e,i){var s=this.cpath;this.cpath=[],this.arc(t,e,i,0,p,!1),this.cpath.push("z"),this.addVectorElement(!0,!1),this.cpath=s},strokeCircle:function(t,e,i){var s=this.cpath;this.cpath=[],this.arc(t,e,i,0,p,!1),this.cpath.push("z"),this.addVectorElement(!1,!0),this.cpath=s},shapeCircle:function(t,e,i){var s=this.cpath;this.cpath=[],this.arc(t,e,i,0,p,!1),this.cpath.push("z"),this.addVectorElement(!0,!0),this.cpath=s},getDefsElement:function(){var t=this.child.querySelector("defs");return t||(t=b.createElementNS(c,"defs"),this.child.insertBefore(t,this.child.firstChild||null)),t},getImageElement:function(t){for(var e=this.getDefsElement(),i=null,s=e.querySelectorAll("image"),n=0;n<s.length;n++)if(s[n].getAttributeNS(u,"href")===t.src){i=s[n];break}return i||((i=g("image")).setAttribute("id",(i.ownerDocument?this.canvasid+"_":"")+"img"+s.length),i.setAttribute("width",t.width),i.setAttribute("height",t.height),i.setAttributeNS(u,"xlink:href",t.src),e.appendChild(i)),i},getImageSymbol:function(t,e,i,s,n){for(var r=this.getDefsElement(),o=[e,i,s,n].join(" "),a=null,h=r.querySelectorAll("symbol"),l=0;l<h.length;l++)if(h[l].getAttribute("viewBox")===o){a=h[l];break}return a||((a=b.createElementNS(c,"symbol")).setAttribute("id",(a.ownerDocument?this.canvasid+"_":"")+"symimg"+h.length),a.setAttribute("viewBox",o),(e=b.createElementNS(c,"use")).setAttributeNS(u,"xlink:href","#"+this.getImageElement(t).getAttribute("id")),a.appendChild(e),r.appendChild(a)),a},fillText:function(t,e,i,s){var n=this.vid?this.elements[this.vid]:null;t&&this.fillStyle&&"none"!==this.fillStyle?(t=this.fillText_main(n,t,e,i,s||""),!n&&this.vid&&(this.elements[this.vid]=t)):n&&this.hide(n),this.vid=""},fillText_main:function(t,e,i,s,n){var r,o,a=!t,h=this.vid&&this._textcache[this.vid]||{};return a?t=g("text"):this.show(t),t.getAttribute("fill")!==this.fillStyle&&t.setAttribute("fill",this.fillStyle),h.x===i&&h.y===s&&h.ml===n&&h.ta===this.textAlign&&h.tb===this.textBaseline&&h.font===this.font||(r=s-m.getoffsetHeight(e,this.font)*l[this.textBaseline.toLowerCase()],o=f[this.textAlign.toLowerCase()],t.getAttribute("x")!==i&&t.setAttribute("x",i),t.getAttribute("y")!==r&&t.setAttribute("y",r),t.getAttribute("text-anchor")!==o&&t.setAttribute("text-anchor",o),(t.getAttribute("textLength")||"")!==n&&(n?(t.setAttribute("textLength",n),t.setAttribute("lengthAdjust","spacingAndGlyphs")):(t.removeAttribute("textLength"),t.removeAttribute("lengthAdjust"))),h.x=i,h.y=s,h.ml=n,h.ta=this.textAlign,h.tb=this.textBaseline),h.font!==this.font&&(this.font.match(/(.+\s)?([0-9]+)px (.+)$/)?(r=RegExp.$1,o=RegExp.$2,i=RegExp.$3,t.setAttribute("font-size",o),i.match(/^sans\-serif$/i)?t.removeAttribute("font-family"):t.setAttribute("font-family",i),r.match(/(italic|oblique)/)?t.setAttribute("font-style",RegExp.$1):t.removeAttribute("font-style"),r.match(/(bold|bolder|lighter|[1-9]00)/)?t.setAttribute("font-weight",RegExp.$1):t.removeAttribute("font-weight")):t.setAttribute("font",this.font),h.font=this.font),t.textContent!==e&&(t.textContent=e),this.vid&&(this._textcache[this.vid]=h),a&&this.target.appendChild(t),d&&this.enableTextLengthWA&&("center"===h.ta||"right"===h.ta)&&n&&(t.removeAttribute("textLength"),s=t.getBoundingClientRect(),t.setAttribute("x",h.x+(s.width-n)/("center"===h.ta?2:1)),t.setAttribute("textLength",n)),t},drawImage:function(t,e,i,s,n,r,o,a,h){var l=this.vid?this.elements[this.vid]:null;t?(void 0===s&&(s=t.width,n=t.height),void 0===r&&(r=e,o=i,i=e=0,a=s,h=n),t=this.drawImage_main(l,t,e,i,s,n,r,o,a,h),!l&&this.vid&&(this.elements[this.vid]=t)):l&&this.hide(l),this.vid=""},drawImage_main:function(t,e,i,s,n,r,o,a,h,l){var c=!t,e=(c?t=g("use"):this.show(t),this.getImageSymbol(e,i,s,n,r).getAttribute("id"));return t.getAttribute("x")!==o&&t.setAttribute("x",o),t.getAttribute("y")!==a&&t.setAttribute("y",a),t.getAttribute("width")!==h&&t.setAttribute("width",h),t.getAttribute("height")!==l&&t.setAttribute("height",l),t.getAttributeNS(u,"xlink:href")!=="#"+e&&t.setAttributeNS(u,"xlink:href","#"+e),c&&this.target.appendChild(t),t},addVectorElement:function(t,e){t=t&&!!this.fillStyle&&"none"!==this.fillStyle,e=e&&!!this.strokeStyle&&"none"!==this.strokeStyle;var i=this.vid?this.elements[this.vid]:null,s=null;return t||e?(s=this.addVectorElement_main(i,t,e),!i&&this.vid&&(this.elements[this.vid]=s)):i&&this.hide(i),this.vid="",s},addVectorElement_main:function(t,e,i){var s=!t,n=(s?((t=g("path")).setAttribute("fill","none"),t.setAttribute("stroke","none")):this.show(t),this.freezepath&&!s||(n=this.cpath.join(" "),r=i?this.lineWidth:null,t.getAttribute("d")!==n&&t.setAttribute("d",n),t.getAttribute("stroke-width")!==r&&t.setAttribute("stroke-width",r)),e?this.fillStyle:"none"),r=i?this.strokeStyle:"none";return t.getAttribute("fill")!==n&&t.setAttribute("fill",n),t.getAttribute("stroke")!==r&&t.setAttribute("stroke",r),s&&this.target.appendChild(t),t},vhide:function(t){var e=this.elements[this.vid];e&&this.hide(e)},show:function(t){t.removeAttribute("display")},hide:function(t){t.setAttribute("display","none")}})),m.env.browser){if(!(t=b.createElement("canvas")).getContext||t.probablySupportsContext&&!t.probablySupportsContext("2d"))return}else try{m.Canvas=require("canvas")}catch(t){return}m.addWrapper("canvas",{initialize:function(t){var e;this.context=null,this.use=new m.TypeList("canvas"),this.currentLayerId="_empty",this.isedgearray={_empty:!1},this.isedge=!1,n||(e="undefined"!=typeof navigator&&navigator.userAgent||"",n=0,n=e.match(/Chrome/)?-.72:e.match(/AppleWebKit/)?-.7:e.match(/Trident/)?-.74:e.match(/Win/)?-.7:-.76),this.x0=0,this.y0=0,m.wrapperbase.initialize.call(this,t)},setkey:function(t){return this},hidekey:function(t){return this},release:function(t){return this},initElement:function(){var t=this.child=m.env.browser?b.createElement("canvas"):new m.Canvas,e=(m.env.browser&&(this.canvas.style.overflow="hidden"),m.getRectSize(this.canvas));t.width=e.width,t.height=e.height,m.env.browser&&(t.style.width=e.width+"px",t.style.height=e.height+"px",this.canvas.appendChild(t)),this.context=t.getContext("2d")},initFunction:function(){function a(t){return m.env.browser?window.atob(t):new Buffer(RegExp.$2,"base64").toString("binary")}var h=this.child;this.canvas.toDataURL=function(t,e){return h.toDataURL(t||void 0,e)},this.canvas.toBlob=function(t,e,i){if("function"==typeof h.toBlob)h.toBlob(t,e,i);else{h.toDataURL(e||void 0,i).match(/data:(.*);base64,(.*)/);for(var s=a(RegExp.$2),n=s.length,r=new Uint8Array(n),o=0;o<n;o++)r[o]=s.charCodeAt(o);t(new Blob([r.buffer],{type:RegExp.$1}))}},this.canvas.toBuffer=function(t,e){t=h.toDataURL(t||void 0,e).replace(/^data:image\/\w+?;base64,/,"");if(m.env.node)return new Buffer(t,"base64");if("undefined"!=typeof Uint8Array)for(var i=a(t),s=new Uint8Array(i.length),n=0;n<i.length;n++)s[n]=i.charCodeAt(n);else s=a(t);return s}},initLayer:function(){this.setLayer()},clear:function(){var t;this.setProperties(!0,!0),this.context.setTransform(1,0,0,1,0,0),this.context.translate(this.x0,this.y0),m.env.browser&&(t=m.getRectSize(this.canvas),this.context.clearRect(0,0,t.width,t.height))},setLayer:function(t,e){t=this.currentLayerId=t||"_empty";this.isedge=this.isedgearray[void 0!==this.isedgearray[t]?t:"_empty"],this.setEdgeStyle(),(e=e||{}).rendering&&this.setRendering(e.rendering)},setEdgeStyle:function(){var t;m.env.browser&&"imageRendering"in(t=this.canvas.style)&&(t.imageRendering="",this.isedge&&(t.imageRendering="pixelated",t.imageRendering||(t.imageRendering="-webkit-optimize-contrast"),t.imageRendering||(t.imageRendering="-moz-crisp-edges"),t.imageRendering||(t.imageRendering="-o-crisp-edges")))},setRendering:function(t){this.isedge=this.isedgearray[this.currentLayerId]="crispEdges"===t,this.setEdgeStyle()},changeSize:function(t,e){m.env.browser&&((n=this.canvas).style.width=t+"px",n.style.height=e+"px");var i,s,n=this.child;m.env.browser&&(i=parseInt(n.style.left),e+=(s=parseInt(n.style.top))<0?-s:0,n.style.width=(t+=i<0?-i:0)+"px",n.style.height=e+"px"),n.width=t,n.height=e},translate:function(t,e){this.x0=t,this.y0=e,this.context.translate(t,e)},setProperties:function(t,e){t=t&&!!this.fillStyle&&"none"!==this.fillStyle,e=e&&!!this.strokeStyle&&"none"!==this.strokeStyle;var i=this.context;return t&&(i.fillStyle=this.fillStyle),e&&(i.strokeStyle=this.strokeStyle),i.lineWidth=this.lineWidth,i.font=this.font,i.textAlign=this.textAlign,i.textBaseline=this.textBaseline,t||e},beginPath:function(){this.context.beginPath()},closePath:function(){this.context.closePath()},moveTo:function(t,e){this.context.moveTo(t,e)},lineTo:function(t,e){this.context.lineTo(t,e)},rect:function(t,e,i,s){this.context.rect(t,e,i,s)},arc:function(t,e,i,s,n,r){this.context.arc(t,e,i,s,n,r)},fill:function(){this.setProperties(!0,!1)&&this.context.fill()},stroke:function(){this.setProperties(!1,!0)&&this.context.stroke()},shape:function(){var t;this.setProperties(!0,!0)&&(t=this.context,this.fillStyle&&"none"!==this.fillStyle&&t.fill(),this.strokeStyle&&"none"!==this.strokeStyle&&t.stroke())},fillRect:function(t,e,i,s){this.setProperties(!0,!1)&&this.context.fillRect(t,e,i,s)},strokeRect:function(t,e,i,s){this.setProperties(!1,!0)&&this.context.strokeRect(t,e,i,s)},shapeRect:function(t,e,i,s){var n;this.setProperties(!0,!0)&&(n=this.context,this.fillStyle&&"none"!==this.fillStyle&&n.fillRect(t,e,i,s),this.strokeStyle&&"none"!==this.strokeStyle&&n.strokeRect(t,e,i,s))},setLinePath:function(){for(var t=arguments,e=t.length,i=e-(1|e?1:2),s=[],n=0;n<i;n+=2)s[n>>1]=[t[n],t[n+1]];this.context.beginPath(),this.setLinePath_com.call(this,s),t[e-1]&&this.context.closePath()},setOffsetLinePath:function(){for(var t=arguments,e=t.length,i=e-(1|e?1:2)-2,s=[],n=0;n<i;n+=2)s[n>>1]=[t[n+2]+t[0],t[n+3]+t[1]];this.context.beginPath(),this.setLinePath_com.call(this,s),t[e-1]&&this.context.closePath()},setLinePath_com:function(t){for(var e=0,i=t.length;e<i;e++){var s=t[e];0===e?this.context.moveTo(s[0],s[1]):this.context.lineTo(s[0],s[1])}},strokeLine:function(t,e,i,s){var n;this.setProperties(!1,!0)&&((n=this.context).beginPath(),n.moveTo(t,e),n.lineTo(i,s),n.stroke())},strokeDashedLine:function(t,e,i,s,n){this.strokeDashedLine=this.context.setLineDash?function(t,e,i,s,n){var r=this.context;this.setProperties(!1,!0)&&(r.beginPath(),r.moveTo(t,e),r.lineTo(i,s),r.setLineDash(n),r.stroke(),r.setLineDash([]))}:function(t,e,i,s,n){n.length%2==1&&(n=n.concat(n));var r=Math.sqrt((i-t)*(i-t)+(s-e)*(s-e)),o=0,a=0,h=null,l=null;if(t!==i&&(l=(h=(s-e)/(i-t))*h+1),this.setProperties(!1,!0)){var c,u,d=this.context;for(d.beginPath(),d.moveTo(t,e);o<r;)u=null!==h?(c=t+(u=Math.sqrt(o*o/l)),e+h*u):(c=t,e+o),0==(1&a)?d.moveTo(c,u):d.lineTo(c,u),o+=n[a],++a>=n.length&&(a=0);d.stroke()}},this.strokeDashedLine(t,e,i,s,n)},strokeCross:function(t,e,i){var s;this.setProperties(!1,!0)&&((s=this.context).beginPath(),s.moveTo(t-i,e-i),s.lineTo(t+i,e+i),s.moveTo(t-i,e+i),s.lineTo(t+i,e-i),s.stroke())},fillCircle:function(t,e,i){var s;this.setProperties(!0,!1)&&((s=this.context).beginPath(),s.arc(t,e,i,0,p,!1),s.fill())},strokeCircle:function(t,e,i){var s;this.setProperties(!1,!0)&&((s=this.context).beginPath(),s.arc(t,e,i,0,p,!1),s.stroke())},shapeCircle:function(t,e,i){var s;this.setProperties(!0,!0)&&((s=this.context).beginPath(),s.arc(t,e,i,0,p,!1),this.fillStyle&&"none"!==this.fillStyle&&s.fill(),this.strokeStyle&&"none"!==this.strokeStyle&&s.stroke())},fillText:function(t,e,i,s){t&&this.setProperties(!0,!1)&&("candle-top"===this.textBaseline&&(i-=m.getoffsetHeight(t,this.font)*n,this.context.textBaseline="alphabetic"),s?this.context.fillText(t,e,i,s):this.context.fillText(t,e,i))},drawImage:function(){arguments[0]&&this.context.drawImage.apply(this.context,arguments)}})}(t,t.exports),p.Candle=t.exports}(),document=this.document||p.Candle.document,this.DOMParser||p.Candle.DOMParser),g=this.XMLSerializer||p.Candle.XMLSerializer;function v(t){if(navigator&&"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(function(t){t.forEach(function(t){t.unregister()}),0<t.length&&location&&setTimeout(function(){location.reload()},500)}),s){s=!1;for(var e=0;e<n.length;e++)n[e]();n=[]}}function y(t){r&&r.key&&r.key.e_keydown(t)}function x(t){r&&r.key&&r.key.e_keyup(t)}p.failcodes={en:{complete:"Complete!",bkDupNum:"There are equal numbers in a block.",nmDupRow:"There are equal numbers in a row or column.",ceNoNum:"There is an empty cell.",nmSightNe:"The number of visible buildings is wrong.",nmXYNe:"そのマスから見てX番目にYか、Y番目にXがありません。",nmFrameSumNe:"そのマスから見て太線までの数字の和が正しくありません。"},ja:{complete:"正解です！",bkDupNum:"同じブロックに同じ数字が入っています。",nmDupRow:"同じ列に同じ数字が入っています。",ceNoNum:"数字の入っていないマスがあります。",nmSubNe1:"隣り合う数字の差が1になっています。",nmSightNe:"見えるビルの数が正しくありません。",nmXYNe:"そのマスから見てX番目にYか、Y番目にXがありません。",nmFrameSumNe:"そのマスから見て太線までの数字の和が正しくありません。"}},p.env=(t=p.Candle.env.browser,b=t?navigator.userAgent:"",i=-1<b.indexOf("like Mac OS X"),e=-1<b.indexOf("Android"),i={iOS:i,Android:e,mobile:i||e},e=b.match(/Firefox\/(\w+(\.\w+)?)/)?(e=RegExp.$1,b.match(/rv\:(\d+(\.\d+)?)/)&&RegExp.$1+0<=2.1?RegExp.$1+0:e):null,b=null===(l=b.match(/Safari\/([\w\.]+)/)&&b.match(/Chrome\/(\w+(\.\w+)?)/)?RegExp.$1:null)&&b.match(/Safari\/([\w\.]+)/)&&b.match(/Version\/(\w+(\.\w+)?)/)?RegExp.$1:null,{bz:{AndroidBrowser:i.Android&&b,Presto:"object"==typeof window&&!!window.opera},OS:i,API:{touchevent:t&&(!!window.ontouchstart||!!document.createTouch),pointerevent:t&&!!window.PointerEvent,mspointerevent:t&&!!window.MSPointerEvent,lowaccuracy:t&&window.matchMedia&&!!window.matchMedia("(pointer: coarse)").matches,maxWidth:t&&18<=(l||1e3)&&6<=(b||1e3),svgTextLength:!t||25<=(e||1e3),anchor_download:t&&void 0!==document.createElement("a").download},browser:t,node:p.Candle.env.node}),p.lang=(i=p.env.node?process.env.LANG:navigator.browserLanguage||navigator.language||navigator.userLanguage)&&"ja"!==i.substr(0,2)?"en":"ja",s=!0,n=[],p.on=function(t,e){"load"===t&&(s?n.push(e):e())},p.env.browser&&("complete"===document.readyState?setTimeout(v,10):(document.addEventListener("DOMContentLoaded",v,!1),window.addEventListener("load",v,!1))),r=null,p.on("load",function(){p.util.addEvent(document,"keydown",p,y),p.util.addEvent(document,"keyup",p,x)}),p.connectKeyEvents=function(t){r=t},p.common={},p.custom={"":{}},p.classmgr={makeCommon:function(t){this.createCommon(t)},createCommon:function(t){for(var e in t){var i=this.searchName(e),s=p.common[i.real];s||((s=this.createClass(p.common[i.base])).prototype.common=s.prototype,s.prototype.pid=""),this.extendPrototype(s.prototype,t[e]),p.common[i.real]=p.custom[""][i.real]=s}},makeCustom:function(t,e){for(var i=0;i<t.length;i++){var s=t[i];p.custom[s]=this.createCustom(s,e,t[0])}},getExtension:function(t,e){var i,s={};for(i in e){var n,r,o=e[i],a=i,h=!1;if((a=i.match("#")?i.substr(0,i.indexOf("#")):i).match("@")){n=a.substr(a.indexOf("@")+1).split(/,/),a=a.substr(0,a.indexOf("@"));for(var l=0;l<n.length;l++)if(n[l]===t){h=!0;break}if(!h)continue}for(r in s[a]||(s[a]={}),o)s[a][r]=o[r]}return s},createCustom:function(t,e,i){var s,n,r={},o=this.getExtension(t,e);for(s in o){var a=this.searchName(s),h=r[a.real];h||((h=this.createClass(r[a.base]||p.common[a.base])).prototype.pid=t,h.prototype.pidbase=i),this.extendPrototype(h.prototype,o[s]),r[a.real]=h}for(n in p.common)r[n]||(r[n]=this.createClass(p.common[n]),r[n].prototype.pid=t,r[n].prototype.pidbase=i);return r},searchName:function(t){var e=(t=t.replace(/\s+/g,"")).indexOf(":"),i="",s=t;return 0<=e&&(i=t.substr(e+1),s=t.substr(0,e)),{base:i||s,real:s}},createClass:function(t){function e(){}return t&&this.extendPrototype(e.prototype,t.prototype),e},extendPrototype:function(t,e){for(var i in e=e||{})null!==e[i]&&"object"==typeof e[i]&&e[i].constructor===Object?(t[i]||(t[i]={}),this.extendPrototype(t[i],e[i])):t[i]=e[i]},includeCustomFile:function(t){var e,t=p.variety(t).script;this.includedFile[t]||(this.includedFile[t]=!0,t=p.util.getpath()+"./pzpr-variety/"+t+".js",p.env.browser&&!p.env.node?((e=document.createElement("script")).type="text/javascript",e.src=t+"?"+p.version,document.getElementsByTagName("head")[0].appendChild(e)):(e=require(t),this.makeCustom(e[0],e[1])))},includedFile:{},setPuzzleClass:function(t,e,i){if(!p.variety(e).valid)throw t.emit("fail-open"),Error("Invalid Puzzle Variety Selected");if(t.pid!==e){if(!p.custom[e]&&(this.includeCustomFile(e),!p.custom[e]))return void setTimeout(function(){p.classmgr.setPuzzleClass(t,e,i)},10);this.setClasses(t,e)}i()},setClasses:function(t,e){t.klass={};var i,s=p.custom[e];for(i in s){var n,r=t.klass[i]=function(){var t=Array.prototype.slice.apply(arguments);this.initialize&&this.initialize.apply(this,t)},o=s[i].prototype;for(n in o)r.prototype[n]=o[n]}this.setPrototypeRef(t,"puzzle",t),this.setPrototypeRef(t,"klass",t.klass),t.pid=e,t.info=p.variety(e)},setPrototypeRef:function(t,e,i){for(var s in t.klass)t.klass[s].prototype[e]=i}};var k={},w=[];function C(t){if(k[t])return t;for(var e in k)if(k[e].alias)for(var i in k[e].alias)if(k[e].alias[i]===t)return e;return""}function q(t,e){this.valid=!0,this.pid=t,this.script=e[4]||t,this.ja=e[2],this.en=e[3],this.exists={pzprapp:!!e[0],kanpen:!!e[1],pencilbox:!!e[1]},this.exists.pencilbox=this.exists.pencilbox&&"nanro"!==t&&"ayeheya"!==t&&"kurochute"!==t,this.alias=e[5]||{},this.urlid=this.alias.pzprurl||t,this.kanpenid=e[1]?this.alias.kanpen||t:"",w.push(t)}var z,L=p.variety=p.genre=function(t){return k[C(t)]||{valid:!1}},_=(L.extend=function(t){for(var e in t)this[e]=t[e]},L.extend({info:k,toPID:C,exists:function(t){return L(t).valid},each:function(t){for(var e in k)t(e)},getList:function(){return w.slice()}}),delete L.extend,{sudoku:[0,0,"数独","Sudoku"],nonconsecutivesudoku:[0,0,"NonConsecutive Sudoku","NonConsecutive Sudoku"],skyscraperssudoku:[0,0,"Skyscrapers Sudoku","Skyscrapers Sudoku"],descriptivepairssudoku:[0,0,"Descriptive Pairs Sudoku","Descriptive Pairs Sudoku"],framesudoku:[0,0,"Frame Sudoku","Frame Sudoku"],xsumssudoku:[0,0,"X-Sums Sudoku","X-Sums Sudoku"]});for(z in _){k[z]=new q(z,_[z]);try{Object.freeze(k[z]),Object.freeze(k[z].exists),Object.freeze(k[z].alias)}catch(t){}}function N(t){var e=t.klass;t.board=new e.Board,p.classmgr.setPrototypeRef(t,"board",t.board),t.checker=new e.AnsCheck,t.painter=new e.Graphic,t.cursor=new e.TargetCursor,t.mouse=new e.MouseEvent,t.key=new e.KeyEvent,t.opemgr=new e.OperationManager,t.faillist=new e.FailCode}function A(t){if(!p.Candle.enable[t])return null;var e=document.createElement("div");return p.Candle.start(e,t),e}function S(t){var i,e=t.painter,s=t.preInitCanvasInfo;function n(t,e){p.util.addEvent(i.canvas,t,i,e)}t.preInitCanvasInfo&&("viewer"!==t.instancetype?(i=t,n("mousedown",P),n("mousemove",O),n("mouseup",j),n("mousecancel",D),i.canvas.oncontextmenu=function(){return!1},i.canvas.style.touchAction="pinch-zoom",n("keydown",T),n("keyup",I),n("click",function(t){t.stopPropagation(),t.preventDefault()})):e.outputImage=!0,e.canvasWidth&&e.canvasHeight||(s.width&&s.height?e.resizeCanvas(s.width,s.height):s.cellsize&&e.resizeCanvasByCellSize(s.cellsize,!0)),delete t.preInitCanvasInfo),e.initCanvas()}function P(t){this.mouse&&this.mouse.e_mousedown(t)}function O(t){this.mouse&&this.mouse.e_mousemove(t)}function j(t){this.mouse&&this.mouse.e_mouseup(t)}function D(t){this.mouse&&this.mouse.e_mousecancel(t)}function T(t){this.key&&this.key.e_keydown(t)}function I(t){this.key&&this.key.e_keyup(t)}function R(t,e){var i=A(e.type),s=new t.klass.Graphic;return s.context=i.getContext("2d"),s.context.enableTextLengthWA=!1,s.outputImage=!0,"bgcolor"in e&&(s.bgcolor=e.bgcolor),"kramma"!==t.pid&&"swslither"!==t.pid||(s.imgtile=t.painter.imgtile),"bank"in e&&(s.showBank=e.bank),s.resizeCanvasByCellSize(e.cellsize),s.unsuspend(),i}function B(){for(var t={},e=p.Candle.current,i=null,s=null,n=null,r=null,o=0;o<arguments.length;o++){var a=arguments[o];switch(typeof a){case"string":e=a;break;case"number":1.01<a?i=a:n=a;break;case"object":"cellsize"in a&&(i=a.cellsize),"bgcolor"in a&&(s=a.bgcolor),"bank"in a&&(r=a.bank)}}return t.type=(e||p.Candle.current).match(/svg/)?"svg":"canvas",t.mimetype="svg"!==t.type?"image/"+e:"image/svg+xml",null!=n&&(t.quality=n),null!==i&&(t.cellsize=i),null!==s&&(t.bgcolor=s),null!==r&&(t.bank=r),t}function E(){throw Error("no implementation")}(h=p.parser=function(t,e){return h.parse(t,e)}).extend=function(t){for(var e in t)this[e]=t[e]},h.extend({URL_AUTO:0,URL_PZPRV3:1,URL_PZPRAPP:2,URL_KANPEN:3,URL_KANPENP:4,URL_HEYAAPP:5,URL_PZPRFILE:6,FILE_AUTO:0,FILE_PZPR:1,FILE_PBOX:2,FILE_PBOX_XML:3,parse:function(t,e){return t instanceof o||t instanceof a?t:this.parseFile(t,e)||this.parseURL(t)},parseURL:function(t){return t instanceof o?t:(t=t.replace(/(\r|\n)/g,""),new o(t).parse())},parseFile:function(t,e){return t instanceof a?t:(t.match(/^\<\?xml/)||(t=t.replace(/[\t\r]*\n/g,"\n").replace(/\//g,"\n")),new a(t,e).parse())}}),delete h.extend,o=p.parser.URLData=function(t,e){this.url=t,void 0!==e&&(this.mode=e)},p.parser.URLData.prototype={pid:"",mode:"",type:0,url:"",qdata:"",pflag:null,variant:null,cols:0,rows:0,body:"",isurl:!0,isfile:!1,URL_AUTO:0,URL_PZPRV3:1,URL_PZPRAPP:2,URL_KANPEN:3,URL_KANPENP:4,URL_HEYAAPP:5,URL_PZPRFILE:6,parse:function(){return this.parseURLType(),this.parseURLData(),this.changeProperPid(),this},generate:function(){return this.outputURLType()+this.outputURLData()},parseURLType:function(){var t=this.url;if(delete this.url,t.match(/www\.kanpen\.net/)||t.match(/www\.geocities(\.co)?\.jp\/pencil_applet/))t.match(/([0-9a-z]+)\.html/),this.pid=RegExp.$1,0<=t.indexOf("?heyawake=")?(this.qdata=t.substr(t.indexOf("?heyawake=")+10),this.type=5):0<=t.indexOf("?pzpr=")?(this.qdata=t.substr(t.indexOf("?pzpr=")+6),this.type=4):(this.qdata=t.substr(t.indexOf("?problem=")+9),this.type=3);else if(t.match(/www\.geocities(\.co)?\.jp\/heyawake/))this.pid="heyawake",this.qdata=t.substr(t.indexOf("?problem=")+9),this.type=5;else if(t.match(/indi\.s58\.xrea\.com\/(.+)\/(sa|sc)\//))this.pid=RegExp.$1,this.qdata=t.substr(t.indexOf("?")),this.type=2;else{var e,i,s=t.indexOf("?"),n=t.indexOf("/",s),r="";if(-1<n)for(r=t.substring(s+1,n);r.match(/^(\w+)\=(\w+)\&/);)"type"===RegExp.$1&&(this.mode=RegExp.$2),s=t.indexOf("&",s+1),r=t.substring(s+1,n);else r=t.substring(s+1);r.startsWith("v:")&&(e=s+r.length+2,i=t.indexOf("/",e),r=t.substring(e,i)),r.match(/^pzprv[0-9.]*$/)?(-1<s&&s<n&&(t=t.substring(s+1)),e=(t=decodeURIComponent(t)).split("/",4),this.pid=e[0].startsWith("v:")?e[2]:e[1],this.qdata=t,this.type=6):(-1<n&&(this.qdata=t.substr(n+1)),(i=r).match(/_edit$/)?this.mode="editor":i.match(/_play$/)&&(this.mode="player"),this.pid=i.replace(/(_edit|_play)$/,""),this.type=1)}this.pid=p.variety.toPID(this.pid)},outputURLType:function(){var t="",t=p.env.node?"http://pzv.jp/p.html":location.protocol+"//"+location.host+location.pathname;switch(this.type){case 1:t+="?%PID%/";break;case 3:t="http://www.kanpen.net/%KID%.html?problem=";break;case 4:t="http://www.kanpen.net/%KID%.html?pzpr=";break;case 5:t="http://www.geocities.co.jp/heyawake/?problem=";break;case 6:t+="?"}var e=this.pid,i="";switch(this.mode){case"player":e+="_play",i="type=player&";break;case"editor":e+="_edit",i="type=editor&"}return 6===this.type&&(t+=i),t.replace("%PID%",p.variety(e).urlid).replace("%KID%",p.variety(this.pid).kanpenid)},parseURLData:function(){if(6===this.type)return e=this.qdata.split("/"),this.cols=+e[2],this.rows=+e[3],this.body=this.qdata.replace(/\//g,"\n"),void delete this.qdata;var t,e=this.qdata.split("/"),i=0,s=0;delete this.qdata,3!==this.type&&5!==this.type&&(e[0]&&e[0].match(/^v:(.*)/)&&(this.variant=RegExp.$1,e.shift()),e[0]&&isNaN(e[0])?(this.pflag=e[0],e.shift()):this.pflag=""),s=3===this.type?i=+e.shift():5===this.type?(i=+(t=e.shift().split("x"))[0],+t[1]):(i=+e.shift()||NaN,+e.shift()||NaN),this.rows=s,this.cols=i,e[e.length-1]||e.pop(),this.body=e.join("/")},outputURLData:function(){var t=this,e=t.cols,i=t.rows,s=[],e=(3!==t.type&&5!==t.type&&(null!==t.variant&&s.push("v:"+t.variant),4!==t.type&&!t.pflag||s.push(t.pflag)),3===t.type?s.push(e):5===t.type?s.push([e,i].join("x")):6!==t.type&&(s.push(e),s.push(i)),s.push(t.body),s.join("/"));return e.charAt(e.length-1).match(/[a-zA-Z0-9]/)||(e+="/"),e},changeProperPid:function(){if(this.body&&(1===this.type||2===this.type))switch(this.pid){case"ichimaga":0<=this.pflag.indexOf("m")?this.pid="ichimagam":0<=this.pflag.indexOf("x")?this.pid="ichimagax":this.pid="ichimaga";break;case"icelom":this.pflag.indexOf("a")<0&&(this.pid="icelom2");break;case"pipelink":this.body.match(/[0-9]/)&&(this.pid="pipelinkr");break;case"bonsan":var t,e;this.pflag.indexOf("c")<0&&(t=this.cols,e=this.rows,this.body.substr(0,(((t-1)*e+4)/5|0)+((t*(e-1)+4)/5|0)||0).match(/[^0]/)&&(this.pid="heyabon"));break;case"kramma":if(this.pflag.indexOf("c")<0)for(var i=(this.cols-1)*(this.rows-1),s=0,n=0;n<this.body.length;n++){var r=this.body.charAt(n);if(r.match(/\w/)){if((s+=parseInt(r,36))<i){this.pid="kramman";break}}else"."===r&&(s+=36);if(i<=s)break}}}},a=p.parser.FileData=function(t,e){this.pid=e||"",this.fstr=t,this.metadata=new p.MetaData},p.parser.FileData.prototype={pid:"",type:0,variant:null,filever:0,fstr:"",qdata:"",cols:0,rows:0,body:"",history:"",metadata:null,xmldoc:null,isurl:!1,isfile:!0,FILE_AUTO:0,FILE_PZPR:1,FILE_PBOX:2,FILE_PBOX_XML:3,parse:function(){var t=this.parseFileType()&&this.parseFileData();return t&&this.changeProperPid(),t?this:null},generate:function(){return this.outputFileType()+this.outputFileData()},parseFileType:function(){var t=this.fstr.split("\n"),e=t.shift();return delete this.fstr,e.match(/^v:(.*)/)&&(this.variant=RegExp.$1,e=t.shift()),e.match(/^pzprv3/)?(this.type=1,e.match(/pzprv3\.(\d+)/)&&(this.filever=+RegExp.$1),this.pid=t.shift(),this.qdata=t.join("\n")):e.match(/^\<\?xml/)?(this.type=3,t.unshift(e),this.qdata=t.join("\n"),m?(this.body=(new m).parseFromString(this.qdata,"text/xml"),this.pid=this.body.querySelector("puzzle").getAttribute("type")):this.pid=""):e.match(/^\d+$/)?(this.type=2,t.unshift(e),this.qdata=t.join("\n")):this.pid="",this.pid=p.variety.toPID(this.pid),!!this.pid},outputFileType:function(){return 1===this.type?[0===this.filever?"pzprv3":"pzprv3."+this.filever,this.pid,""].join("\n"):(3===this.type&&this.body.querySelector("puzzle").setAttribute("type",p.variety(this.pid).kanpenid),"")},parseFileData:function(){var t,e=this.qdata.split("\n");if(delete this.qdata,i=+e.shift(),i<=0||i<=0)return!1;if(this.rows=i,this.cols=i,1===this.type){for(var i,s=null,n="",r=[],o=!1,a=0;a<e.length&&!e[a].match(/^http\:\/\//);a++){if(e[a].match(/info:\{/)){s=a,o=!0;break}if(e[a].match(/history:\{|__HISTORY__/)){s=a;break}r.push(e[a])}if(this.body+=r.join("\n"),null!==s&&JSON)for(var h,l=0,a=s;a<e.length&&(n+=e[a],h=l,l=(l+=(e[a].match(/\{/g)||[]).length)-(e[a].match(/\}/g)||[]).length,!(0<h&&0===l));a++);JSON&&(o&&"info:"===n.substr(0,5)?(i=JSON.parse(n.substr(5)),this.metadata.update(i.metadata),this.history=i.history||""):"history:"===n.substr(0,8)&&(this.history=JSON.parse(n.substr(8))))}else 2===this.type?this.body=e.join("\n"):3===this.type&&this.body&&(i=this.body.querySelector("property"),(t=this.metadata).author=i.querySelector("author").getAttribute("value"),t.source=i.querySelector("source").getAttribute("value"),t.hard=i.querySelector("difficulty").getAttribute("value"),i=i.querySelector("comment"),t.comment=i?i.childNodes[0].data:"");return!0},outputFileData:function(){var t,e,i,s=this,n=s.cols,r=[],o=3===this.type?this.body.querySelector("puzzle"):null;return r.push(n),3!==s.type&&r.push(s.body),1===s.type&&JSON?s.metadata.empty()?s.history&&r.push("history:"+JSON.stringify(s.history,null,1)):(n={metadata:s.metadata.getvaliddata()},s.history&&(n.history=s.history),r.push("info:"+JSON.stringify(n,null,1))):3===s.type&&((n=o.querySelector("property"))&&o.removeChild(n),n=this.createXMLNode("property"),t=s.metadata,n.appendChild(this.createXMLNode("author",{value:t.author})),n.appendChild(this.createXMLNode("source",{value:t.source})),n.appendChild(this.createXMLNode("difficulty",{value:t.hard})),t.comment&&((e=this.createXMLNode("comment")).appendChild(this.body.createTextNode(t.comment)),n.appendChild(e)),o.appendChild(n),o.appendChild(o.querySelector("board")),o.appendChild(o.querySelector("answer"))),3!==s.type?i=r.join("\n"):(i=(new g).serializeToString(this.body)).match(/^\<\?xml/)||(i='<?xml version="1.0" encoding="UTF-8"?>\n'+i),i},createXMLNode:function(t,e){var i=this.body.createElement(t);if(e)for(var s in e)i.setAttribute(s,e[s]);return i},changeProperPid:function(){if(1===this.type)switch(this.pid){case"ichimaga":var t=this.body.split("\n")[0];"mag"===t?this.pid="ichimagam":"cross"===t&&(this.pid="ichimagax");break;case"icelom":"skipwhite"===this.body.split("\n")[2]&&(this.pid="icelom2");break;case"pipelink":var e=this.body.split("\n"),i=1,s=this.rows;e.slice(i,i+s).join("").match(/o/)&&(this.pid="pipelinkr");break;case"bonsan":e=this.body.split("\n"),i=2*this.rows,s=2*this.rows-1;e.slice(i,i+s).join("").match(/1/)&&(this.pid="heyabon");break;case"kramma":e=this.body.split("\n"),i=this.rows,s=this.rows+1;e.slice(i,i+s).join("").match(/1/)&&(this.pid="kramman")}}},p.MetaData=function(){},p.MetaData.prototype={author:"",source:"",hard:"",comment:"",items:{author:"",source:"",hard:"",comment:""},update:function(t){if(t)for(var e in this.items)"string"==typeof t[e]&&(this[e]=t[e])},getvaliddata:function(){var t,e={};for(t in this.items)this[t]&&(e[t]=this[t]);return e},reset:function(){for(var t in this.items)this[t]=""},empty:function(){for(var t in this.items)if(this[t])return!1;return!0}},l=p.env.API,c=["mousedown"],u=["mousemove"],d=["mouseup"],f=[""],p.env.bz.AndroidBrowser&&(c=[""],u=[""],d=[""]),l.pointerevent?(c=["pointerdown"],u=["pointermove"],d=["pointerup"],f=["pointercancel"]):l.mspointerevent?(c=["MSPointerDown"],u=["MSPointerMove"],d=["MSPointerUp"],f=["MSPointerCancel"]):l.touchevent&&(c.push("touchstart"),u.push("touchmove"),d.push("touchend"),f.push("touchcancel")),p.util={getpath:function(){if(!p.env.browser)return require("path").dirname(__filename)+"/"+(__filename.match("pzpr.js")?"":"../");for(var t=document.getElementsByTagName("script"),e=0;e<t.length;e++){var i=t[e].src.match(/^(.*\/)pzpr\.js(?:\?.*)?$/);if(i)return i[1]+(i[1].match(/\/$/)?"":"/")}return""},currentTime:function(){return(new Date).getTime()},unselectable:function(t){return t.style.MozUserSelect="none",t.style.KhtmlUserSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.userSelect="none",t.unselectable="on",this},addEvent:function(e,t,i,s,n){var r=[t];function o(t){s.call(i,t)}return"mousedown"===t?r=c:"mousemove"===t?r=u:"mouseup"===t?r=d:"mousecancel"===t&&(r=f),r.forEach(function(t){e.addEventListener(t,o,!!n)}),function(){r.forEach(function(t){e.removeEventListener(t,o,!!n)})}},getMouseButton:function(t){return void 0!==t.touches?1===t.touches.length?"left":"":t.pointerType&&"mouse"!==t.pointerType?t.isPrimary?"left":"":["left","middle","right"][void 0!==t.button?t.button:t.which-1]||""},getPagePos:function(t){return{px:this.pageX(t),py:this.pageY(t)}},pageX:function(t){if(void 0!==t.touches&&0<t.touches.length){var e=t.touches.length,i=0;if(0<e){for(var s=0;s<e;s++)i+=t.touches[s].pageX;return i/e}}return t.pageX||0},pageY:function(t){if(void 0!==t.touches&&0<t.touches.length){var e=t.touches.length,i=0;if(0<e){for(var s=0;s<e;s++)i+=t.touches[s].pageY;return i/e}}return t.pageY||0},getRect:function(t){if(!p.env.browser)return{top:0,bottom:0,left:0,right:0,height:0,width:0};var e,t=t.getBoundingClientRect(),i=(e=void 0!==window.scrollX?(n=window.scrollX,window.scrollY):(n=(e=document.documentElement).scrollLeft,e.scrollTop),t.left+n),s=t.top+e,n=t.right+n,t=t.bottom+e;return{top:s,bottom:t,left:i,right:n,height:t-s,width:n-i}},checkpid:function(t,e){var i=t.match(/!?[a-z0-9-]+/g),s=!0;if(i)for(var s=!1,n=0;n<i.length;n++)"!"!==i[n].charAt(0)?i[n]===e&&(s=!0):s=i[n].substr(1)!==e;return s},sameArray:function(t,e){if(t.length!==e.length)return!1;for(var i=0;i<e.length;i++)if(t[i]!==e[i])return!1;return!0}},p.Puzzle=function(t,e){this.pzpr=p,void 0!==e||t&&t.parentNode||(e=t,t=void 0),this.instancetype=(e=e||{}).type||"editor";var i={player:1,viewer:2}[this.instancetype||0]||0;this.playeronly=!!i,this.editmode=!this.playeronly,this.playmode=!this.editmode,this.resetTime(),this.preInitCanvasInfo={type:e.graphic||"",width:e.width||null,height:e.height||null,cellsize:e.cellsize||null},this.listeners={},this.metadata=new p.MetaData,this.config=new this.Config(this),void 0!==e.config&&this.config.setAll(e.config),void 0!==e.mode&&this.setMode(e.mode),void 0!==e.variant&&this.config.set("variant",!0),t&&this.setCanvas(t),p.classmgr.setClasses(this,""),N(this)},p.Puzzle.prototype={pid:null,info:{},klass:null,ready:!1,editmode:!1,playmode:!1,playeronly:!1,instancetype:"",starttime:0,pausetime:null,canvas:null,subcanvas:null,listeners:null,config:null,metadata:null,MODE_EDITOR:1,MODE_PLAYER:3,open:function(t,e,i){var s=this,n=i,i=("string"==typeof e||n||(n=e,e=void 0),s.ready=!1,s.klass),r=i&&i.Board?i.Board:null,o=p.parser(t,e||s.pid);return p.classmgr.setPuzzleClass(s,o.pid,function(){r!==s.klass.Board?N(s):s.painter.suspendAll();try{s.metadata.reset(),o.isurl?(new s.klass.Encode).decodeURL(o):o.isfile&&(new s.klass.FileIO).filedecode(o),s.ready=!0,s.emit("ready"),s.emit("mode"),s.canvas&&S(s),s.resetTime(),n&&n(s)}catch(t){throw s.emit("fail-open"),t}}),this},on:function(t,e){this.addListener(t,e,!1)},once:function(t,e){this.addListener(t,e,!0)},addListener:function(t,e,i){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push({func:e,once:!!i})},emit:function(){var t=Array.prototype.slice.apply(arguments),e=t.shift(),i=this.listeners[e];if(i){t.unshift(this);for(var s=0;s<i.length;s++){var n=i[s];i[s].once&&(i.splice(s,1),s--),n.func.apply(this,t)}}},setCanvas:function(t,e){var i,s,n,r;t&&(i=p.util.getRect(t),(s=document.createElement("div")).style.width=i.width+"px",s.style.height=i.height+"px",t.appendChild(s),this.canvas=s,n=this,"canvas"===(r=e||this.preInitCanvasInfo.type)&&p.Candle.enable.canvas&&!CanvasRenderingContext2D.prototype.fillText&&(r="svg"),p.Candle.start(n.canvas,r,function(t){p.util.unselectable(t.canvas),t.child.style.pointerEvents="none",t.use.canvas&&!n.subcanvas&&(t=n.subcanvas=A("canvas"),document.body&&(t.id="_"+(new Date).getTime()+r,t.style.position="absolute",t.style.left="-10000px",t.style.top="0px",document.body.appendChild(t))),n.ready&&S(n)}))},setCanvasSize:function(t,e){this.preInitCanvasInfo?(this.preInitCanvasInfo.width=t,this.preInitCanvasInfo.height=e):this.painter.resizeCanvas(t,e)},setCanvasSizeByCellSize:function(t,e){this.preInitCanvasInfo?this.preInitCanvasInfo.cellsize=t*(e?1:this.painter.cellexpandratio):this.painter.resizeCanvasByCellSize(t,e)},redraw:function(t){t?this.painter.resizeCanvas():this.painter.paintAll()},irowake:function(){this.board.irowakeRemake(),(this.execConfig("irowake")||this.execConfig("irowakeblk"))&&this.redraw()},toDataURL:function(t,e,i){t=B(t,e,i),e=R(this,t),i=e.toDataURL(t.mimetype,t.quality);return e.parentNode&&e.parentNode.removeChild(e),i},toBlob:function(e,t,i,s){var t=B(t,i,s),n=R(this,t);n.toBlob(function(t){e(t),n.parentNode&&n.parentNode.removeChild(n)},t.mimetype,t.quality)},toBuffer:function(t,e,i){t=B(t,e,i),e=R(this,t),i=e.toBuffer(t.mimetype,t.quality);return e.parentNode&&e.parentNode.removeChild(e),i},getURL:function(t,e){return(new this.klass.Encode).encodeURL(t,e)},getFileData:function(t,e){return(new this.klass.FileIO).fileencode(t,e)},resetTime:function(){this.starttime=p.util.currentTime()},getTime:function(){return null===this.pausetime?p.util.currentTime()-this.starttime:this.pausetime-this.starttime},togglePause:function(){null===this.pausetime?(document.body.classList.add("paused"),this.pausetime=p.util.currentTime()):(document.body.classList.remove("paused"),this.starttime+=p.util.currentTime()-this.pausetime,this.pausetime=null)},undo:function(){return this.opemgr.undo()},redo:function(){return this.opemgr.redo()},undoall:function(){for(;this.opemgr.undo(););},redoall:function(){for(;this.opemgr.redo(););},ismodified:function(){return this.opemgr.isModified()},saved:function(){return this.opemgr.resetModifiedState()},enterTrial:function(){this.opemgr.enterTrial()},acceptTrial:function(){this.opemgr.acceptTrial()},rejectTrial:function(){this.opemgr.rejectTrial(!0)},rejectCurrentTrial:function(){this.opemgr.rejectTrial(!1)},check:function(t){return t&&(this.key.keyreset(),this.mouse.mousereset()),this.checker.check(t)},ansclear:function(){this.board.ansclear(),this.board.rebuildInfo(),this.redraw()},subclear:function(){this.board.subclear(),this.redraw()},errclear:function(){var t=this.board.errclear();return t&&this.redraw(!0),t},clear:function(){this.playeronly?(this.ansclear(),this.opemgr.allerase()):(this.board.initBoardSize(),this.redraw())},setMode:function(t){this.playeronly||"string"==typeof t&&void 0===(t={edit:1,play:3}[t.substr(0,4)])||(this.editmode=t===this.MODE_EDITOR,this.playmode=!this.editmode,this.klass&&(this.cursor.adjust_modechange(),this.key.keyreset(),this.mouse.modechange(),this.board.errclear(),this.redraw()),this.emit("config","mode",t),this.emit("mode"))},getConfig:function(t){return this.config.get(t)},setConfig:function(t,e){return this.config.set(t,e)},resetConfig:function(t){return this.config.reset(t)},validConfig:function(t){return this.config.getexec(t)},execConfig:function(t){return this.config.get(t)&&this.config.getexec(t)},getCurrentConfig:function(){return this.config.getList()},saveConfig:function(){return this.config.getAll()},restoreConfig:function(t){this.config.setAll(t)}},(p.Puzzle.prototype.Config=function(t){this.puzzle=t,this.init()}).prototype={list:null,init:function(){this.list={};var t=p.env.API.lowaccuracy||p.env.API.touchevent;this.add("font",1,{option:[1,2]}),this.add("cursor",!0),this.add("trialmarker",!0),this.add("timer",!0),this.add("irowake",!1,{variety:!0}),this.add("irowakeblk",!1,{variety:!0}),this.add("dispmove",!0),this.add("disptype_yajilin",1,{option:[1,2]}),this.add("disptype_bosanowa",1,{option:[1,2,3]}),this.add("disptype_interbd",3,{option:[1,2,3]}),this.add("snakebd",!1),this.add("ensquare",!0),this.add("context_marks",!0),this.add("dispqnumbg",!1),this.add("undefcell",!0),this.add("mouseonly",!1),this.add("patchwork_leftaux",!0),this.add("squarecell",!0),this.add("use",t?2:1,{option:[1,2]}),this.add("use_tri",1,{option:[1,2,3]}),this.add("support_tri",!0),this.add("bgcolor",!1),this.add("singlenum",!t),this.add("singleregion",!0),this.add("enline",!0),this.add("lattice",!0),this.add("autocmp",!0,{variety:!0}),this.add("autoerr",!1,{variety:!0}),this.add("multierr",!1),this.add("forceallcell",!1),this.add("dontpassallcell",!1,{variant:!0,volatile:!0}),this.add("aquarium_regions",!1,{variant:!0,volatile:!0}),this.add("country_empty",!1,{variant:!0,volatile:!0}),this.add("voxas_tatami",!1,{variant:!0,volatile:!0}),this.add("tren_new",!1,{variant:!0,volatile:!0}),this.add("nuriuzu_connect",!1,{variant:!0,volatile:!0}),this.add("bdwalk_height",!1,{variant:!0,volatile:!0}),this.add("pentopia_transparent",!1,{variant:!0,volatile:!0}),this.add("yajilin_out",!1,{variant:!0,volatile:!0}),this.add("koburin_minesweeper",!1,{variant:!0,volatile:!0}),this.add("akichi_maximum",!1,{variant:!0,volatile:!0}),this.add("magnets_anti",!1,{variant:!0,volatile:!0}),this.add("heyapin_overlap",!1,{variant:!0,volatile:!0}),this.add("aqre_borders",!1,{variant:!0,volatile:!0}),this.add("fillomino_tri",!1,{variant:!0,volatile:!0}),this.add("slither_full",!1,{variant:!0,volatile:!0}),this.add("loop_full",!1,{variant:!0,volatile:!0}),this.add("variant",!1,{variant:!0,volatile:!0}),this.add("variantid","",{volatile:!0}),this.add("discolor",!1),this.add("uramashu",!1,{volatile:!0})},add:function(t,e,i){e={val:e,defval:e,volatile:!(!(i=i||{}).volatile&&!i.variant),extoption:i};i.option&&(e.option=i.option),i.variety&&(e.variety={}),i.variant&&(e.variant=!0),this.list[t]=e},getCurrentName:function(t){switch(t){case"color_qanscolor":t="color_shadecolor";break;case"autocmp_area":case"autocmp_border":this.getexec("autocmp")&&(t="autocmp")}return t},getNormalizedName:function(t){var e={name:t};return t.match(/\@/)&&(t=t.split(/\@/),e.name=t[0],(t=p.variety.toPID(t[1]))&&(e.pid=t)),e.name=this.getCurrentName(e.name),e},get:function(t){var t=this.getNormalizedName(t),e=t.name,e=this.list[e];if(!e)return null;if(e.variety){t=(void 0!==t.pid?t:this.puzzle).pid;if(void 0!==e.variety[t])return e.variety[t]}return e.val},set:function(t,e){var t=this.getNormalizedName(t),i=t.name;this.list[i]&&(e=this.setproper(t,e),this.configevent(i,e),this.puzzle.emit("config",i,e))},reset:function(t){var e=this.getNormalizedName(t),i=this.list[e.name];i&&(i.variety&&!e.pid?(i.variety={},this.set(e.name,i.defval)):this.set(t,i.defval))},getList:function(){var t,e={};for(t in this.list)this.getexec(t)&&(e[t]=this.get(t));return e},getvariant:function(t){t=this.list[t];return t?t.variant:null},getVariants:function(){var t,e={};for(t in this.list)this.list[t].variant&&this.getexec(t)&&(e[t]=this.get(t));return e},getAll:function(){var t,e={};for(t in this.list){var i=this.list[t];if(!i.volatile&&(i.val!==i.defval&&(e[t]=i.val),i.variety))for(var s in i.variety)i.variety[s]!==i.defval&&(e[t+"@"+s]=i.variety[s])}return e},setAll:function(t){for(var e in this.init(),t)this.set(e,t[e])},setproper:function(t,e){var i=t.name,i=this.list[i];switch(typeof i.defval){case"boolean":e=!!e;break;case"number":e=+e;break;case"string":e=""+e}return(!i.option||0<=i.option.indexOf(e))&&(i.variety?(t=(void 0!==t.pid?t:this.puzzle).pid)&&(i.variety[t]=e):i.val=e),e},getexec:function(t){var e=this.puzzle,i=e.pid,s=!e.playeronly,n=!1;switch(t){case"use":n=e.mouse.use;break;case"use_tri":case"support_tri":n="shakashaka"===i;break;case"dispmove":n=e.board.linegraph.moveline;break;case"disptype_bosanowa":n="bosanowa"===i;break;case"context_marks":n="context"===i;break;case"disptype_yajilin":n="yajilin"===i||"koburin"===i||"lixloop"===i||"retsurin"===i;break;case"disptype_interbd":n="interbd"===i||"outofsight"===i&&!e.board.isMono;break;case"bgcolor":n="slither"===i||"myopia"===i||"swslither"===i;break;case"irowake":n=e.painter.irowake;break;case"irowakeblk":n=e.painter.irowakeblk;break;case"snakebd":n="hebi"===i;break;case"ensquare":n="tajmahal"===i;break;case"dispqnumbg":n="yinyang"===i;break;case"mouseonly":n="lollipops"===i||"magnets"===i;break;case"patchwork_leftaux":n="patchwork"===i;break;case"undefcell":n="shugaku"===i||"lightshadow"===i||"nibunnogo"===i;break;case"autocmp":n=!!e.painter.autocmp;break;case"autoerr":n="hitori"===i||"gokigen"===i||"wagiri"===i;break;case"singlenum":n="hanare"===i||"putteria"===i||"twinarea"===i;break;case"singleregion":n="parquet"===i;break;case"enline":case"lattice":n="kouchoku"===i||"angleloop"===i;break;case"discolor":n=s&&"tentaisho"===i;break;case"uramashu":n="mashu"===i;break;case"forceallcell":n="fillomino"===i||"symmarea"===i||"snakepit"===i;break;case"dontpassallcell":n="arukone"===i;break;case"aquarium_regions":n="aquarium"===i;break;case"country_empty":n="country"===i;break;case"voxas_tatami":n="voxas"===i;break;case"tren_new":n="tren"===i||"news"===i;break;case"nuriuzu_connect":n="nuriuzu"===i;break;case"bdwalk_height":n="bdwalk"===i;break;case"pentopia_transparent":n="pentopia"===i;break;case"koburin_minesweeper":n="koburin"===i;break;case"akichi_maximum":n="akichi"===i;break;case"magnets_anti":n="magnets"===i;break;case"heyapin_overlap":n="heyapin"===i;break;case"aqre_borders":n="aqre"===i;break;case"fillomino_tri":n="fillomino"===i;break;case"yajilin_out":n=0<=["yajilin","yajilin-regions","koburin","lixloop","retsurin"].indexOf(i);break;case"slither_full":n=0<=["slither","tslither","swslither","myopia","lineofsight"].indexOf(i);break;case"loop_full":n=0<=["mashu","geradeweg","disloop","midloop","ovotovata","balance","turnaround","turnrun","icewalk","waterwalk","firewalk"].indexOf(i);break;default:n=!!this.list[t]}return n},configevent:function(t,e){var i=this.puzzle;if(i.klass&&this.getexec(t))switch(t){case"irowake":case"irowakeblk":case"dispmove":case"cursor":case"trialmarker":case"undefcell":case"autocmp":case"autoerr":case"aquarium_regions":case"koburin_minesweeper":case"snakebd":case"context_marks":case"disptype_yajilin":case"disptype_interbd":case"dispqnumbg":case"mouseonly":i.redraw();break;case"font":i.painter.initFont(),i.redraw();break;case"multierr":i.checker.resetCache();break;case"disptype_bosanowa":i.setCanvasSizeByCellSize();break;case"uramashu":i.board.revCircleConfig(e),i.redraw()}}},p.classmgr.makeCommon({Position:{bx:null,by:null,NDIR:0,UP:1,DN:2,LT:3,RT:4,equals:function(t){return t&&this.bx===t.bx&&this.by===t.by},getaddr:function(){return new this.klass.Address(this.bx,this.by)},relcell:function(t,e){return this.board.getc(this.bx+t,this.by+e)},relcross:function(t,e){return this.board.getx(this.bx+t,this.by+e)},relbd:function(t,e){return this.board.getb(this.bx+t,this.by+e)},relexcell:function(t,e){return this.board.getex(this.bx+t,this.by+e)},relobj:function(t,e){return this.board.getobj(this.bx+t,this.by+e)},reldirbd:function(t,e){return this.getaddr().movedir(t,e).getb()},draw:function(){this.puzzle.painter.paintRange(this.bx-1,this.by-1,this.bx+1,this.by+1)},drawaround:function(){this.puzzle.painter.paintRange(this.bx-3,this.by-3,this.bx+3,this.by+3)},isinside:function(){var t=this.board;return this.bx>=t.minbx&&this.bx<=t.maxbx&&this.by>=t.minby&&this.by<=t.maxby},getdir:function(t,e){var i=t.bx-this.bx,t=t.by-this.by;return 0==i&&t==-e?this.UP:0==i&&t===e?this.DN:i==-e&&0==t?this.LT:i===e&&0==t?this.RT:this.NDIR},getvert:function(t,e){t=this.getdir(t,e);return t===this.UP||t===this.DN||t!==this.LT&&t!==this.RT&&void 0},getnb:function(t){return t.bx-this.bx==0&&t.by-this.by==-2?this.relbd(0,-1):t.bx-this.bx==0&&t.by-this.by==2?this.relbd(0,1):t.bx-this.bx==-2&&t.by-this.by==0?this.relbd(-1,0):t.bx-this.bx==2&&t.by-this.by==0?this.relbd(1,0):this.board.emptyborder},getborderobj:function(t){return 0==(1&t.bx)&&this.bx===t.bx&&1===Math.abs(this.by-t.by)||0==(1&t.by)&&this.by===t.by&&1===Math.abs(this.bx-t.bx)?(this.onborder()?this:t).getb():this.board.nullobj}},"Address:Position":{initialize:function(t,e){2<=arguments.length&&this.init(t,e)},reset:function(){this.bx=null,this.by=null},clone:function(){return new this.constructor(this.bx,this.by)},set:function(t){return this.bx=t.bx,this.by=t.by,this},init:function(t,e){return this.bx=t,this.by=e,this},move:function(t,e){return this.bx+=t,this.by+=e,this},oncell:function(){return!!(1&this.bx&&1&this.by)},oncross:function(){return!(1&this.bx||1&this.by)},onborder:function(){return!!(this.bx+this.by&1)},getc:function(){return this.board.getc(this.bx,this.by)},getx:function(){return this.board.getx(this.bx,this.by)},getb:function(){return this.board.getb(this.bx,this.by)},getex:function(){return this.board.getex(this.bx,this.by)},getobj:function(){return this.board.getobj(this.bx,this.by)},getDot:function(){return this.board.getDot(this.bx,this.by)},movedir:function(t,e){switch(t){case this.UP:this.by-=e;break;case this.DN:this.by+=e;break;case this.LT:this.bx-=e;break;case this.RT:this.bx+=e}return this}},"RawAddress:Address":{},"Dot:Position":{isnull:!0,id:null,piece:null,getDot:function(){return this.piece.qnum},setDot:function(t){this.puzzle.opemgr.disCombine=!0,this.piece.setQnum(t),this.puzzle.opemgr.disCombine=!1},iserror:function(){return 0<this.piece.error},getaddr:function(){return new this.klass.Address(this.bx,this.by)}}}),p.classmgr.makeCommon({"BoardPiece:Position":{group:"none",id:null,isnull:!0,ques:0,qdir:0,qnum:-1,qnum2:-1,qnum3:-1,qnum4:-1,qnums:[],qchar:0,qans:0,anum:-1,line:0,qsub:0,qcmp:0,snum:-1,error:0,qinfo:0,trial:0,propques:["ques","qdir","qnum","qnum2","qnum3","qnum4","qchar","qnums"],propans:["qans","anum","line","trial"],propsub:["qsub","qcmp","snum"],propinfo:["error","qinfo"],propnorec:{color:1,error:1,qinfo:1},maxnum:999,minnum:1,initAdjacent:function(){this.adjacent={top:this.relobj(0,-2),bottom:this.relobj(0,2),left:this.relobj(-2,0),right:this.relobj(2,0)}},initAdjBorder:function(){this.adjborder={top:this.relbd(0,-1),bottom:this.relbd(0,1),left:this.relbd(-1,0),right:this.relbd(1,0)}},setQues:function(t){this.setdata("ques",t)},setQans:function(t){this.setdata("qans",t)},setQdir:function(t){this.setdata("qdir",t)},setQnum:function(t){this.setdata("qnum",t)},setQnum2:function(t){this.setdata("qnum2",t)},setQchar:function(t){this.setdata("qchar",t)},setAnum:function(t){this.setdata("anum",t)},setLineVal:function(t){this.setdata("line",t)},setQsub:function(t){this.setdata("qsub",t)},setQcmp:function(t){this.setdata("qcmp",t)},setSnum:function(t){this.setdata("snum",t)},distinctQnums:!1,isValidQnums:function(t){return t.length<=4},setQnums:function(t){this.setdata("qnums",t)},setQnumDir:function(t,e){switch(t){case this.RT:return void this.setdata("qnum",e);case this.DN:return void this.setdata("qnum2",e);case this.LT:return void this.setdata("qnum3",e);case this.UP:return void this.setdata("qnum4",e)}},getQnumDir:function(t){switch(t){case this.RT:return this.qnum;case this.DN:return this.qnum2;case this.LT:return this.qnum3;case this.UP:return this.qnum4}return-1},setdata:function(t,e,i){("qnums"===t?this.puzzle.pzpr.util.sameArray(this[t],e):this[t]===e)||this.prehook[t]&&this.prehook[t].call(this,e)&&!i||(this.addOpe(t,this[t],e),this[t]=e,0<(i=this.board.trialstage)&&(this.trial=i),this.board.modifyInfo(this,this.group+"."+t),this.posthook[t]&&this.posthook[t].call(this,e))},addOpe:function(t,e,i){"qnums"===t?this.puzzle.pzpr.util.sameArray(e,i)||this.puzzle.opemgr.add(new this.klass.ObjectOperation2(this,e,i)):e!==i&&this.puzzle.opemgr.add(new this.klass.ObjectOperation(this,t,e,i))},setdata2:function(t,e,i,s){this[t][e]===i||this.prehook[t]&&this.prehook[t].call(this,e,i)&&!s||(this.addOpe(t+e,this[t][e],i),this[t][e]=i,0<(s=this.board.trialstage)&&(this.trial=s),this.posthook[t]&&this.posthook[t].call(this,e,i))},getprops:function(){for(var t={},e=this.getproplist(["ques","ans","sub"]),i=0;i<e.length;i++){var s=e[i];t[s]=this[s]}return t},compare:function(t,e){for(var i=this.getproplist(["ques","ans","sub"]),s=0;s<i.length;s++){var n=i[s];("qnums"===n?this.puzzle.pzpr.util.sameArray(t[n],this[n]):t[n]===this[n])||e(this.group,this.id,n)}},getproplist:function(t){for(var e=[],i=0;i<t.length;i++){var s=[];switch(t[i]){case"ques":s=this.propques;break;case"ans":s=this.propans;break;case"sub":s=this.propsub;break;case"info":s=this.propinfo;break;case"trial":s=["trial"]}e=e.concat(s)}return 0<=e.indexOf("snum")&&this.enableSubNumberArray&&e.splice(e.indexOf("snum"),1,"snum0","snum1","snum2","snum3"),e},getmaxnum:function(){return"function"==typeof this.maxnum?this.maxnum():this.maxnum},getminnum:function(){return"function"==typeof this.minnum?this.minnum():this.minnum},prehook:{},posthook:{},seterr:function(t){this.board.isenableSetError()&&(this.error=t)},setinfo:function(t){this.qinfo=t},setCrossBorderError:function(){this.seterr(1),this.board.borderinside(this.bx-1,this.by-1,this.bx+1,this.by+1).seterr(1)}},"Cell:BoardPiece":{group:"cell",lcnt:0,base:null,dirs51:2,disInputHatena:!1,numberWithMB:!1,numberAsObject:!1,numberAsLetter:!1,numberRemainsUnshaded:!1,enableSubNumberArray:!1,disableAnum:!1,supportQnumAnum:!1,adjacent:{},adjborder:{},initialize:function(){var t;this.temp=this.constructor.prototype,this.enableSubNumberArray&&(t=this.temp.anum,this.snum=[t,t,t,t])},prehook:{qnum:function(t){return 0<this.getminnum()&&0===t},qnum2:function(t){return 0<this.getminnum()&&0===t},anum:function(t){return 0<this.getminnum()&&0===t}},posthook:{},isShade:function(){return!this.isnull&&1===this.qans},isUnshade:function(){return!this.isnull&&1!==this.qans},setShade:function(){this.setQans(1)},clrShade:function(){this.setQans(0)},allowShade:function(){return!this.numberRemainsUnshaded||-1===this.qnum},allowUnshade:function(){return!this.numberRemainsUnshaded||(-1===this.qnum||this.puzzle.painter.enablebcolor)},isShadeDecided:function(){return!!this.isnull||(!!this.isShade()||(0<this.qsub||(!this.allowShade()||!this.allowUnshade())))},getNum:function(){return-1!==this.qnum?this.qnum:this.anum},setNum:function(t){var e;0<this.getminnum()&&0===t||(this.puzzle.editmode?(t=!this.numberAsObject&&-2!==t||this.qnum!==t?t:-1,this.setQnum(t),this.setAnum(-1),this.numberRemainsUnshaded&&this.setQans(0),this.puzzle.painter.enablebcolor||this.setQsub(0),this.setQcmp(0),this.clrSnum()):-1!==this.qnum||this.disableAnum||(e=-1<t&&(!this.numberAsObject||this.anum!==t)?t:-1,t=t<-1&&(!this.numberAsObject||this.qsub!==-t-1)?-t-1:0,this.setAnum(e),this.setQsub(t),this.setQdir(0),this.setQcmp(0),this.numberWithMB&&-1===e||this.clrSnum()))},isNum:function(){return!this.isnull&&(this.qnum!==this.temp.qnum||this.anum!==this.temp.anum)},isLineShapeEndpoint:function(){return this.isNum()},noNum:function(){return!this.isnull&&this.qnum===this.temp.qnum&&this.anum===this.temp.anum},isValidNum:function(){return!this.isnull&&(0<=this.qnum||0<=this.anum&&this.qnum===this.temp.qnum)},isNumberObj:function(){return this.qnum!==this.temp.qnum||this.anum!==this.temp.anum||this.numberWithMB&&1===this.qsub},sameNumber:function(t){return this.isValidNum()&&t.isValidNum()&&this.getNum()===t.getNum()},setSnum:function(t,e){this.isNum()&&-1!==e||(this.enableSubNumberArray?this.setdata2("snum",t,e):this.setdata("snum",e))},clrSnum:function(){this.enableSubNumberArray?(this.setSnum(0,-1),this.setSnum(1,-1),this.setSnum(2,-1),this.setSnum(3,-1)):this.setSnum(-1)},is51cell:function(){return 51===this.ques},set51cell:function(t){this.setQues(51);for(var e=1;e<=4;e++)this.setQnumDir(e,-1);this.setAnum(-1)},remove51cell:function(t){this.setQues(0);for(var e=1;e<=4;e++)this.setQnumDir(e,-1);this.setAnum(-1)},ice:function(){return 6===this.ques},isDot:function(){return 1===this.qsub},isEmpty:function(){return this.isnull||7===this.ques},isValid:function(){return!this.isnull&&7!==this.ques},setValid:function(t){for(var e in this.setQues(t),this.setQnum(-1),this.setQans(0),this.setQsub(0),this.adjborder)this.adjborder[e].setQans(0);this.drawaround(),this.board.roommgr.rebuild()},isDeparture:function(){return!this.isnull&&!!this.base&&this.isNum()},isDestination:function(){return!this.isnull&&!!this.base&&!this.base.isnull},isLineStraight:function(){return 2===this.lcnt&&this.adjborder.top.isLine()&&this.adjborder.bottom.isLine()?1:2===this.lcnt&&this.adjborder.left.isLine()&&this.adjborder.right.isLine()?2:0},isLineCurve:function(){return 2===this.lcnt&&!this.isLineStraight()},isLPobj:{1:{11:1,12:1,14:1,15:1},2:{11:1,12:1,16:1,17:1},3:{11:1,13:1,15:1,16:1},4:{11:1,13:1,14:1,17:1}},noLPobj:{1:{1:1,4:1,5:1,13:1,16:1,17:1,21:1},2:{1:1,2:1,3:1,13:1,14:1,15:1,21:1},3:{1:1,2:1,5:1,12:1,14:1,17:1,22:1},4:{1:1,3:1,4:1,12:1,15:1,16:1,22:1}},isLP:function(t){return!!this.isLPobj[t][this.ques]},noLP:function(t){return!!this.noLPobj[t][this.ques]},countDir4Cell:function(t){for(var e=this.adjacent,i=0,s=[e.top,e.bottom,e.left,e.right],n=0;n<4;n++)"cell"===s[n].group&&!s[n].isnull&&t(s[n])&&i++;return i},getdir4clist:function(){for(var t=this.adjacent,e=[],i=[t.top,t.bottom,t.left,t.right],s=0;s<4;s++)"cell"!==i[s].group||i[s].isnull||e.push([i[s],s+1]);return e},getdir4cblist:function(){for(var t=this.adjacent,e=this.adjborder,i=[],s=[t.top,t.bottom,t.left,t.right],n=[e.top,e.bottom,e.left,e.right],r=0;r<4;r++)("cell"!==s[r].group||s[r].isnull)&&n[r].isnull||i.push([s[r],n[r],r+1]);return i},getdir8clist:function(){for(var t=[],e=[this.relcell(-2,-2),this.relcell(0,-2),this.relcell(2,-2),this.relcell(-2,0),this.relcell(2,0),this.relcell(-2,2),this.relcell(0,2),this.relcell(2,2)],i=0;i<8;i++)"cell"!==e[i].group||e[i].isnull||t.push([e[i],i+1]);return t},getdiagclist:function(){for(var t=[],e=[this.relcell(-2,-2),this.relcell(2,-2),this.relcell(-2,2),this.relcell(2,2)],i=0;i<4;i++)"cell"!==e[i].group||e[i].isnull||t.push([e[i],i+1]);return t},getOrthogonalCell:function(t){return this.bx===t.bx?this.by===t.by?this.board.emptycell:this.by>t.by?this.adjacent.top:this.adjacent.bottom:this.by===t.by?this.bx>t.bx?this.adjacent.left:this.adjacent.right:this.board.emptycell},eraseMovedLines:function(){if(null!==this.path){for(var t=this.path.clist,e=0,i=0,s=t.length;i<s;i++)for(var n=i+1;n<s;n++){var r=t[i].getnb(t[n]);r.isnull||(r.removeLine(),e++)}0<e&&t.draw()}}},"Cross:BoardPiece":{group:"cross",lcnt:0,adjborder:{},getNum:function(){return this.qnum},setNum:function(t){t=-2===t&&this.qnum===t?-1:t,this.setQnum(t)},noNum:function(){return!this.isnull&&-1===this.qnum}},"Border:BoardPiece":{initialize:function(){this.sidecell=[null,null],this.sidecross=[null,null],this.sideobj=[]},group:"border",isvert:!1,inside:!1,path:null,enableLineNG:!1,initSideObject:function(){var t=2===this.board.hasborder&&2===this.board.hasexcell;this.isvert?(this.sidecell[0]=!t||0<this.bx?this.relcell(-1,0):this.relexcell(-1,0),this.sidecell[1]=!t||this.bx<2*this.board.cols?this.relcell(1,0):this.relexcell(1,0),this.sidecross[0]=this.relcross(0,-1),this.sidecross[1]=this.relcross(0,1)):(this.sidecell[0]=!t||0<this.by?this.relcell(0,-1):this.relexcell(0,-1),this.sidecell[1]=!t||this.by<2*this.board.rows?this.relcell(0,1):this.relexcell(0,1),this.sidecross[0]=this.relcross(-1,0),this.sidecross[1]=this.relcross(1,0)),this.sideobj=this.board.borderAsLine?this.sidecross:this.sidecell},prehook:{qans:function(t){return 0!==this.ques},line:function(t){return this.checkStableLine(t)}},posthook:{},draw:function(){this.puzzle.painter.paintRange(this.bx-2,this.by-2,this.bx+2,this.by+2)},isLine:function(){return 0<this.line},setLine:function(t){this.setLineVal(1),2===this.qsub&&this.setQsub(0)},setPeke:function(t){this.setLineVal(0),this.setQsub(2)},removeLine:function(t){this.setLineVal(0),2===this.qsub&&this.setQsub(0)},removeLineAndQsub:function(t){this.setLineVal(0),this.setQsub(0)},isBorder:function(){return 0<this.ques||0<this.qans},setBorder:function(){this.puzzle.editmode?(this.setQues(1),this.setQans(0)):1!==this.ques&&this.setQans(1)},removeBorder:function(){this.puzzle.editmode?(this.setQues(0),this.setQans(0)):1!==this.ques&&this.setQans(0)},isVert:function(){return this.isvert},isHorz:function(){return!this.isvert},checkStableLine:function(t){return!!this.enableLineNG&&(0!==t&&this.isLineNG())},checkFormCurve:function(t){if(0===t)return!1;for(var e=0;e<=1;e++){if(this.isVert()&&(this.sidecell[e].adjborder.top.isLine()||this.sidecell[e].adjborder.bottom.isLine()))return!0;if(!this.isVert()&&(this.sidecell[e].adjborder.left.isLine()||this.sidecell[e].adjborder.right.isLine()))return!0}return!1},isLineEX:function(){return!1},isLineNG:function(){var t=this.sidecell[0],e=this.sidecell[1];return this.isVert()?t.noLP(t.RT)||e.noLP(e.LT):t.noLP(t.DN)||e.noLP(e.UP)}},"ExCell:BoardPiece":{group:"excell",adjacent:{},getNum:function(){return this.qnum},setNum:function(t){this.setQnum(t)},noNum:function(){return!this.isnull&&-1===this.qnum},is51cell:function(){return 51===this.ques},ice:function(){return!1}}}),p.classmgr.makeCommon({PieceList:{initialize:function(t){t&&this.extend(t)},length:0,add:Array.prototype.push,extend:function(t){var e=(t=t instanceof Set?Array.from(t):t).length,i=this.length;this.length+=e;for(var s=0;s<e;s++)this[i+s]=t[s]},pop:Array.prototype.pop,each:Array.prototype.forEach,some:Array.prototype.some,filter:function(t){for(var e=new this.constructor,i=this.length,s=0,n=0;n<i;n++)t(this[n])&&(e[s]=this[n],s++);return e.length=s,e},notnull:function(t){return this.filter(function(t){return!t.isnull})},map:function(t){for(var e=new this.constructor,i=e.length=this.length,s=0;s<i;s++)e[s]=t(this[s]);return e},indexOf:Array.prototype.indexOf,include:function(t){return 0<=this.indexOf(t)},remove:function(t){t=this.indexOf(t);0<=t&&Array.prototype.splice.call(this,t,1)},seterr:function(t){if(this.board.isenableSetError())for(var e=0;e<this.length;e++)this[e].error=t},setnoerr:function(){if(this.board.isenableSetError())for(var t=0;t<this.length;t++)0===this[t].error&&(this[t].error=-1)},setinfo:function(t){for(var e=0;e<this.length;e++)this[e].qinfo=t},allclear:function(t){this.propclear(["ques","ans","sub","info"],t)},ansclear:function(){this.propclear(["ans","sub","info"],!0)},subclear:function(){this.propclear(["sub","info"],!0)},errclear:function(){this.propclear(["info"],!1)},trialclear:function(){this.propclear(["trial"],!1)},propclear:function(t,e){var i=[],s={};0<this.length&&(i=this[0].getproplist(t),s=this[0].propnorec);for(var n=0;n<this.length;n++)for(var r=this[n],o=0;o<i.length;o++){var a,h=i[o],l="";4<h.length&&"snum"===h.substr(0,4)?(l=h.charAt(4),h=h.substr(0,4),a=r.constructor.prototype[h],r[h][l]!==a&&(e&&!s[h]&&r.addOpe(h+l,r[h][l],a),r[h][l]=a)):(a=r.constructor.prototype[h],("qnums"===h?this.puzzle.pzpr.util.sameArray(r[h],a):r[h]===a)||(e&&!s[h]&&r.addOpe(h,r[h],a),r[h]=a))}}},"CellList:PieceList":{getRectSize:function(){for(var t=this.board,e={x1:t.maxbx+1,x2:t.minbx-1,y1:t.maxby+1,y2:t.minby-1,cols:0,rows:0,cnt:0},i=0;i<this.length;i++){var s=this[i];e.x1>s.bx&&(e.x1=s.bx),e.x2<s.bx&&(e.x2=s.bx),e.y1>s.by&&(e.y1=s.by),e.y2<s.by&&(e.y2=s.by),e.cnt++}return e.cols=(e.x2-e.x1+2)/2,e.rows=(e.y2-e.y1+2)/2,e},singleQnumCell:!1,getQnumCell:function(){for(var t=null,e=0,i=this.length;e<i;e++)if(this[e].isNum()){if(this.singleQnumCell){if(t)return this.board.emptycell}else if(-2!==this[e].qnum)return this[e];t=this[e]}return t||this.board.emptycell},getTopCell:function(){for(var t=this.board,e=null,i=t.maxbx,s=t.maxby,n=0;n<this.length;n++){var r=this[n];r.bx>i||r.bx===i&&r.by>=s||(e=this[n],i=r.bx,s=r.by)}return e},eraseLines:function(){for(var t=0,e=0,i=this.length;e<i;e++)for(var s=e+1;s<i;s++){var n=this.puzzle.mouse.getnb(this[e].getaddr(),this[s].getaddr());n.isnull||(n.removeLine(),t++)}0<t&&this.draw()},draw:function(){var t=this.getRectSize();this.puzzle.painter.paintRange(t.x1-1,t.y1-1,t.x2+1,t.y2+1)},getBlockShapes:function(){if(this.shape)return this.shape;for(var t=this.board,e=this.getRectSize(),i=e.x2-e.x1==e.cols-1?1:2,s=e.y2-e.y1==e.rows-1?1:2,n=[[],[],[],[],[],[],[],[]],r=[],o=0;o<=e.y2-e.y1;o+=s)for(var a=0;a<=e.x2-e.x1;a+=i)n[0].push(this.include(t.getc(e.x1+a,e.y1+o))?1:0),n[1].push(this.include(t.getc(e.x1+a,e.y2-o))?1:0);for(a=0;a<=e.x2-e.x1;a+=i)for(o=0;o<=e.y2-e.y1;o+=s)n[4].push(this.include(t.getc(e.x1+a,e.y1+o))?1:0),n[5].push(this.include(t.getc(e.x1+a,e.y2-o))?1:0);n[2]=n[1].concat().reverse(),n[3]=n[0].concat().reverse(),n[6]=n[5].concat().reverse(),n[7]=n[4].concat().reverse();for(var h=0;h<8;h++)r[h]=(h<4?e.cols:e.rows)+":"+n[h].join("");var l=r[0];return r.sort(),this.shape={canon:r[0],id:l}}},"CrossList:PieceList":{},"BorderList:PieceList":{cellinside:function(){for(var t=new this.klass.CellList,e=[],i=0;i<this.length;i++){var s=this[i],n=s.sidecell[0],s=s.sidecell[1];n.isnull||!0===e[n.id]||(t.add(n),e[n.id]=!0),s.isnull||!0===e[s.id]||(t.add(s),e[s.id]=!0)}return t},crossinside:function(){for(var t=new this.klass.CrossList,e=[],i=0;i<this.length;i++){var s=this[i],n=s.sidecross[0],s=s.sidecross[1];n.isnull||!0===e[n.id]||(t.add(n),e[n.id]=!0),s.isnull||!0===e[s.id]||(t.add(s),e[s.id]=!0)}return t}},"ExCellList:PieceList":{}}),p.classmgr.makeCommon({Board:{initialize:function(){var t=this.klass;this.minbx=0,this.minby=0,this.maxbx=0,this.maxby=0,this.diserror=0,this.haserror=!1,this.hasinfo=!1,this.cell=new t.CellList,this.cross=new t.CrossList,this.border=new t.BorderList,this.excell=new t.ExCellList,this.nullobj=new t.BoardPiece,this.emptycell=new t.Cell,this.emptycross=new t.Cross,this.emptyborder=new t.Border,this.emptyexcell=new t.ExCell;try{Object.freeze(this.nullobj),Object.freeze(this.emptycell),Object.freeze(this.emptycross),Object.freeze(this.emptyborder),Object.freeze(this.emptyexcell)}catch(t){}this.createExtraObject(),this.disrecinfo=0,this.infolist=[],this.linegraph=this.addInfoList(t.LineGraph),this.roommgr=this.addInfoList(t.AreaRoomGraph),this.sblkmgr=this.addInfoList(t.AreaShadeGraph),this.ublkmgr=this.addInfoList(t.AreaUnshadeGraph),this.nblkmgr=this.addInfoList(t.AreaNumberGraph),t.Bank.prototype.enabled&&(this.bank=new t.Bank,this.bank.init(),this.bank.initialize(this.bank.defaultPreset())),this.addExtraInfo(),this.exec=new t.BoardExec,this.exec.insex.cross=1===this.hascross?{2:!0}:{0:!0},this.trialstage=0},addInfoList:function(t){t=new t;return t.enabled&&this.infolist.push(t),t},addExtraInfo:function(){},cols:10,rows:10,hascross:2,hasborder:0,hasexcell:0,hasflush:0,borderAsLine:!1,disable_subclear:!1,excellRows:function(t,e){return 1},excellCols:function(t,e){return 1},initBoardSize:function(t,e){void 0!==t&&!isNaN(t)||(t=this.cols,e=this.rows),this.allclear(!1),this.initGroup("cell",t,e),this.initGroup("cross",t,e),this.initGroup("border",t,e),this.initGroup("excell",t,e),this.cols=t,this.rows=e,this.setminmax(),this.setposAll(),this.hasdots&&this.initDots(this.cols,this.rows,2===this.hasdots),this.initExtraObject(t,e),this.bank&&(this.bank.width=this.cols/this.puzzle.painter.bankratio,this.bank.performLayout()),this.rebuildInfo(),this.puzzle.cursor.initCursor(),this.puzzle.opemgr.allerase()},createExtraObject:function(){},initExtraObject:function(t,e){},getBankPiecesInGrid:function(){return[]},initGroup:function(t,e,i){var s=this.getGroup(t),n=this.estimateSize(t,e,i),e=s.length;if(n<e)for(var r=e-1;n<=r;r--)s.pop();else if(e<n){for(var o=new s.constructor,r=e;r<n;r++){var a=this.newObject(t,r);s.add(a),o.add(a)}o.allclear(!1)}return(s.length=n)-e},getGroup:function(t){return"cell"===t?this.cell:"cross"===t?this.cross:"border"===t?this.border:"excell"===t?this.excell:new this.klass.PieceList},estimateSize:function(t,e,i){if("cell"===t)return e*i;if("cross"===t)return(e+1)*(i+1);if("border"===t){if(1===this.hasborder)return 2*e*i-(e+i);if(2===this.hasborder)return 2*e*i+(e+i)}else if("excell"===t){var s;if(1===this.hasexcell)return t=this.excellRows(e,i),s=this.excellCols(e,i),(e*=t)+(i*=s)+(51===this.emptyexcell.ques?1:0);if(2===this.hasexcell)return 2*(e+i)}return 0},newObject:function(t,e){var i=this.nullobj,s=this.klass;return"cell"===t?i=new s.Cell:"cross"===t?i=new s.Cross:"border"===t?i=new s.Border:"excell"===t&&(i=new s.ExCell),i!==this.nullobj&&void 0!==e&&(i.id=e),i},setposAll:function(){this.setposCells(),this.setposCrosses(),this.setposBorders(),this.setposExCells()},setposGroup:function(t){"cell"===t?this.setposCells():"cross"===t?this.setposCrosses():"border"===t?this.setposBorders():"excell"===t&&this.setposExCells()},setposCells:function(){for(var t=this.cols,e=0;e<this.cell.length;e++){var i=this.cell[e];i.id=e,i.isnull=!1,i.bx=e%t*2+1,i.by=1+(e/t<<1),i.initAdjacent(),i.initAdjBorder()}},setposCrosses:function(){for(var t=this.cols,e=0;e<this.cross.length;e++){var i=this.cross[e];i.id=e,i.isnull=!1,i.bx=e%(t+1)*2,i.by=e/(t+1)<<1,i.initAdjBorder()}},setposBorders:function(){for(var t=this.cols,e=this.rows,i=2*t*e-t-e,s=0;s<this.border.length;s++){var n=this.border[s],r=s;n.id=s,n.isnull=!1,0<=r&&r<(t-1)*e&&(n.bx=r%(t-1)*2+2,n.by=1+(r/(t-1)<<1)),0<=(r-=(t-1)*e)&&r<t*(e-1)&&(n.bx=r%t*2+1,n.by=2+(r/t<<1)),r-=t*(e-1),2===this.hasborder&&(0<=r&&r<t&&(n.bx=2*r+1,n.by=0),0<=(r-=t)&&r<t&&(n.bx=2*r+1,n.by=2*e),0<=(r-=t)&&r<e&&(n.bx=0,n.by=2*r+1),0<=(r-=e)&&r<e&&(n.bx=2*t,n.by=2*r+1),r-=e),n.isvert=!(1&n.bx),n.inside=s<i,n.initSideObject()}},setposExCells:function(){for(var t=this.excellRows(this.cols,this.rows),e=this.excellCols(this.cols,this.rows),i=this.cols*t,s=this.rows*e,n=0;n<this.excell.length;n++){var r=this.excell[n],o=n;r.id=n,r.isnull=!1,1===this.hasexcell?(0<=o&&o<i&&(r.bx=2*(o/t|0)+1,r.by=o%t*-2-1),0<=(o-=i)&&o<s&&(r.bx=o%e*-2-1,r.by=2*(o/e|0)+1),0===(o-=s)&&51===r.ques&&(r.bx=-1,r.by=-1),o--):2===this.hasexcell&&(0<=o&&o<i&&(r.bx=2*o+1,r.by=-1),0<=(o-=i)&&o<i&&(r.bx=2*o+1,r.by=2*s+1),0<=(o-=i)&&o<s&&(r.bx=-1,r.by=2*o+1),0<=(o-=s)&&o<s&&(r.bx=2*i+1,r.by=2*o+1),o-=s),r.initAdjacent()}},setminmax:function(){var t=0<this.hasexcell,e=2===this.hasexcell;this.minbx=t?-2*this.excellCols(this.cols,this.rows):0,this.minby=t?-2*this.excellRows(this.cols,this.rows):0,this.maxbx=e?2*this.cols+2:2*this.cols,this.maxby=e?2*this.rows+2:2*this.rows,this.puzzle.cursor.setminmax()},allclear:function(t){this.cell.allclear(t),this.cross.allclear(t),this.border.allclear(t),this.excell.allclear(t),t&&this.puzzle.opemgr.rejectTrial(!0)},ansclear:function(){var t=this.puzzle.opemgr;t.rejectTrial(!0),t.newOperation(),t.add(new this.puzzle.klass.BoardClearOperation),this.cell.ansclear(),this.cross.ansclear(),this.border.ansclear(),this.excell.ansclear(),this.bank&&this.bank.ansclear(),this.rebuildInfo()},subclear:function(){this.puzzle.opemgr.newOperation(),this.cell.subclear(),this.cross.subclear(),this.border.subclear(),this.excell.subclear(),this.bank&&this.bank.subclear(),this.rebuildInfo()},errclear:function(){var t=this.haserror||this.hasinfo;return t&&(this.cell.errclear(),this.cross.errclear(),this.border.errclear(),this.excell.errclear(),this.bank&&this.bank.errclear(),this.haserror=!1,this.hasinfo=!1),t},trialclear:function(t){(0<this.trialstage||t)&&(this.cell.trialclear(),this.cross.trialclear(),this.border.trialclear(),this.excell.trialclear(),this.puzzle.redraw(),this.trialstage=0)},getObjectPos:function(t,e,i){var s=this.nullobj;return"cell"===t?s=this.getc(e,i):"cross"===t?s=this.getx(e,i):"border"===t?s=this.getb(e,i):"excell"===t?s=this.getex(e,i):"obj"===t&&(s=this.getobj(e,i)),s},getc:function(t,e){var i=null,s=this.cols,n=this.rows;return null!==(i=!(t<0||s<<1<t||e<0||n<<1<e)&&1&t&&1&e?(t>>1)+(e>>1)*s:i)?this.cell[i]:this.emptycell},getx:function(t,e){var i=null,s=this.cols,n=this.rows;return t<0||s<<1<t||e<0||n<<1<e||1&t||1&e||(i=(t>>1)+(e>>1)*(s+1)),0!==this.hascross&&null!==i?this.cross[i]:this.emptycross},getb:function(t,e){var i=null,s=this.cols,n=this.rows;return this.hasborder&&1<=t&&t<=2*s-1&&1<=e&&e<=2*n-1?!(1&t)&&1&e?i=(t>>1)-1+(e>>1)*(s-1):1&t&&!(1&e)&&(i=(t>>1)+((e>>1)-1)*s+(s-1)*n):2===this.hasborder&&(0===e&&1&t&&1<=t&&t<=2*s-1?i=(s-1)*n+s*(n-1)+(t>>1):e===2*n&&1&t&&1<=t&&t<=2*s-1?i=(s-1)*n+s*(n-1)+s+(t>>1):0===t&&1&e&&1<=e&&e<=2*n-1?i=(s-1)*n+s*(n-1)+2*s+(e>>1):t===2*s&&1&e&&1<=e&&e<=2*n-1&&(i=(s-1)*n+s*(n-1)+2*s+n+(e>>1))),null!==i?this.border[i]:this.emptyborder},getex:function(t,e){var i=this.excellRows(this.cols,this.rows),s=this.excellCols(this.cols,this.rows),n=null,r=this.cols*i,o=this.rows*s;return 1===this.hasexcell?51===this.emptyexcell.ques&&-1===t&&-1===e?n=r+o:e>=this.minby&&e<0&&0<t&&t<2*r?n=(-e>>1)+(t>>1)*i:t>=this.minbx&&t<0&&0<e&&e<2*o&&(n=(-t>>1)+r+(e>>1)*s):2===this.hasexcell&&(-1===e&&0<t&&t<2*r?n=t>>1:e===2*o+1&&0<t&&t<2*r?n=r+(t>>1):-1===t&&0<e&&e<2*o?n=2*r+(e>>1):t===2*r+1&&0<e&&e<2*o&&(n=2*r+o+(e>>1))),null!==n?this.excell[n]:this.emptyexcell},getobj:function(t,e){if(t+e&1)return this.getb(t,e);if(!(1&t||1&e))return this.getx(t,e);var i=this.getc(t,e);return i===this.emptycell&&this.hasexcell?this.getex(t,e):i},operate:function(t){if(0<this.trialstage&&this.exec.isBoardOp(t))throw Error("board operations are not possible in trial mode");this.exec.execadjust(t)},flushexcell:function(){this.puzzle.opemgr.newOperation();var t=this.cols,e=this.rows,i=this.excell;this.genericFlush(this.excellCols(t,e),this.excellRows(t,e),t,e,function(t){return i[t].qnum},function(t,e){i[t].setQcmp(0),i[t].setQnum(e)}),this.puzzle.redraw()},genericFlush:function(t,e,i,s,n,r){for(var o=i*e,a=s*t,h=0,l=0;l<o+a;l++)if(-1!==n(l)&&(l!==h-1&&r(h,n(l)),h++),l<o&&l%e==e-1||o<=l&&(l-o)%t==t-1){for(var c=h;c<=l;c++)r(c,-1);h=l+1}},objectinside:function(t,e,i,s,n){return"cell"===t?this.cellinside(e,i,s,n):"cross"===t?this.crossinside(e,i,s,n):"border"===t?this.borderinside(e,i,s,n):"excell"===t?this.excellinside(e,i,s,n):new this.klass.PieceList},cellinside:function(t,e,i,s){for(var n=new this.klass.CellList,r=1|e;r<=s;r+=2)for(var o=1|t;o<=i;o+=2){var a=this.getc(o,r);a.isnull||n.add(a)}return n},crossinside:function(t,e,i,s){var n=new this.klass.CrossList;if(this.hascross)for(var r=e+(1&e);r<=s;r+=2)for(var o=t+(1&t);o<=i;o+=2){var a=this.getx(o,r);a.isnull||n.add(a)}return n},borderinside:function(t,e,i,s){var n=new this.klass.BorderList;if(this.hasborder)for(var r=e;r<=s;r++)for(var o=t+(t+r&1^1);o<=i;o+=2){var a=this.getb(o,r);a.isnull||n.add(a)}return n},excellinside:function(t,e,i,s){var n=new this.klass.ExCellList;if(this.hasexcell)for(var r=1|e;r<=s;r+=2)for(var o=1|t;o<=i;o+=2){var a=this.getex(o,r);a&&!a.isnull&&n.add(a)}return n},disableInfo:function(){this.puzzle.opemgr.disableRecord(),this.disrecinfo++},enableInfo:function(){this.puzzle.opemgr.enableRecord(),0<this.disrecinfo&&this.disrecinfo--},isenableInfo:function(){return 0===this.disrecinfo},rebuildInfo:function(){this.bank&&this.bank.rebuildExtraData(),this.infolist.forEach(function(t){t.rebuild()})},modifyInfo:function(t,e){if(this.isenableInfo())for(var i=0;i<this.infolist.length;++i){var s=this.infolist[i];s.relation[e]&&s.modifyInfo(t,e)}},irowakeRemake:function(){for(var t=0;t<this.infolist.length;++t){var e=this.infolist[t];e.coloring&&e.newIrowake()}},disableSetError:function(){this.diserror++},enableSetError:function(){this.diserror--},isenableSetError:function(){return this.diserror<=0},freezecopy:function(){var t,e={cell:[],cross:[],border:[],excell:[]};for(t in e)for(var i=0;i<this[t].length;i++)e[t][i]=this[t][i].getprops();return e},compareData:function(t,e){for(var i in t)if(this[i])for(var s=0;s<t[i].length;s++)this[i][s]&&this[i][s].compare(t[i][s],e)},dotsmax:0,dots:[],initDots:function(t,e,i){var s=2*t+(i?1:-1);this.dotsmax=s*(2*e+(i?1:-1)),this.dots=[];for(var n=0;n<this.dotsmax;n++){this.dots[n]=new this.klass.Dot;var r=this.dots[n];r.id=n,r.bx=n%s+(i?0:1),r.by=(n/s|0)+(i?0:1),r.isnull=!1,r.piece=r.getaddr().getobj()}},getDot:function(t,e){var i=this.cols,s=this.rows,n=-1;if(1===this.hasdots){if(t<=0||i<<1<=t||e<=0||s<<1<=e)return null;n=t-1+(e-1)*(2*i-1)}if(2===this.hasdots){if(t<0||i<<1<t||e<0||s<<1<e)return null;n=t+e*(2*i+1)}if(-1===n)return null;s=this.dots[n];return s.isnull?null:s},dotinside:function(t,e,i,s){for(var n=new this.klass.PieceList,r=e;r<=s;r++)for(var o=t;o<=i;o++){var a=this.getDot(o,r);a&&n.add(a)}return n}}}),b=128,p.classmgr.makeCommon({BoardExec:{UP:1,DN:2,LT:3,RT:4,EXPAND:16,REDUCE:32,TURN:64,FLIP:b,TURNFLIP:192,EXPANDUP:17,EXPANDDN:18,EXPANDLT:19,EXPANDRT:20,REDUCEUP:33,REDUCEDN:34,REDUCELT:35,REDUCERT:36,TURNL:65,TURNR:66,FLIPX:129,FLIPY:130,ALLOWALL:195,allowedOperations:function(t){return this.ALLOWALL},boardtype:{expandup:[33,17],expanddn:[34,18],expandlt:[35,19],expandrt:[36,20],reduceup:[17,33],reducedn:[18,34],reducelt:[19,35],reducert:[20,36],turnl:[66,65],turnr:[65,66],flipy:[130,130],flipx:[129,129]},qnumw:[],qnumh:[],insex:{cell:{1:!0},cross:{},border:{1:!0,2:!0},excell:{1:!0}},isBoardOp:function(t){return!!this.boardtype[t]},adjustSize:function(){var t=this.board;return{x1:0,y1:0,x2:2*t.cols,y2:2*t.rows}},execadjust:function(t){if(this.isBoardOp(t)){var e=this.puzzle,i=this.board;if(0===t.indexOf("reduce"))if("reduceup"===t||"reducedn"===t){if(i.rows<=1)return}else if(("reducelt"===t||"reducert"===t)&&i.cols<=1)return;e.opemgr.newOperation(),e.painter.suspendAll();var s=this.adjustSize();this.execadjust_main(this.boardtype[t][1],s),this.addOpe(s,t),i.setminmax(),i.rebuildInfo(),e.painter.resizeCanvas(),e.emit("adjust"),e.painter.unsuspend()}},execadjust_main:function(e,i){var t,s=this.board;this.adjustBoardData(e,i),s.roommgr.hastop&&32&e&&this.reduceRoomNumber(e,i),64&e?(t=s.cols,s.cols=s.rows,s.rows=t,i={x1:0,y1:0,x2:i.y2,y2:i.x2}):16&e&&(e===this.EXPANDUP||e===this.EXPANDDN?s.rows++:e!==this.EXPANDLT&&e!==this.EXPANDRT||s.cols++),["cell","cross","border","excell"].forEach(function(t){16&e?s.exec.expandGroup(t,e):32&e?s.exec.reduceGroup(t,e):s.exec.turnflipGroup(t,e,i)}),32&e&&(e===this.REDUCEUP||e===this.REDUCEDN?s.rows--:e!==this.REDUCELT&&e!==this.REDUCERT||s.cols--),s.setminmax(),s.setposAll(),s.hasdots&&s.initDots(s.cols,s.rows,2===s.hasdots),s.bank&&(s.bank.width=s.cols/this.puzzle.painter.bankratio,s.bank.performLayout()),this.adjustBoardData2(e,i)},addOpe:function(t,e){var i=this.boardtype[e][1],s=this.puzzle,i=i&this.TURNFLIP?new s.klass.BoardFlipOperation(t,e):new s.klass.BoardAdjustOperation(e);s.opemgr.add(i)},expandGroup:function(t,e){var i=this.board,s=i.initGroup(t,i.cols,i.rows),n=i.getGroup(t),r=new n.constructor;i.setposGroup(t);for(var o=n.length-1;0<=o;o--){var a=n[o];this.isdel(e,a)?(a=i.newObject(t,o),n[o]=a,r.add(a),s--):0<s&&(n[o]=n[o-s])}r.allclear(!1),"border"===t&&this.expandborder(e)},reduceGroup:function(t,e){for(var i=this.board,s=("border"===t&&this.reduceborder(e),0),n=i.getGroup(t),r=new n.constructor,o=0;o<n.length;o++){var a=n[o];this.isdel(e,a)?(a.id=o,r.add(a),s++):0<s&&(n[o-s]=n[o])}i=this.puzzle.opemgr;i.undoExec||i.redoExec||(i.forceRecord=!0,r.allclear(!0),i.forceRecord=!1);for(o=0;o<s;o++)n.pop()},isdel:function(t,e){if("excell"===e.group&&t&(this.EXPAND|this.REDUCE)){var i=this.board,s=i.cols,n=i.rows,r=((7&t)===this.UP||(7&t)===this.DN?n--:s--,i.excellCols(s,n)),i=i.excellRows(s,n);if(e.bx<-2*r+1||e.by<-2*i+1)return!0}return!!this.insex[e.group][this.distObj(t,e)]},turnflipGroup:function(t,e,i){for(var s,n=this.board,r=("excell"===t&&(1===n.hasexcell&&e&this.FLIP?(s={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2},e===this.FLIPY?(s.x1=-2*n.excellCols(n.cols,n.rows)+1,s.x2=-1):e===this.FLIPX&&(s.y1=-2*n.excellRows(n.cols,n.rows)+1,s.y2=-1),i=s):2===n.hasexcell&&(i={x1:-1,y1:-1,x2:i.x2+1,y2:i.y2+1})),n.objectinside(t,i.x1,i.y1,i.x2,i.y2)),o={},a=i.x1+i.x2,h=i.y1+i.y2,l=0;l<r.length;l++){var c=r[l],u=null;switch(e){case this.FLIPY:u=n.getObjectPos(t,c.bx,h-c.by).id;break;case this.FLIPX:u=n.getObjectPos(t,a-c.bx,c.by).id;break;case this.TURNL:u=n.getObjectPos(t,c.by,h-c.bx).id;break;case this.TURNR:u=n.getObjectPos(t,a-c.by,c.bx).id}o[u]=c}var d,f=n.getGroup(t);for(d in o)f[+d]=o[d]},distObj:function(t,e){var i=this.board;return e.isnull?-1:(t&=15)===this.UP?e.by:t===this.DN?2*i.rows-e.by:t===this.LT?e.bx:t===this.RT?2*i.cols-e.bx:-1},expandborder:function(t){var e=this.board,i=e.borderAsLine;if(i||!e.puzzle.opemgr.undoExec){for(var s=new this.klass.BorderList,n=(e.setposBorders(),i?2:1),r=0;r<e.border.length;r++){var o,a=e.border[r];this.distObj(t,a)===n&&(o=i?this.outerBorder(r,t):this.innerBorder(r,t),this.copyBorder(a,o),s.add(o))}i&&s.allclear(!1)}},reduceborder:function(t){var e=this.board;if(e.borderAsLine)for(var i=0;i<e.border.length;i++){var s,n=e.border[i];0===this.distObj(t,n)&&(s=this.innerBorder(i,t),this.copyBorder(n,s))}},copyBorder:function(t,e){t.ques=e.ques,t.qans=e.qans,this.board.borderAsLine&&(t.line=e.line,t.qsub=e.qsub)},innerBorder:function(t,e){t=this.board.border[t];return(e&=15)===this.UP?t.relbd(0,2):e===this.DN?t.relbd(0,-2):e===this.LT?t.relbd(2,0):e===this.RT?t.relbd(-2,0):null},outerBorder:function(t,e){t=this.board.border[t];return(e&=15)===this.UP?t.relbd(0,-2):e===this.DN?t.relbd(0,2):e===this.LT?t.relbd(-2,0):e===this.RT?t.relbd(2,0):null},reduceRoomNumber:function(t,e){for(var i=[],s=this.board,n=0;n<s.cell.length;n++){var r=s.cell[n];this.insex.cell[this.distObj(t,r)]&&(-1!==r.qnum&&(i.push({cell:r,area:r.room,pos:[r.bx,r.by],val:r.qnum}),r.qnum=-1),r.room.clist.remove(r))}for(var o=0;o<i.length;o++){var a,h=i[o],l=h.area.clist.getTopCell();l.isnull?(a=this.puzzle.opemgr).undoExec||a.redoExec||(a.forceRecord=!0,h.cell.addOpe("qnum",h.val,-1),a.forceRecord=!1):l.qnum=h.val}},adjustBoardData:function(t,e){},adjustBoardData2:function(t,e){}}}),p.classmgr.makeCommon({GraphBase:{enabled:!1,relation:{},pointgroup:"",linkgroup:"",coloring:!1,removeFromArray:function(t,e){e=t.indexOf(e);0<=e&&Array.prototype.splice.call(t,e,1)},setComponentRefs:function(t,e){},getObjNodeList:function(t){return[]},resetObjNodeList:function(t){},isnodevalid:function(t){return!1},isedgevalidbylinkobj:function(t){return!0},isedgevalidbynodeobj:function(t,e){return!0},isedgeexistsbylinkobj:function(t){t=this.getSideNodesBySeparator(t);return!!t&&0<=t[0].nodes.indexOf(t[1])},calcNodeCount:function(t){return this.isnodevalid(t)?1:0},rebuildmode:!1,rebuild:function(){this.enabled&&(this.rebuildmode=!0,this.components=[],this.modifyNodes=[],this.rebuild2(),this.searchGraph(),this.rebuildmode=!1)},rebuild2:function(){for(var t=this.board[this.pointgroup],e=this.board[this.linkgroup],i=0;i<t.length;i++)this.setComponentRefs(t[i],null),this.resetObjNodeList(t[i]),this.isnodevalid(t[i])&&this.createNode(t[i]);if(this.linkgroup)for(var s=0;s<e.length;s++)this.setComponentRefs(e[s],null),this.isedgevalidbylinkobj(e[s])&&this.addEdgeByLinkObj(e[s]);else for(i=0;i<t.length;i++)this.isnodevalid(t[i])&&this.setEdgeByNodeObj(t[i])},createComponent:function(){var t=new this.klass.GraphComponent;return this.components.push(t),t},deleteComponent:function(t){for(var e=0;e<t.nodes.length;e++)this.modifyNodes.push(t.nodes[e]),this.setComponentRefs(t.nodes[e].obj,null),t.nodes[e].component=null;this.removeFromArray(this.components,t)},createNode:function(t){var e=new this.klass.GraphNode(t);return this.getObjNodeList(t).push(e),this.modifyNodes.push(e),e},deleteNode:function(t){var e=t.obj,i=(this.setComponentRefs(e,null),this.removeFromArray(this.getObjNodeList(e),t),this.removeFromArray(this.modifyNodes,t),t.component);null!==i&&(this.removeFromArray(i.nodes,t),this.resetExtraData(e),0===i.nodes.length&&this.deleteComponent(i))},createNodeIfEmpty:function(t){0===this.getObjNodeList(t).length&&this.createNode(t)},deleteNodeIfEmpty:function(t){var e=this.getObjNodeList(t);0!==e[0].nodes.length||this.isnodevalid(t)||this.deleteNode(e[0])},addEdge:function(t,e){0<=t.nodes.indexOf(e)||(t.nodes.push(e),e.nodes.push(t),this.rebuildmode||(this.modifyNodes.indexOf(t)<0&&this.modifyNodes.push(t),this.modifyNodes.indexOf(e)<0&&this.modifyNodes.push(e)))},removeEdge:function(t,e){t.nodes.indexOf(e)<0||(this.removeFromArray(t.nodes,e),this.removeFromArray(e.nodes,t),this.rebuildmode||(this.modifyNodes.indexOf(t)<0&&this.modifyNodes.push(t),this.modifyNodes.indexOf(e)<0&&this.modifyNodes.push(e)))},getSideObjByLinkObj:function(t){return t.sideobj},getSideObjByNodeObj:function(t){for(var e=t.getdir4clist(),i=[],s=0;s<e.length;s++){var n=e[s][0];this.isnodevalid(n)&&i.push(n)}return i},getSideNodesByLinkObj:function(t){for(var e=[],i=this.getSideObjByLinkObj(t),s=0;s<i.length;s++){var n=i[s],n=this.getObjNodeList(n),r=n[0];n[1]&&t.isvert&&(r=n[1]),e.push(r)}return e},getSideNodesBySeparator:function(t){for(var e=[],i=t.sideobj,s=0;s<i.length;s++){var n=this.getObjNodeList(i[s]);n&&n[0]&&e.push(n[0])}return 2<=e.length?e:null},modifyInfo:function(t,e){if(this.enabled){var i=this.relation[e];if(i){switch(this.modifyNodes=[],i){case"node":this.setEdgeByNodeObj(t);break;case"link":this.setEdgeByLinkObj(t);break;case"separator":this.setEdgeBySeparator(t);break;default:this.modifyOtherInfo(t,i)}0<this.modifyNodes.length&&this.remakeComponent()}}},setEdgeBySeparator:function(t){var e=this.isedgevalidbylinkobj(t);e!==this.isedgeexistsbylinkobj(t)&&(this.incdecBorderCount&&this.incdecBorderCount(t,!e),e?this.addEdgeBySeparator(t):this.removeEdgeBySeparator(t))},addEdgeBySeparator:function(t){t=this.getSideNodesBySeparator(t);t&&this.addEdge(t[0],t[1])},removeEdgeBySeparator:function(t){var e=this.getSideNodesBySeparator(t);e&&(this.removeEdge(e[0],e[1]),this.linkgroup&&this.setComponentRefs(t,null))},attachNode:function(t,e){(t.component=e).nodes.push(t),this.setComponentInfo(e)},remakeComponent:function(){var t=this.getAffectedComponents();1===t.length&&this.checkDividedComponent(t[0]),this.modifyNodes&&0<this.modifyNodes.length&&this.remakeMaximalComponents(t)},getAffectedComponents:function(){for(var t=[],e=0;e<this.modifyNodes.length;e++){var i=this.modifyNodes[e].component;null===i||i.isremake||(t.push(i),i.isremake=!0)}return t},checkDividedComponent:function(t){for(var e=0,i=this.modifyNodes.length;e<i;e++)(n=this.modifyNodes[e]).component=null,this.setComponentRefs(n.obj,null),this.removeFromArray(t.nodes,n);var s=new this.klass.GraphComponent;if(this.searchSingle(this.modifyNodes[0],s),s.nodes.length===this.modifyNodes.length){for(var n,e=0;e<this.modifyNodes.length;e++)((n=this.modifyNodes[e]).component=t).nodes.push(n);this.modifyNodes=[],this.setComponentInfo(t),t.isremake=!1}},remakeMaximalComponents:function(t){for(var e=this.coloring?this.getLongColor(t):null,i=0;i<t.length;i++)this.deleteComponent(t[i]);var s=this.searchGraph();this.coloring&&this.setLongColor(s,e)},searchGraph:function(){for(var t=this.modifyNodes,e=[],i=0,s=t.length;i<s;i++)t[i].component=null;for(var n,i=0,s=t.length;i<s;i++)null===t[i].component&&(n=this.createComponent(),this.searchSingle(t[i],n),this.setComponentInfoExtra(n,!1),e.push(n));this.modifyNodes=[];for(i=0;i<e.length;i++)this.setExtraData(e[i]);return e},searchSingle:function(t,e){for(var i=[t];0<i.length;){var s=i.pop();if(null===s.component){(s.component=e).nodes.push(s);for(var n=0;n<s.nodes.length;n++)i.push(s.nodes[n])}}},setComponentInfo:function(t){this.setComponentInfoExtra(t,!0)},setComponentInfoExtra:function(t,e){for(var i=0,s=0;s<t.nodes.length;s++){var n=t.nodes[s];i+=n.nodes.length,this.setComponentRefs(n.obj,t)}t.circuits=(i>>1)-t.nodes.length+1,e&&this.setExtraData(t)},resetExtraData:function(t){},setExtraData:function(t){},getLargeComponent:function(t){if(0===t.length)return null;for(var e=t[0],i=e.isTrial(),s=1;s<t.length;s++){var n=t[s],r=n.isTrial();r===i?e.nodes.length<n.nodes.length&&(e=n,i=r):r||(e=n,i=r)}return e},getLongColor:function(t){t=this.getLargeComponent(t);return t?t.color:null},setLongColor:function(t,e){var i,s;0!==t.length&&e&&(i=this.puzzle,(s=this.getLargeComponent(t))&&(s.color=e),this.coloring&&(i.execConfig("irowake")||i.execConfig("irowakeblk"))&&this.repaintNodes(t))},repaintNodes:function(t){},newIrowake:function(){for(var t=this.components,e=t.length,i=360*Math.random(),s=360/e,n=60+40*this.puzzle.painter.maxYdeg,r=60+40*this.puzzle.painter.minYdeg,o=0;o<e;o++){var a=(i+o*s)%360,h=o%3*(n-r)/2+r,l=52*Math.random()+75,c=Math.sin(a*Math.PI/180)*l,a=Math.cos(a*Math.PI/180)*l;t[o].color=this.puzzle.painter.labToRgbStr(h,c,a)}for(o=e-1;0<o;o--){var u=Math.floor(Math.random()*(o+1)),d=t[o].color;t[o].color=t[u].color,t[u].color=d}}},GraphComponent:{initialize:function(){this.nodes=[],this.color="",this.circuits=-1},getLinkObjByNodes:function(t,e){var i=t.obj.bx,t=t.obj.by,s=e.obj.bx,e=e.obj.by;return s<i||i===s&&e<t?null:this.board.getobj(i+s>>1,t+e>>1)},getnodeobjs:function(){for(var t=new(this.board.getGroup(this.nodes[0].obj.group).constructor),e=0;e<this.nodes.length;e++)t.add(this.nodes[e].obj);return t},getedgeobjs:function(){for(var t=[],e=0;e<this.nodes.length;e++)for(var i=this.nodes[e],s=0;s<i.nodes.length;s++){var n=this.getLinkObjByNodes(i,i.nodes[s]);n&&t.push(n)}return t},checkAutoCmp:function(){var t=!!this.clist.checkCmp&&this.clist.checkCmp();this.cmp!==t&&(this.cmp=t,this.puzzle.execConfig("autocmp")&&this.clist.draw())},isTrial:function(){for(var t=this.getedgeobjs(),e=0;e<t.length;e++)if(!t[e].trial)return!1;return!0},setedgeerr:function(t){for(var e=this.getedgeobjs(),i=0;i<e.length;i++)e[i].seterr(t)},setedgeinfo:function(t){for(var e=this.getedgeobjs(),i=0;i<e.length;i++)e[i].setinfo(t)}},GraphNode:{initialize:function(t){this.obj=t,this.nodes=[],this.component=null}}}),p.classmgr.makeCommon({"LineGraph:GraphBase":{initialize:function(){this.moveline&&(this.relation["cell.qnum"]="move")},enabled:!1,relation:{"border.line":"link"},pointgroup:"cell",linkgroup:"border",countprop:"lcnt",isLineCross:!1,makeClist:!1,moveline:!1,coloring:!0,setComponentRefs:function(t,e){t.path=e},isedgeexistsbylinkobj:function(t){return null!==t.path},getObjNodeList:function(t){return t.pathnodes},resetObjNodeList:function(t){t.pathnodes=[],this.moveline&&this.resetExtraData(t)},isnodevalid:function(t){return 0<t[this.countprop]||this.moveline&&t.isNum()},isedgevalidbylinkobj:function(t){return t.isLine()},iscrossing:function(t){return this.isLineCross},rebuild:function(){this.board.borderAsLine&&(this.pointgroup="cross"),p.common.GraphBase.prototype.rebuild.call(this)},rebuild2:function(){this.incdecLineCount&&this.resetLineCount(),p.common.GraphBase.prototype.rebuild2.call(this)},resetLineCount:function(){var t=this.board[this.pointgroup],e=this.board[this.linkgroup];this.ltotal=[t.length];for(var i=0;i<t.length;i++)t[i][this.countprop]=0;for(var s=0;s<e.length;s++)this.isedgevalidbylinkobj(e[s])&&this.incdecLineCount(e[s],!0)},incdecLineCount:function(t,e){if(t.group===this.linkgroup)for(var i=0;i<2;i++){var s=t.sideobj[i];s.isnull||(this.ltotal[s[this.countprop]]--,e?s[this.countprop]++:s[this.countprop]--,this.ltotal[s[this.countprop]]=(this.ltotal[s[this.countprop]]||0)+1)}},setEdgeByLinkObj:function(t){var e=this.isedgevalidbylinkobj(t);e!==this.isedgeexistsbylinkobj(t)&&(this.incdecLineCount&&this.incdecLineCount(t,e),e?this.addEdgeByLinkObj(t):this.removeEdgeByLinkObj(t))},addEdgeByLinkObj:function(t){var e,i=0===this.modifyNodes.length,s=this.getSideObjByLinkObj(t),s=(this.createNodeIfEmpty(s[0]),this.createNodeIfEmpty(s[1]),this.getSideNodesByLinkObj(t));this.addEdge(s[0],s[1]),!this.rebuildmode&&i&&(t=null,i=s[0],e=s[1],1===i.obj[this.countprop]&&null===i.component&&null!==e.component?t=[s[0],s[1]]:1===e.obj[this.countprop]&&null===e.component&&null!==i.component&&(t=[s[1],s[0]]),t&&(this.attachNode(t[0],t[1].component),this.modifyNodes=[]))},removeEdgeByLinkObj:function(t){var e,i,s,n=0===this.modifyNodes.length,r=this.getSideNodesByLinkObj(t);this.removeEdge(r[0],r[1]),this.deleteNodeIfEmpty(r[0].obj),this.deleteNodeIfEmpty(r[1].obj),this.setComponentRefs(t,null),n&&(t=null,n=r[0],e=r[1],i=n.obj[this.countprop],s=e.obj[this.countprop],0===i&&(1===s||!this.isLineCross&&1<s)&&null!==e.component?t=[r[0],r[1]]:0===s&&(1===i||!this.isLineCross&&1<i)&&null!==n.component&&(t=[r[1],r[0]]),t&&(this.setComponentInfo(t[1].component),this.modifyNodes=[]))},modifyOtherInfo:function(t,e){var i=!!t.path;i!==this.isnodevalid(t)?i?this.deleteNodeIfEmpty(t):this.createNodeIfEmpty(t):i?this.setComponentInfo(t.path):this.resetExtraData(t)},usesSecondNode:function(t,e){return t.getvert(e,2)},createNodeIfEmpty:function(t){var e,i,s,n=this.getObjNodeList(t);0===n.length?this.createNode(t):!n[1]&&2===n[0].nodes.length&&this.iscrossing(t)&&(s=n[0].nodes,(e=[this.usesSecondNode(t,s[0].obj),this.usesSecondNode(t,s[1].obj)])[0]!==e[1]?(i=s[e[0]?0:1],s=s[e[0]?1:0],this.removeEdge(n[0],i),this.removeEdge(n[0],s),this.deleteNode(n[0]),this.createNode(t),this.createNode(t),this.addEdge(n[0],i),this.addEdge(n[1],s)):(this.createNode(t),e[0]===e[1]&&e[0]===this.board.borderAsLine&&n.push(n.shift())))},deleteNodeIfEmpty:function(t){var e=this.getObjNodeList(t);1!==e.length||0!==e[0].nodes.length||this.isnodevalid(t)?e[1]&&e[0].nodes.length+e[1].nodes.length===2&&this.iscrossing(t)&&(1===e[1].nodes.length?(t=e[1].nodes[0],this.removeEdge(e[1],t),this.addEdge(e[0],t)):2===e[1].nodes.length&&e.push(e.shift()),this.deleteNode(e[1])):this.deleteNode(e[0])},resetExtraData:function(t){this.moveline&&(t.base=t.isNum()?t:this.board.emptycell)},setExtraData:function(t){this.coloring&&!t.color&&(t.color=this.puzzle.painter.getNewLineColor());for(var e=t.getedgeobjs(),i=0;i<e.length;i++)this.setComponentRefs(e[i],t);(this.makeClist||this.moveline)&&(t.clist=new this.klass.CellList(t.getnodeobjs()),this.moveline&&this.setMovedBase(t))},repaintNodes:function(t){for(var e=new this.klass.BorderList,i=0;i<t.length;i++)e.extend(t[i].getedgeobjs());this.puzzle.painter.repaintLines(e)},setMovedBase:function(t){var e=this.board.emptycell,i=(t.departure=t.destination=e,t.movevalid=!1,t.clist);if(!(i.length<1)){for(var s=!1,n=0;n<i.length;n++)(h=i[n]).base=h.isNum()?h:e,-1===h.anum&&h.isNum()&&(s=!0);var r=null,o=null,a=0;if(1===i.length)r=o=i[0],a=2;else for(var h,n=0;n<i.length;n++)1===(h=i[n])[this.countprop]&&(a++,!h.isNum()||-1!==h.anum&&s?o=h:r=h);null!==r&&null!==o&&2===a&&(r.base=e,t.departure=o.base=r,t.destination=o,t.movevalid=!0)}}}}),p.classmgr.makeCommon({"AreaGraphBase:GraphBase":{pointgroup:"cell",countprop:"lcnt",isedgevalidbynodeobj:function(t,e){return this.isedgevalidbylinkobj(this.board.getb(t.bx+e.bx>>1,t.by+e.by>>1))},setEdgeByNodeObj:function(t){0<this.getObjNodeList(t).length&&this.removeEdgeByNodeObj(t),0<this.calcNodeCount(t)&&this.addEdgeByNodeObj(t)},removeEdgeByNodeObj:function(t){for(var e=this.getSideObjByNodeObj(t),i=this.getObjNodeList(t)[0],t=i.nodes.length,s=i.component,n=0===this.modifyNodes.length,r=0;r<e.length;r++){var o=this.getObjNodeList(e[r])[0];i&&o&&(this.removeEdge(i,o),this.incdecBorderCount&&this.incdecBorderCount(this.board.getb(i.obj.bx+o.obj.bx>>1,i.obj.by+o.obj.by>>1),!0))}i&&this.deleteNode(i),!this.rebuildmode&&1===t&&n&&(this.setComponentInfo(s),this.modifyNodes=[])},addEdgeByNodeObj:function(t){for(var e=0,i=this.calcNodeCount(t);e<i;e++)this.createNode(t);for(var s,n=this.getSideObjByNodeObj(t),r=this.getObjNodeList(t)[0],o=0===this.modifyNodes.length,e=0;e<n.length;e++)this.isedgevalidbynodeobj(t,n[e])&&(s=this.getObjNodeList(n[e])[0],r&&s&&(this.addEdge(r,s),this.incdecBorderCount&&this.incdecBorderCount(this.board.getb(r.obj.bx+s.obj.bx>>1,r.obj.by+s.obj.by>>1),!1)));!this.rebuildmode&&1===r.nodes.length&&o&&(this.attachNode(r,r.nodes[0].component),this.modifyNodes=[])},setExtraData:function(t){t.nodes.length?t.clist=new this.klass.CellList(t.getnodeobjs()):t.clist=new this.klass.CellList}},"AreaShadeGraph:AreaGraphBase":{relation:{"cell.qans":"node"},setComponentRefs:function(t,e){t.sblk=e},getObjNodeList:function(t){return t.sblknodes},resetObjNodeList:function(t){t.sblknodes=[]},isnodevalid:function(t){return t.isShade()},setExtraData:function(t){t.clist=new this.klass.CellList(t.getnodeobjs()),this.coloring&&!t.color&&(t.color=this.puzzle.painter.getNewLineColor())},repaintNodes:function(t){for(var e=new this.klass.CellList,i=0;i<t.length;i++)e.extend(t[i].getnodeobjs());this.puzzle.painter.repaintBlocks(e)}},"AreaUnshadeGraph:AreaGraphBase":{relation:{"cell.qans":"node"},getComponentRefs:function(t){return t.ublk},setComponentRefs:function(t,e){t.ublk=e},getObjNodeList:function(t){return t.ublknodes},resetObjNodeList:function(t){t.ublknodes=[]},isnodevalid:function(t){return t.isUnshade()}},"AreaNumberGraph:AreaGraphBase":{relation:{"cell.qnum":"node","cell.anum":"node","cell.qsub":"node"},setComponentRefs:function(t,e){t.nblk=e},getObjNodeList:function(t){return t.nblknodes},resetObjNodeList:function(t){t.nblknodes=[]},isnodevalid:function(t){return t.isNumberObj()}},"AreaRoomGraph:AreaGraphBase":{relation:{"cell.ques":"node","border.ques":"separator","border.qans":"separator"},hastop:!1,getComponentRefs:function(t){return t.room},setComponentRefs:function(t,e){t.room=e},getObjNodeList:function(t){return t.roomnodes},resetObjNodeList:function(t){t.roomnodes=[]},isnodevalid:function(t){return 7!==t.ques},isedgevalidbylinkobj:function(t){return!t.isBorder()},rebuild2:function(){this.klass.AreaGraphBase.prototype.rebuild2.call(this),this.resetBorderCount()},resetBorderCount:function(){for(var t=this.board,e=t.border,i=0;i<t.cross.length;i++){var s=t.cross[i],n=s.bx,r=s.by,n=1===t.hasborder&&(0===n||n===2*t.cols||0===r||r===2*t.rows);s[this.countprop]=n?2:0}for(var o=0;o<e.length;o++)this.isedgevalidbylinkobj(e[o])||this.incdecBorderCount(e[o],!0)},incdecBorderCount:function(t,e){for(var i=0;i<2;i++){var s=t.sidecross[i];s.isnull||(e?s[this.countprop]++:s[this.countprop]--)}},addEdgeBySeparator:function(t){t=this.getSideNodesBySeparator(t);t&&(this.addEdge(t[0],t[1]),this.hastop&&2<=t.length&&this.setTopOfRoom_combine(t[0].obj,t[1].obj))},setTopOfRoom_combine:function(t,e){var i;t.room&&e.room&&t.room!==e.room&&(t=t.room.top,e=e.room.top,e=t.bx>e.bx||t.bx===e.bx&&t.by>e.by?(i=t,e):(i=e,t),i.isNum()&&(e.noNum()&&(e.setQnum(i.qnum),e.draw()),i.setQnum(-1),i.draw()))},setExtraData:function(t){var e=t.clist=new this.klass.CellList(t.getnodeobjs());if(this.hastop&&(t.top=e.getTopCell(),this.rebuildmode)){for(var i=-1,s=t.top,n=0,r=e.length;n<r;n++){var o=e[n];o.room===t&&-1!==o.qnum&&(-1===i&&(i=o.qnum),s!==o&&(o.qnum=-1))}-1!==i&&-1===s.qnum&&(s.qnum=i)}this.puzzle.validConfig("autocmp")&&t.checkAutoCmp()},getSideAreaInfo:function(){for(var t=[],e=this.components.length,i={},s=this.board,n=0;n<this.components.length;n++)this.components[n].id=n;for(var r=0;r<s.border.length;r++){var o,a=this.getComponentRefs(s.border[r].sidecell[0]),h=this.getComponentRefs(s.border[r].sidecell[1]);a!==h&&a&&h&&(i[o=a.id<h.id?a.id*e+h.id:h.id*e+a.id]||(i[o]=!0,t.push([a,h])))}return t}}}),p.classmgr.makeCommon({Graphic:{initialize:function(){this.gridcolor=this.gridcolor_list[this.gridcolor_type]||this.gridcolor;var e=this;[["getQuesCellColor",this.fgcellcolor_func],["getBGCellColor",this.bgcellcolor_func],["getBorderColor",this.bordercolor_func],["getQuesNumberColor",this.numbercolor_func],["getCircleFillColor",this.circlefillcolor_func],["getCircleStrokeColor",this.circlestrokecolor_func]].forEach(function(t){e[t[0]]===p.common.Graphic.prototype[t[0]]&&(e[t[0]]=e[t[0]+"_"+t[1]]||e[t[0]])}),this.resetRange(),this.initFont()},context:null,subcontext:null,fgcellcolor_func:"ques",bgcellcolor_func:"error1",bordercolor_func:"ques",numbercolor_func:"mixed",circlefillcolor_func:"qnum",circlestrokecolor_func:"qnum",quescolor:"black",qanscolor:"rgb(0, 160, 0)",qcmpcolor:"silver",qcmpbgcolor:"rgb(224, 224, 255)",trialcolor:"rgb(160, 160, 160)",subcolor:"rgb(127, 127, 255)",subshadecolor:"rgb(220, 220, 255)",shadecolor:"black",errcolor1:"rgb(192, 0, 0)",errcolor2:"rgb(32, 32, 255)",fontShadecolor:"rgb(224, 224, 224)",enablebcolor:!1,bcolor:"rgb(160, 255, 160)",errbcolor1:"rgb(255, 160, 160)",errbcolor2:"rgb(64, 255, 64)",qsubcolor1:"rgb(160,255,160)",qsubcolor2:"rgb(255,255,127)",qsubcolor3:"rgb(192,192,192)",icecolor:"rgb(192, 224, 255)",erricecolor:"rgb(224,  96, 160)",circlebasecolor:"white",mbcolor:"rgb(0, 160, 0)",linecolor:"rgb(0, 160, 0)",errlinecolor:"rgb(255, 0, 0)",noerrcolor:"rgb(160, 160, 160)",linetrialcolor:"rgb(160, 160, 160)",movelinecolor:"silver",movetrialcolor:"rgb(255, 160, 0)",pekecolor:"rgb(0, 127, 0)",bbcolor:"rgb(160, 160, 160)",targetColorEdit:"rgb(255, 64,  64)",targetColorPlay:"rgb(64,  64, 255)",targetColorTrial:"rgb(255,  64, 255)",ttcolor:"rgb(127,255,127)",ttshadecolor:"rgb(0,127,0)",movecolor:"red",gridcolor:"black",gridcolor_type:"",gridcolor_list:{DARK:"rgb( 48,  48,  48)",LIGHT:"rgb(127, 127, 127)",DLIGHT:"rgb(160, 160, 160)",SLIGHT:"rgb(191, 191, 191)",THIN:"rgb(224, 224, 224)"},bgcolor:"white",textoption:null,fontsizeratio:.8,fontwidth:[.5,.4,.33],fontfamily:"",isSupportMaxWidth:!0,crosssize:.4,circleratio:[.4,.35],margin:.15,bankratio:.5,bankVerticalOffset:.5,canvasWidth:null,canvasHeight:null,x0:0,y0:0,basex0:0,basey0:0,cw:36,ch:36,bw:18,bh:18,devicePixelRatio:1,gw:1,lw:1,lwmin:3,lm:1,lwratio:10,addlw:0,lastHdeg:0,lastYdeg:0,minYdeg:.18,maxYdeg:.7,range:null,useBuffer:!1,outputImage:!1,showBank:!0,pendingResize:!1,suspended:!0,suspendedAll:!0,hideHatena:!1,autocmp:"",irowake:!1,irowakeblk:!1,initCanvas:function(){var t,e=this.puzzle;(this.context=e.canvas?e.canvas.getContext("2d"):null).use.canvas&&(this.subcontext=e.subcanvas?e.subcanvas.getContext("2d"):null,this.useBuffer=!!this.subcontext),null!==this.canvasWidth&&null!==this.canvasHeight||(t=p.util.getRect(e.canvas),this.resizeCanvas(t.width,t.height)),this.pendingResize=!0,this.resize_canvas_main(),e.emit("canvasReady"),this.unsuspend()},initFont:function(){var t=1===this.puzzle.getConfig("font");this.puzzle.pzpr.env.OS.Android?this.fontfamily=t?"Helvetica, Verdana, Arial, ":'"Times New Roman", ':this.fontfamily="",this.fontfamily+=t?"sans-serif":"serif"},cellexpandratio:1,resizeCanvas:function(t,e){var i=this.suspended;this.suspendAll(),this.canvasWidth=t||this.canvasWidth,this.canvasHeight=e||this.canvasHeight,this.pendingResize=!0,i||this.unsuspend()},resizeCanvasByCellSize:function(t,e){var i=this.suspended;this.suspendAll(),t&&(this.cw=t*(e?1:this.cellexpandratio),this.ch=t*(e?1:this.cellexpandratio)),this.canvasWidth=this.cw*this.getCanvasCols(),this.canvasHeight=this.ch*this.getCanvasRows(),this.pendingResize=!0,i||this.unsuspend()},resize_canvas_main:function(){this.pendingResize&&(this.pendingResize=!1,this.setParameter(),this.setOffset(),this.puzzle.emit("resize"),this.clearObject())},setParameter:function(){var t=this.canvasWidth,e=this.canvasHeight,t=t/this.getCanvasCols()|0,e=e/this.getCanvasRows()|0,t=(this.devicePixelRatio=this.puzzle.pzpr.env.browser&&window.devicePixelRatio||1,this.puzzle.getConfig("squarecell")?this.cw=this.ch=Math.min(t,e):(this.cw=t,this.ch=e),this.bw=this.cw/2,this.bh=this.ch/2,Math.min(this.cw/40,1)),e=1/this.devicePixelRatio,t=Math.max(1,Math.round(t/e)),t=(this.gw=t*e,Math.max(this.cw/this.lwratio,this.lwmin)),t=Math.max(1,Math.round(t/e));this.lw=t*e,this.lm=this.lw/2},setOffset:function(){var t=this.context,e=this.subcontext,i=this.canvasWidth,s=this.canvasHeight,i=(t.changeSize(0|i,0|s),e&&e.changeSize(0|i,0|s),(this.x0=.5+((i-this.cw*this.getBoardCols())/2+this.cw*this.getOffsetCols()|0))+this.basex0),s=(this.y0=.5+((s-this.ch*this.getBoardRows())/2+this.ch*this.getOffsetRows()|0))+this.basey0;t.use.canvas?(t.translate(i,s),e&&e.translate(i,s)):(e=p.util.getRect(t.canvas),t.translate(i-e.left%1,s-e.top%1))},clearObject:function(){this.context.clear()},getCanvasCols:function(){return this.getBoardCols()+2*this.margin},getCanvasRows:function(){var t=this.getBoardRows()+2*this.margin;return this.board.bank&&this.showBank&&(t+=this.board.bank.height*this.bankratio+1/16),t},getBoardCols:function(){var t=this.board;return(t.maxbx-t.minbx)/2},getBoardRows:function(){var t=this.board;return(t.maxby-t.minby)/2},getOffsetCols:function(){return(0-this.board.minbx)/2},getOffsetRows:function(){var t=(0-this.board.minby)/2;return this.board.bank&&this.showBank&&(t-=this.board.bank.height*this.bankratio/2),t},suspend:function(){this.suspended=!0},suspendAll:function(){this.suspendedAll=!0,this.suspended=!0},unsuspend:function(){var t;this.context&&(this.resize_canvas_main(),this.suspendedAll&&(t=this.board,this.range.bank=!0,this.setRange(t.minbx-2,t.minby-2,t.maxbx+2,t.maxby+2),this.suspendedAll=!1),this.suspended&&(this.suspended=!1,this.prepaint()))},prepaint:function(){var t,e,i,s,n,r;!this.suspended&&this.context&&(this.isSupportMaxWidth=this.context.use.svg&&p.env.API.svgTextLength||this.context.use.canvas&&p.env.API.maxWidth,n=this.board,r=2*this.margin,t=this.range.x1,e=this.range.y1,i=this.range.x2,s=this.range.y2,(this.showBank&&(this.range.bank||0<this.range.bankPieces.length)||!(i<t||s<e||t>=n.maxbx+r||e>=n.maxby+r||i<=n.minbx-r||s<=n.minby-(r+("starbattle"===this.pid?2:0))))&&(this.useBuffer?(n=this.context,r=this.subcontext,this.context=r,this.setRangeObject(t-1,e-1,i+1,s+1),this.flushCanvas(),this.paintMain(),this.context=n,this.copyBufferData(n,r,t,e,i,s)):(this.setRangeObject(t,e,i,s),this.flushCanvas(),this.paintMain())),this.resetRange())},paintMain:function(){this.paint(),this.paintPost()},paint:function(){},paintPost:function(){},setRange:function(t,e,i,s){this.range.x1>t&&(this.range.x1=t),this.range.y1>e&&(this.range.y1=e),this.range.x2<i&&(this.range.x2=i),this.range.y2<s&&(this.range.y2=s)},setRangeObject:function(t,e,i,s){var n=this.board;this.range.cells=n.cellinside(t,e,i,s),this.range.crosses=n.crossinside(t,e,i,s),this.range.borders=n.borderinside(t,e,i,s),this.range.excells=n.excellinside(t,e,i,s)},resetRange:function(){var t=this.puzzle,e=t.board,t=t.klass;this.range={x1:e.maxbx+1,y1:e.maxby+1,x2:e.minbx-1,y2:e.minby-1,cells:new t.CellList,crosses:new t.CrossList,borders:new t.BorderList,excells:new t.ExCellList,bank:!1,bankPieces:[]}},copyBufferData:function(t,e,i,s,n,r){i=this.x0+i*this.bw-1,s=this.y0+s*this.bh-1,n=this.x0+n*this.bw+2,r=this.y0+r*this.bh+2;n>e.child.width&&(n=e.child.width),r>e.child.height&&(r=e.child.height),t.drawImage(e.child,i=i<0?0:i,s=s<0?0:s,n-i,r-s,i-this.x0,s-this.y0,n-i,r-s)},paintRange:function(t,e,i,s){this.setRange(t,e,i,s),this.prepaint()},paintAll:function(){this.suspended&&(this.suspendedAll=!0);var t=this.board;this.range.bank=!0,this.paintRange(t.minbx-2,t.minby-2,t.maxbx+2,t.maxby+2)},labToRgbStr:function(t,e,i){function s(t){return 6/29<t?Math.pow(t,3):3*Math.pow(6/29,2)*(t-4/29)}var t=(t+16)/116,e=95.0489*s(t+e/500),n=100*s(t),t=108.884*s(t-i/500),i=2.041369*e-.5649464*n-.3446944*t,r=-.969266*e+1.8760108*n+.041556*t,e=.0134474*e-.1183897*n+1.0154096*t;return"rgb("+(0|Math.max(Math.min(2.55*i,255),0))+","+(0|Math.max(Math.min(2.55*r,255),0))+","+(0|Math.max(Math.min(2.55*e,255),0))+")"},getNewLineColor:function(){var t=60+40*this.puzzle.painter.maxYdeg,e=60+40*this.puzzle.painter.minYdeg,t=Math.random()*(t-e)+e,e=(void 0===this.currentColorTheta?this.currentColorTheta=360*Math.random():this.currentColorTheta+=137.28,52*Math.random()+75),i=Math.sin(this.currentColorTheta*Math.PI/180)*e,e=Math.cos(this.currentColorTheta*Math.PI/180)*e;return this.labToRgbStr(t,i,e)},repaintBlocks:function(t){t.draw()},repaintLines:function(t){this.range.borders=t,this.drawLines(),this.context.use.canvas&&this.repaintParts(t)},repaintParts:function(t){},flushCanvas:function(){var t=this.vinc("background","crispEdges",!0),e=this.bw,i=this.bh,s=.15<this.margin?this.margin:0,n=this.board,r=n.minbx-s,o=n.minby-s,a=n.maxbx+s-r,n=n.maxby+s-o;t.vid="BG",t.fillStyle=this.bgcolor,t.fillRect(r*e-.5,o*i-.5,a*e+1,n*i+1)},vinc:function(t,e,i){var s=this.context,i={freeze:!!i};return i.rendering=e,s.setLayer(t,i),s},CENTER:1,BOTTOMLEFT:2,BOTTOMRIGHT:3,TOPRIGHT:4,TOPLEFT:5,UP:6,DN:7,RT:9,LT:8,disptext:function(t,e,i,s){var n=this.context,r=this.cw*((s=s||{}).ratio||this.fontsizeratio)|0,o=void 0,a=s.width||this.fontwidth,h=t.length<=a.length+1?t.length-2:a.length-1,a=0<=h?a[h]*t.length:null,h=(this.isSupportMaxWidth?o=a?r*a:void 0:a&&(r=r*a*1.5/t.length|0),s.style?s.style+" ":""),l=(n.font=h+r+"px "+this.fontfamily,this.bw*(s.hoffset||.9)),c=this.bh*(s.voffset||.82),a=s.position||1;switch(a){case 1:case 6:case 7:n.textAlign="center";break;case 2:case 5:case 8:n.textAlign="left",e-=l;break;case 3:case 4:case 9:n.textAlign="right",e+=l}switch(a){case 1:case 8:case 9:n.textBaseline="middle";break;case 4:case 5:case 6:n.textBaseline="candle-top",i-=c;break;case 3:case 2:case 7:n.textBaseline="alphabetic",i+=c}n.fillText(t,e,i,o)}},ImageTile:{cols:1,rows:1,width:0,height:0,initialize:function(){var t=this.puzzle;"undefined"!=typeof Image?(this.image_canvas=this.image_svg=new Image,this.image_canvas.onload=function(){t.painter.paintAll()}):(this.image_canvas=t.pzpr.Candle.Canvas?new t.pzpr.Candle.Canvas.Image:{},this.image_svg={}),this.image_canvas.src=this.image_svg.src=this.imgsrc_dataurl,this.image_canvas.height=this.image_svg.height=this.height,this.image_canvas.width=this.image_svg.width=this.width,this.cwidth=this.image_canvas.width/this.cols,this.cheight=this.image_canvas.height/this.rows,this.loaded=!0},putImage:function(t,e,i,s,n,r,o){var a=t.use.canvas?this.image_canvas:this.image_svg,h=this.cwidth,l=this.cheight,c=h*(i%this.cols),u=l*(i/this.cols|0);void 0===r&&(r=h,o=l),t.vid=e,t.drawImage(null!==i?a:null,c,u,h,l,s,n,r,o)}}}),p.classmgr.makeCommon({MouseEvent:{initialize:function(){this.cursor=this.puzzle.cursor,this.enableMouse=!0,this.mouseCell=null,this.firstCell=null,this.inputPoint=new this.klass.RawAddress,this.firstPoint=new this.klass.RawAddress,this.prevPos=new this.klass.Address,this.btn="",this.inputData=null,this.firstState=null,this.bordermode=!1,this.mousestart=!1,this.mousemove=!1,this.mouseend=!1,this.inputMode="auto",this.savedInputMode={edit:"auto",play:"auto"},this.mousereset()},RBShadeCell:!1,use:!1,bgcolor:!1,inputMode:"auto",savedInputMode:{},inputModes:{edit:[],play:[]},inversion:!1,mousereset:function(){var t=this.mouseCell,e=(this.mouseCell=this.firstCell=this.board.emptycell,this.firstPoint.reset(),this.prevPos.reset(),this.btn="",this.inputData=null,this.bordermode=!1,this.mousestart=!1,this.mousemove=!1,this.mouseend=!1,this);[["mouseinputAutoEdit",this.autoedit_func],["mouseinputAutoPlay",this.autoplay_func]].forEach(function(t){e[t[0]]===p.common.MouseEvent.prototype[t[0]]&&(e[t[0]]=e[t[0]+"_"+t[1]]||e[t[0]])}),this.puzzle.execConfig("dispmove")&&t&&!t.isnull&&t.draw()},modechange:function(){this.mousereset(),this.inputMode=this.savedInputMode[this.puzzle.editmode?"edit":"play"]},e_mousedown:function(t){if(!this.enableMouse)return!0;var e;this.setMouseButton(t),this.btn?(e=this.getBoardAddress(t),this.moveTo(e.bx,e.by),t.stopPropagation(),t.preventDefault()):this.mousereset()},e_mouseup:function(t){if(!this.enableMouse||!this.btn)return!0;this.inputEnd(),t.stopPropagation(),t.preventDefault()},e_mousemove:function(t){if(!this.enableMouse||!this.btn)return!0;var e;void 0!==t.touches||void 0===t.which||0!==t.which||t.type.match(/pointermove/i)&&0<t.buttons?(e=this.getBoardAddress(t),this.lineTo(e.bx,e.by)):this.mousereset(),t.stopPropagation(),t.preventDefault()},e_mousecancel:function(t){this.mousereset()},setMouseButton:function(t){this.btn=p.util.getMouseButton(t);var e=this.puzzle.key;e.checkmodifiers(t),((e.isSHIFT||e.isMETA)!==this.inversion||this.inputMode&&this.inputMode.indexOf("-")===this.inputMode.length-1)&&("left"===this.btn?this.btn="right":"right"===this.btn&&(this.btn="left"))},getBoardAddress:function(t){var e,i=this.puzzle.painter,s={px:NaN,py:NaN};return i.context?{bx:((s=!p.env.API.touchevent||p.env.API.pointerevent||p.env.OS.iOS?isNaN(t.offsetX)?{px:t.layerX,py:t.layerY}:{px:t.offsetX,py:t.offsetY}:(t=p.util.getPagePos(t),e=p.util.getRect(i.context.child),{px:t.px-e.left,py:t.py-e.top})).px-i.x0)/i.bw,by:(s.py-i.y0)/i.bh}:s},moveTo:function(t,e){this.inputPoint.init(t,e),this.mouseevent(0)},lineTo:function(t,e){for(var i=t-this.inputPoint.bx,s=e-this.inputPoint.by,n=2*((0<=i?i:-i)+(0<=s?s:-s))+.9|0,r=i/n,o=s/n,a=0;a<n-1;a++)this.inputPoint.move(r,o),this.mouseevent(1);this.inputPoint.init(t,e),this.mouseevent(1)},inputEnd:function(){this.mouseevent(2),this.mousereset()},inputPath:function(){var t=Array.prototype.slice.call(arguments);this.mousereset(),this.btn="string"==typeof t[0]?t.shift():"left",this.moveTo(t[0],t[1]);for(var e=2;e<t.length-1;e+=2)this.lineTo(t[e],t[e+1]);this.inputEnd()},mouseevent:function(t){this.cancelEvent=!1,this.mousestart=0===t,this.mousemove=1===t,this.mouseend=2===t;t=this.puzzle;t.emit("mouse"),this.cancelEvent||"left"!==this.btn&&"right"!==this.btn||(this.mousestart?(t.opemgr.newOperation(),t.errclear(),t.opemgr.updateStarts()):t.opemgr.newChain(),this.mouseinput())},mouseinput:function(){var t,e,i=this.inputMode;switch(this.puzzle.key.isZ&&-1===this.inputMode.indexOf(/info\-/)&&(t=0<=this.inputModes.play.indexOf("info-ublk"),0<=this.inputModes.play.indexOf("info-line")?i="info-line":0<=this.inputModes.play.indexOf("info-blk")?(e=this.getcell(),i=t&&e.isUnshade()?"info-ublk":"info-blk"):t?i="info-ublk":0<=this.inputModes.play.indexOf("info-room")&&(i="info-room")),i){case"auto":this.mouseinput_auto();break;case"number":case"number-":this.mouseinput_number();break;case"clear":this.mouseinput_clear();break;case"cell51":this.input51_fixed();break;case"circle-unshade":this.inputFixedNumber(1);break;case"circle-shade":this.inputFixedNumber(2);break;case"undef":this.inputFixedNumber(-2);break;case"ice":this.inputIcebarn();break;case"numexist":this.inputFixedNumber(-2);break;case"numblank":this.inputFixedNumber(-3);break;case"bgcolor":this.inputBGcolor();break;case"subcircle":case"bgcolor1":this.inputFixedQsub(1);break;case"subcross":case"bgcolor2":this.inputFixedQsub(2);break;case"completion":this.mousestart&&this.inputqcmp();break;case"objblank":this.inputDot();break;case"direc":this.inputdirec();break;case"arrow":this.inputarrow_cell();break;case"crossdot":this.mousestart&&this.inputcrossMark();break;case"border":this.inputborder();break;case"subline":this.inputQsubLine();break;case"shade":case"unshade":this.inputShade();break;case"line":this.inputLine();break;case"peke":this.inputpeke();break;case"bar":this.inputTateyoko();break;case"empty":this.inputempty();break;case"info-line":this.mousestart&&this.dispInfoLine();break;case"info-blk":this.mousestart&&this.dispInfoBlk();break;case"info-ublk":this.mousestart&&this.dispInfoUblk();break;case"info-room":this.mousestart&&this.dispInfoRoom();break;default:this.mouseinput_other()}},mouseinput_number:function(){this.mousestart&&this.inputqnum()},mouseinput_clear:function(){this.inputclean_cell()},mouseinput_auto:function(){this.puzzle.playmode?this.mouseinputAutoPlay():this.puzzle.editmode&&this.mouseinputAutoEdit()},mouseinputAutoEdit:function(){},mouseinputAutoPlay:function(){},autoedit_func:"",autoplay_func:"",mouseinput_other:function(){},notInputted:function(){return!this.puzzle.opemgr.changeflag},setInputMode:function(t){if(t=t||"auto",!(0<=this.getInputModeList().indexOf("number-"===t?"number":t)))throw Error("Invalid input mode :"+t);this.inputMode=t,this.savedInputMode[this.puzzle.editmode?"edit":"play"]=t,this.puzzle.redraw()},getInputModeList:function(t){if("viewer"===this.puzzle.instancetype)return[];t=t||(this.puzzle.editmode?"edit":"play");var e=["auto"];return 0<=(e=e.concat(this.inputModes[t])).indexOf("number")&&e.splice(e.indexOf("number")+1,0,"number-"),e},setInversion:function(t){this.inversion=!!t},getcell:function(){return this.getpos(0).getc()},getcell_excell:function(){var t=this.getpos(0),e=t.getex();return e.isnull?t.getc():e},getcross:function(){return this.getpos(.5).getx()},getbank:function(){var t=this.board.bank,e=this.puzzle.painter.bankratio,i=this.inputPoint.bx/(2*e),s=(this.inputPoint.by-(this.board.maxby+1))/(2*e);if(i<0||s<0)return null;for(var n=t.pieces.length,r=this.puzzle.editmode&&("function"==typeof this.allowAdd?t.allowAdd():!!t.allowAdd),o=0;o<n+(r?1:0);o++){var a=o<n?t.pieces[o]:t.addButton;if(null!==a.index&&i>=a.x-.25&&s>=a.y-.25&&i<a.x+a.w+.75&&s<a.y+a.h+.75)return a}return null},getpos:function(t){var e=this.inputPoint,i=2*t,t=2*(1-t),s=Math.min(this.board.minbx,this.board.minby),s=4+(0<=s?0:-2&-s),n=e.bx+s,e=e.by+s,r=n%2,o=e%2;return new this.klass.Address(+(i<=r)+(-2&n)+ +(t<=r)-s,+(i<=o)+(-2&e)+ +(t<=o)-s)},getcrossorcell:function(t){var e=this.inputPoint.clone(),e=(e.bx+=1,this.getDiagonalAddress(e,t,!1));return e?(--e.bx,e):this.getpos(.25)},getborder:function(t){t=this.getDiagonalAddress(this.inputPoint,t,!0);return t?t.getb():this.board.emptyborder},getDiagonalAddress:function(t,e,i){var s=1+(-2&t.bx),n=1+(-2&t.by),r=t.bx+1-s,t=t.by+1-n,o=this.board;if(i&&o.linegraph.isLineCross)if(o.borderAsLine){h=2*(.5+e);if((a=2*(.5-e))<r&&r<h&&a<t&&t<h)return null}else{var a,h=2*(1-e);if((r<(a=2*e)||h<r)&&(t<a||h<t))return null}return r<2-t?t<r?new this.klass.Address(s,n-1):new this.klass.Address(s-1,n):t<r?new this.klass.Address(1+s,n):new this.klass.Address(s,1+n)},isBorderMode:function(){return this.mousestart&&(this.bordermode=!this.getpos(.25).oncell()),this.bordermode},setcursor:function(t){var e=this.cursor.getaddr();this.cursor.setaddr(t),e.draw(),t.draw()},setcursorsnum:function(t){var e=this.cursor.getaddr(),i=(this.cursor.setaddr(t),this.inputPoint.bx),s=this.inputPoint.by,s=this.cursor.disableAnum?[5,4,2,3][2*(s=s%2|0)+(i=i%2|0)]:("factors"!==this.pid?[5,0,4,0,0,0,2,0,3]:[0,0,4,0,0,0,2,0,3])[3*(s=(s+12)%2*1.5|0)+(i=(i+12)%2*1.5|0)];this.cursor.targetdir!==s&&(this.cursor.targetdir=s),e.draw(),t.draw()}}}),p.classmgr.makeCommon({KeyEvent:{initialize:function(){this.cursor=this.puzzle.cursor,this.enableKey=!0,this.keyreset()},enablemake:!1,enableplay:!1,keyup_event:!1,keyreset:function(){this.isCTRL=!1,this.isMETA=!1,this.isALT=!1,this.isSHIFT=!1,this.isZ=!1,this.isX=!1,this.isY=!1,this.keydown=!1,this.keyup=!1,this.ca="",this.prev=null},isenablemode:function(){return this.puzzle.editmode&&this.enablemake||this.puzzle.playmode&&this.enableplay},e_keydown:function(t){var e=this.getchar(t);this.enableKey?(this.checkbutton(e,0),e&&this.keyevent(e,0),t.target!==this.puzzle.canvas&&!this.cancelDefault||(t.stopPropagation(),t.preventDefault())):t.target!==document.body||"BS"!==e&&" "!==e||(t.stopPropagation(),t.preventDefault())},e_keyup:function(t){var e=this.getchar(t);this.enableKey?(this.checkbutton(e,1),e&&this.keyevent(e,1),t.target!==this.puzzle.canvas&&!this.cancelDefault||(t.stopPropagation(),t.preventDefault())):t.target!==document.body||"BS"!==e&&" "!==e||(t.stopPropagation(),t.preventDefault())},checkmodifiers:function(t){this.isSHIFT=t.shiftKey,this.isCTRL=t.ctrlKey,this.isMETA=t.metaKey,this.isALT=t.altKey},checkbutton:function(t,e){t=t.split(/\+/).pop();"z"===t&&(this.isZ=0===e),"x"===t&&(this.isX=0===e),"y"===t&&(this.isY=0===e)},getchar:function(t){this.checkmodifiers(t);var e="",t=t.keyCode||t.charCode,t=(38===t?e="up":40===t?e="down":37===t?e="left":39===t?e="right":48<=t&&t<=57?e=(t-48).toString(36):65<=t&&t<=90?e=(t-55).toString(36):96<=t&&t<=105?e=(t-96).toString(36):112<=t&&t<=123?e="F"+(t-111).toString(10):32===t||46===t?e=" ":8===t?e="BS":109===t||189===t||173===t?e="-":106===t?e="*":107===t&&(e="+"),e?[e]:[]);return this.isMETA&&t.unshift("meta"),this.isALT&&t.unshift("alt"),this.isCTRL&&t.unshift("ctrl"),this.isSHIFT&&t.unshift("shift"),"alt+h"===(e=t.join("+"))?e="left":"alt+k"===e?e="up":"alt+j"===e?e="down":"alt+l"===e&&(e="right"),e},inputKeys:function(t){for(var e=0;e<arguments.length;e++)this.keyevent(arguments[e],0),this.keyevent(arguments[e],1)},keyevent:function(t,e){var i=this.puzzle;this.cancelEvent=!1,this.cancelDefault=!1,this.keydown=0===e,this.keyup=1===e,"BS"!==t&&" "!==t||(this.cancelDefault=!0),this.keydown?i.opemgr.newOperation():i.opemgr.newChain(),this.keydown&&!this.isZ&&(i.errclear(),i.opemgr.updateStarts()),this.keydown&&"F4"===t&&i.playeronly?i.togglePause():null===i.pausetime&&(i.emit("key",t),this.cancelEvent||this.keyexec(t)&&this.keyDispInfo(t)&&this.isenablemode()&&(this.keydown&&this.moveTarget(t)?this.cancelDefault=!0:(this.keydown||this.keyup&&this.keyup_event)&&this.keyinput(t)))},keyexec:function(t){var e=this.puzzle;return!(this.keydown&&"alt+c"===t&&!e.playeronly)||(e.setMode(e.playmode?e.MODE_EDITOR:e.MODE_PLAYER),!1)},keyDispInfo:function(t){return!0},keyinput:function(t){this.key_inputqnum(t)},moveTarget:function(t){return this.moveTCell(t)},moveTCell:function(t){return this.moveTC(t,2)},moveTCross:function(t){return this.moveTC(t,2)},moveTBorder:function(t){return this.moveTC(t,1)},moveTC:function(t,e){var i=this.cursor,s=i.getaddr(),n=!0,r=i.NDIR;switch(t){case"up":("easyasabc"===this.pid&&-1===i.by||i.by-e>=i.miny)&&(r=i.UP);break;case"down":i.by+e<=i.maxy&&(r=i.DN);break;case"left":i.bx-e>=i.minx&&(r=i.LT);break;case"right":i.bx+e<=i.maxx&&(r=i.RT);break;default:n=!1}return n&&(i.movedir(r,e),s.draw(),i.draw()),n},moveExCell:function(t){var e=this.cursor,i=e.getaddr(),s=!0,n=i.NDIR;switch(t){case"up":e.by===e.maxy&&e.minx<e.bx&&e.bx<e.maxx?e.by=e.miny:e.by>e.miny?n=i.UP:s=!1;break;case"down":e.by===e.miny&&e.minx<e.bx&&e.bx<e.maxx?e.by=e.maxy:e.by<e.maxy?n=i.DN:s=!1;break;case"left":e.bx===e.maxx&&e.miny<e.by&&e.by<e.maxy?e.bx=e.minx:e.bx>e.minx?n=i.LT:s=!1;break;case"right":e.bx===e.minx&&e.miny<e.by&&e.by<e.maxy?e.bx=e.maxx:e.bx<e.maxx?n=i.RT:s=!1;break;default:s=!1}return s&&(n!==i.NDIR&&e.movedir(n,2),i.draw(),e.draw()),s}},"TargetCursor:Address":{initialize:function(){this.bx=1,this.by=1,this.bankpiece=null,this.mode51=51===this.puzzle.klass.ExCell.prototype.ques,this.modesnum=this.puzzle.klass.Cell.prototype.enableSubNumberArray,this.disableAnum=this.puzzle.klass.Cell.prototype.disableAnum,this.targetdirs=this.puzzle.klass.Cell.prototype.dirs51,this.mode51&&this.puzzle.editmode?this.targetdir=4:this.disableAnum&&this.puzzle.playmode&&(this.targetdir=5)},init:function(t,e){return this.bx=t,this.by=e,this.bankpiece=null,this.mode51||(this.targetdir=this.disableAnum&&this.puzzle.playmode?5:0),this},getc:function(){return null===this.bankpiece?this.board.getc(this.bx,this.by):this.board.emptycell},minx:null,miny:null,maxx:null,maxy:null,crosstype:!1,initCursor:function(){this.crosstype?this.init(0,0):this.init(1,1),this.adjust_init()},setminmax:function(){var t=this.board,e=this.crosstype?0:1;this.minx=t.minbx+e,this.miny=t.minby+e,this.maxx=t.maxbx-e,this.maxy=t.maxby-e,this.setminmax_customize(),this.adjust_init()},setminmax_customize:function(){},adjust_init:function(){this.bx<this.minx&&(this.bx=this.minx),this.by<this.miny&&(this.by=this.miny),this.bx>this.maxx&&(this.bx=this.maxx),this.by>this.maxy&&(this.by=this.maxy)},adjust_modechange:function(){this.setminmax_customize!==this.common.setminmax_customize&&this.setminmax(),this.mode51&&this.puzzle.editmode?this.targetdir=4:this.modesnum&&(this.targetdir=this.puzzle.playmode&&this.disableAnum?5:0),this.puzzle.playmode&&(this.bankpiece=null)},adjust_cell_to_excell:function(){var t=this.board,e=Math.min(this.bx,2*t.cols-this.bx,this.by,2*t.rows-this.by);e<=0||(this.by===e?this.by=this.miny:2*t.rows-this.by===e?this.by=this.maxy:this.bx===e?this.bx=this.minx:2*t.cols-this.bx===e&&(this.bx=this.maxx))},checksnum:function(t){var e,i,s=2*(((t.bx+12)/2|0)-6)+1,n=2*(((t.by+12)/2|0)-6)+1,s=this.bx===s&&this.by===n;return s=s&&this.modesnum&&this.puzzle.playmode?this.disableAnum?(e=t.bx%2|0,[5,4,2,3][2*(i=t.by%2|0)+e]===this.targetdir):(e=(t.bx+12)%2*1.5|0,i=(t.by+12)%2*1.5|0,"factors"!==this.pid?[5,0,4,0,0,0,2,0,3][3*i+e]===this.targetdir:[0,0,4,0,0,0,2,0,3][3*i+e]===this.targetdir):s},movedir:function(t,e){return null!==this.bankpiece||(this.puzzle.klass.Address.prototype.movedir.call(this,t,e),this.modesnum&&this.puzzle.playmode&&!this.disableAnum&&(this.targetdir=0)),this},setaddr:function(t){t.bx<this.minx||this.maxx<t.bx||t.by<this.miny-("easyasabc"===this.pid?2:0)||this.maxy<t.by||(this.bankpiece=null,this.set(t),this.modesnum&&this.puzzle.playmode&&!this.disableAnum&&(this.targetdir=0))},moveTo:function(t,e){this.init(t,e),this.modesnum&&this.puzzle.playmode&&!this.disableAnum&&(this.targetdir=0)},targetdir:0,chtarget:function(t,e,i){var s;this.oncell()&&this.modesnum&&this.puzzle.playmode?this.disableAnum?this.targetdir=[5,1,3,5,2,4][this.targetdir]:"factors"!==this.pid?this.targetdir=[5,1,3,0,2,4][this.targetdir]:this.targetdir=[4,1,3,0,2,0][this.targetdir]:4===this.targetdirs?t?(s=e+i<0,this.targetdir=0<e-i?s?1:4:s?3:2):this.targetdir=[4,0,3,1,2,0][this.targetdir]:this.targetdir=t?0<e-i?4:2:2===this.targetdir?4:2,this.draw()},detectTarget:function(t){t=t||this.getobj();var e=this.board,i=t.adjacent;if(t.isnull)return 0;if("cell"===t.group){if(51!==t.ques)return 0;if(2===this.targetdirs){var s=i.right.isnull||51===i.right.ques,n=i.bottom.isnull||51===i.bottom.ques;if(s&&n)return 0;if(n)return t.RT;if(s)return t.DN}}else{if("excell"!==t.group)return 0;if(t.id===e.cols+e.rows)return 0;if(-1===t.by&&51===i.bottom.ques||-1===t.bx&&51===i.right.ques)return 0;if(-1===t.by)return t.DN;if(-1===t.bx)return t.RT}return this.targetdir},getNumOfTarget:function(t){var e=1;return t.isnull?e=0:"cell"===t.group&&(this.modesnum&&this.puzzle.playmode?e=4-("factors"===this.pid?1:0):51===t.ques&&(e=((t=t.adjacent).right.isnull||51===t.right.ques?0:1)+(t.bottom.isnull||51===t.bottom.ques?0:1))),e},getDot:function(){return this.board.getDot(this.bx,this.by)}}}),p.classmgr.makeCommon({Encode:{pflag:"",outpflag:"",outvariant:null,outcols:null,outrows:null,outbstr:"",fio:null,checkpflag:function(t){return 0<=this.pflag.indexOf(t)},decodeURL:function(t){var e=p.parser.parseURL(t),i=this.puzzle,t=i.board;if(null!==e.variant&&(i.setConfig("variant",!0),i.setConfig("variantid",e.variant)),e.type===e.URL_PZPRFILE)(new i.klass.FileIO).filedecode(e.body);else{if(t.initBoardSize(e.cols,e.rows),e.body)switch(this.pflag=e.pflag,this.outbstr=e.body,e.type){case e.URL_PZPRV3:case e.URL_KANPENP:this.decodePzpr(e.URL_PZPRV3);break;case e.URL_PZPRAPP:this.decodePzpr(e.URL_PZPRAPP);break;case e.URL_KANPEN:this.fio=new i.klass.FileIO,this.fio.dataarray=this.outbstr.replace(/_/g," ").split("/"),this.decodeKanpen(),this.fio=null;break;case e.URL_HEYAAPP:this.decodeHeyaApp()}t.rebuildInfo()}},encodeURL:function(t,e){var i=this.puzzle,s=i.pid,n=i.board,r=new p.parser.URLData("",e),e=((t=t||r.URL_PZPRV3)===r.URL_KANPEN&&"lits"===s&&(t=r.URL_KANPENP),this.outpflag=null,i.getConfig("variant"));switch(this.outvariant=e?i.getConfig("variantid"):null,this.outcols=n.cols,this.outrows=n.rows,this.outbstr="",t){case r.URL_PZPRV3:this.encodePzpr(r.URL_PZPRV3);break;case r.URL_PZPRFILE:var o=(o=this.puzzle.getFileData(r.FILE_PZPRV3).split("\n")).map(encodeURIComponent);this.outbstr=o.join("/");break;case r.URL_PZPRAPP:throw Error("no implementation");case r.URL_KANPENP:if(!i.info.exists.kanpen)throw Error("no implementation");this.encodePzpr(r.URL_PZPRAPP),this.outpflag=this.outpflag||"";break;case r.URL_KANPEN:this.fio=new i.klass.FileIO,this.encodeKanpen(),this.outbstr=this.fio.datastr.replace(/\r?\n/g,"/").replace(/ /g,"_"),this.fio=null;break;case r.URL_HEYAAPP:this.encodeHeyaApp();break;default:throw Error("invalid URL Type")}return r.pid=s,r.type=t,r.pflag=this.outpflag,r.variant=this.outvariant,r.cols=this.outcols,r.rows=this.outrows,r.body=this.outbstr,r.generate()},decodePzpr:function(t){throw Error("no implementation")},encodePzpr:function(t){throw Error("no implementation")},decodeKanpen:function(){throw Error("no implementation")},encodeKanpen:function(){throw Error("no implementation")},decodeHeyaApp:function(){throw Error("no implementation")},encodeHeyaApp:function(){throw Error("no implementation")}}}),p.classmgr.makeCommon({FileIO:{filever:0,lineseek:0,dataarray:null,xmldoc:null,datastr:"",currentType:0,filedecode:function(t){var e=this.puzzle,i=e.board,t=p.parser.parseFile(t,e.pid),s=this.currentType=t.type;switch(i.initBoardSize(t.cols,t.rows),null!==t.variant&&(e.setConfig("variant",!0),e.setConfig("variantid",t.variant)),this.filever=t.filever,s!==t.FILE_PBOX_XML?(this.lineseek=0,this.dataarray=t.body.split("\n")):this.xmldoc=t.body,s){case t.FILE_PZPR:this.decodeData(),(this.readLine()||"").match(/TrialData/)&&(this.lineseek--,this.decodeTrial());break;case t.FILE_PBOX:this.kanpenOpen();break;case t.FILE_PBOX_XML:this.kanpenOpenXML()}e.metadata.update(t.metadata),t.history&&s===t.FILE_PZPR&&e.opemgr.decodeHistory(t.history),i.rebuildInfo(),this.dataarray=null},fileencode:function(t,e){var i,s=this.puzzle,n=s.board,r=new p.parser.FileData("",s.pid);switch(this.currentType=t=t||r.FILE_PZPR,e=e||{},this.filever=0,this.datastr="",t===r.FILE_PBOX_XML&&(this.xmldoc=(new m).parseFromString('<?xml version="1.0" encoding="utf-8" ?><puzzle />',"text/xml"),(i=this.xmldoc.querySelector("puzzle")).appendChild(this.createXMLNode("board")),i.appendChild(this.createXMLNode("answer"))),t){case r.FILE_PZPR:this.encodeData(),!e.history&&e.trial&&0<n.trialstage&&this.encodeTrial();break;case r.FILE_PBOX:this.kanpenSave();break;case r.FILE_PBOX_XML:this.kanpenSaveXML();break;default:throw Error("invalid filetype")}return r.type=t,r.filever=this.filever,r.cols=n.cols,r.rows=n.rows,t!==r.FILE_PBOX_XML?r.body=this.datastr:r.body=this.xmldoc,r.metadata.update(s.metadata),e.history&&t===r.FILE_PZPR&&(r.history=s.opemgr.encodeHistory({time:!!e.time})),this.datastr="",r.generate()},decodeData:E,encodeData:E,kanpenOpen:E,kanpenSave:E,kanpenOpenXML:E,kanpenSaveXML:E,decodeTrial:function(){for(var t=this.puzzle.opemgr,r=this.board,e=(0|this.readLine().match(/TrialData\((\d+)\)/)[1])-1;0<=e;e--){var o=[],a=r.freezecopy();r.allclear(!1),this.decodeData(),r.compareData(a,function(t,e,i){var s=r[t][e],n=s[i],t=a[t][e][i];o.push(new this.puzzle.klass.ObjectOperation(s,i,n,t))}),t.history.unshift(o),t.history.unshift([new this.puzzle.klass.TrialEnterOperation(e,e+1)]),t.trialpos.unshift(2*e),this.readLine()}t.position=t.history.length,t.resumeTrial()},encodeTrial:function(){var t=this.puzzle.opemgr,e=t.position;t.disableRecord();for(var i=this.board.trialstage;0<i;i--)this.writeLine("TrialData("+i+")"),t.resumeGoto(t.trialpos[i-1]),this.encodeData();t.resumeGoto(e),t.resumeTrial(),t.enableRecord()},readLine:function(){return this.lineseek++,this.dataarray[this.lineseek-1]},getItemList:function(t){for(var e,i=[],s=0;s<t;s++)if(e=this.readLine())for(var n=e.split(" "),r=0;r<n.length;r++)""!==n[r]&&i.push(n[r]);return i},writeLine:function(t){this.datastr+=(t="number"==typeof t?""+t:t||"")+"\n"},decodeObj:function(t,e,i,s,n,r){for(var o=i,a=s,h=this.getItemList((r-s)/2+1),l=0;l<h.length&&(t.call(this,this.board.getObjectPos(e,o,a),h[l]),n<(o+=2)&&(o=i,a+=2),!(r<a));l++);},decodeCell:function(t){this.decodeObj(t,"cell",1,1,2*this.board.cols-1,2*this.board.rows-1)},decodeCross:function(t){this.decodeObj(t,"cross",0,0,2*this.board.cols,2*this.board.rows)},decodeBorder:function(t,e){var i=this.puzzle.board;1===(e=e||i.hasborder)?(this.decodeObj(t,"border",2,1,2*i.cols-2,2*i.rows-1),this.decodeObj(t,"border",1,2,2*i.cols-1,2*i.rows-2)):2===e&&(this.currentType===p.parser.FILE_PZPR?(this.decodeObj(t,"border",0,1,2*i.cols,2*i.rows-1),this.decodeObj(t,"border",1,0,2*i.cols-1,2*i.rows)):this.currentType===p.parser.FILE_PBOX&&(this.decodeObj(t,"border",1,0,2*i.cols-1,2*i.rows),this.decodeObj(t,"border",0,1,2*i.cols,2*i.rows-1)))},decodeCellExCell:function(t){this.decodeObj(t,"obj",this.board.minbx+1,this.board.minby+1,this.board.maxbx-1,this.board.maxby-1)},encodeObj:function(t,e,i,s,n,r){for(var o=s;o<=r;o+=2){for(var a="",h=i;h<=n;h+=2)a+=t.call(this,this.board.getObjectPos(e,h,o));this.writeLine(a)}},encodeCell:function(t){this.encodeObj(t,"cell",1,1,2*this.board.cols-1,2*this.board.rows-1)},encodeCross:function(t){this.encodeObj(t,"cross",0,0,2*this.board.cols,2*this.board.rows)},encodeBorder:function(t,e){var i=this.puzzle.board;1===(e=e||i.hasborder)?(this.encodeObj(t,"border",2,1,2*i.cols-2,2*i.rows-1),this.encodeObj(t,"border",1,2,2*i.cols-1,2*i.rows-2)):2===e&&(this.currentType===p.parser.FILE_PZPR?(this.encodeObj(t,"border",0,1,2*i.cols,2*i.rows-1),this.encodeObj(t,"border",1,0,2*i.cols-1,2*i.rows)):this.currentType===p.parser.FILE_PBOX&&(this.encodeObj(t,"border",1,0,2*i.cols-1,2*i.rows),this.encodeObj(t,"border",0,1,2*i.cols,2*i.rows-1)))},encodeCellExCell:function(t){this.encodeObj(t,"obj",this.board.minbx+1,this.board.minby+1,this.board.maxbx-1,this.board.maxby-1)},decodeFlags:function(){for(var t=this.readLine().split(","),e=0;e<t.length;e++)this.puzzle.setConfig(t[e],!0)},encodeFlags:function(t){for(var e=[],i=0;i<t.length;i++)this.puzzle.getConfig(t[i])&&e.push(t[i]);this.writeLine(e.join(","))},decodeConfigFlag:function(t,e,i,s){void 0===i&&(i=!0),void 0===s&&(s=!i),this.dataarray[this.lineseek]===t?(this.puzzle.setConfig(e,i),this.readLine()):this.puzzle.setConfig(e,s)},encodeConfigFlag:function(t,e,i){void 0===i&&(i=!0),this.puzzle.getConfig(e)===i&&this.writeLine(t)},decodeCellXMLBoard:function(t){for(var e=this.xmldoc.querySelectorAll("board number"),i=0;i<e.length;i++){var s=e[i],n=this.board.getc(2*+s.getAttribute("c")-1,2*+s.getAttribute("r")-1);n.isnull||t(n,+s.getAttribute("n"))}},encodeCellXMLBoard:function(t){for(var e=this.xmldoc.querySelector("board"),i=this.board,s=0;s<i.cell.length;s++){var n=i.cell[s],r=t(n);null!==r&&e.appendChild(this.createXMLNode("number",{r:1+(n.by/2|0),c:1+(n.bx/2|0),n:r}))}},PBOX_ADJUST:0,decodeCellXMLBrow:function(t){this.decodeCellXMLrow_com(t,"board","brow")},encodeCellXMLBrow:function(t){this.encodeCellXMLrow_com(t,"board","brow")},decodeCellXMLArow:function(t){this.decodeCellXMLrow_com(t,"answer","arow")},encodeCellXMLArow:function(t){this.encodeCellXMLrow_com(t,"answer","arow")},decodeCellXMLrow_com:function(t,e,i){for(var s=this.xmldoc.querySelectorAll(e+" "+i),n=this.PBOX_ADJUST,r=0;r<s.length;r++)for(var o=1-n,a=2*+s[r].getAttribute("row")-1-n,h=s[r].childNodes,l=0;l<h.length;l++)if(1===h[l].nodeType){var c=h[l].nodeName,u=h[l].getAttribute("n")||1;"z"===c?c="n0":"n"===c&&(c="n"+ +h[l].getAttribute("v"));for(var d=0;d<u;d++)t(this.board.getobj(o,a),c),o+=2}},encodeCellXMLrow_com:function(t,e,i){for(var s=this.xmldoc.querySelector(e),n=this.PBOX_ADJUST,r=this.board,o=1-n;o<=r.maxby;o+=2){for(var a=this.createXMLNode(i,{row:1+((o+n)/2|0)}),h=1-n;h<=r.maxbx;h+=2){var l=t(r.getobj(h,o)),l=l.match(/n(\d\d+)/)||l.match(/n(\-\d+)/)?this.createXMLNode("n",{v:RegExp.$1}):"n0"===l?this.createXMLNode("z"):this.createXMLNode(l);a.appendChild(l)}s.appendChild(a)}},createXMLNode:function(t,e){var i=this.xmldoc.createElement(t);if(e)for(var s in e)i.setAttribute(s,e[s]);return i}}}),p.classmgr.makeCommon({AnsCheck:{initialize:function(){this.inCheck=!1,this.checkOnly=!1,this.makeCheckList()},failcodemode:void 0,failcode:void 0,_info:void 0,checklist:[],makeCheckList:function(){for(var t=this.checklist,e=[],i=0;i<t.length;i++){var s=t[i],n=!0;if(s.match("@")&&(n=p.util.checkpid(s.substr(s.indexOf("@")+1),this.puzzle.pid),s=s.substr(0,s.indexOf("@"))),n){if(n=(s.match(/\+/)||[]).length,!((s=s.replace(/\+/g,""))in this))throw Error("Function "+s+" does not exist in AnsCheck");e.push([this[s],n])}}this.checklist_normal=[];for(i=0;i<e.length;i++)this.checklist_normal.push(e[i][0]);e=e.sort(function(t,e){return e[1]-t[1]}),this.checklist_auto=[];for(i=0;i<e.length;i++)this.checklist_auto.push(e[i][0])},check:function(t){var e=this.puzzle,i=this.board;return this.inCheck=!0,t?(this.checkOnly=!1,this.checkAns(!1),this.failcode.complete||(i.haserror=!0,e.redraw(!0))):void 0!==this.failcode&&this.failcodemode===t||(i.disableSetError(),this.checkOnly=!0,this.checkAns(!1===t),this.failcodemode=t,i.enableSetError()),this.inCheck=!1,this.failcode},checkAns:function(t){this.failcode=new this.klass.CheckInfo;for(var e=!this.puzzle.getConfig("multierr")||t,i=this.checkOnly&&e?this.checklist_auto:this.checklist_normal,s=0;s<i.length&&(i[s].call(this),!(e&&0<this.failcode.length));s++);t||(this.failcode.text=this.failcode.gettext())},resetCache:function(){this.failcode=this.failcodemode=void 0,this._info={}}},CheckInfo:{initialize:function(t){this.add(t)},complete:!0,undecided:!1,text:"",length:0,lastcode:null,add:function(t){t&&(t!==this.lastcode&&(this[this.length++]=this.lastcode=t),this.complete=!1)},gettext:function(t){var e=this.puzzle,i=p.failcodes,s=[],n="ja"===(t||p.lang)?"ja":"en";if(0===this.length)return i[n].complete;for(var r=0;r<this.length;r++){var o=this[r],a=o+"."+this.pid,h=o+"."+this.pidbase,a=(o in e.faillist?o=e.faillist[o]:a in i.en?o=a:h in i.en&&(o=h),i[n][o]||i.en[o]||i[n].invalid);s.push(a)}return s.join("\n")},setUndecided:function(){this.undecided=!0}},FailCode:{}}),p.classmgr.makeCommon({Operation:{external:!1,initialize:function(){var t;this.manager=this.puzzle.opemgr,0<arguments.length&&(t=Array.prototype.slice.call(arguments),this.setData.apply(this,t))},reqReset:!1,setData:function(t,e){this.old=t,this.num=e},decode:function(t){return!1},toString:function(){return""},toJSON:function(){return this.toString()},broadcast:function(){},undo:function(){this.exec(this.old)},redo:function(){this.exec(this.num)},exec:function(t){}},"ObjectOperation:Operation":{group:"",property:"",pos:null,STRGROUP:{C:"cell",X:"cross",B:"border",E:"excell"},STRPROP:{U:"ques",N:"qnum",Z:"qnum2",C:"qchar",M:"anum",D:"qdir",A:"qans",S:"qsub",K:"qcmp",B:"snum",L:"line"},setData:function(t,e,i,s){this.group=t.group,this.property=e,this.bx=t.bx,this.by=t.by,this.old=i,this.num=s,4<e.length&&"snum"===e.substr(0,4)&&(this.property="snum",this.pos=e.substr(4))},decode:function(t){return this.group=this.STRGROUP[t[0].charAt(0)],this.property=this.STRPROP[t[0].charAt(1)],!(!this.group||!this.property)&&(this.pos="CB"===t[0].substr(0,2)&&2<t[0].length?+t[0].charAt(2):null,this.bx=+t[1],this.by=+t[2],this.old=+t[3],this.num=+t[4],!0)},toString:function(){var t,e="";for(t in this.STRGROUP)if(this.group===this.STRGROUP[t]){e+=t;break}for(t in this.STRPROP)if(this.property===this.STRPROP[t]){e+=t;break}return"CB"===e&&null!==this.pos&&(e+=this.pos),[e,this.bx,this.by,this.old,this.num].join(",")},broadcast:function(){this.external||this.puzzle.emit("cellop",this.toJSON())},isModify:function(t){var e=this.property;return t.group===this.group&&t.property===this.property&&t.num===this.old&&t.bx===this.bx&&t.by===this.by&&("qnum"===e||"qnum2"===e||"qchar"===e||"anum"===e||"snum"===e&&t.pos===this.pos)&&(t.num=this.num,!0)},isNoop:function(){return this.num===this.old},getPiece:function(){return this.board.getObjectPos(this.group,this.bx,this.by)},exec:function(t){var e=this.getPiece(),i=this.board;if(this.group!==e.group)return!0;null===this.pos?e.setdata(this.property,t,!0):e.setdata2(this.property,this.pos,t,!0),e.draw(),"qcmp"===this.property?i.cell.each(function(t){e===t.base&&t.draw()}):this.puzzle.checker.resetCache()}},"ObjectOperation2:Operation":{setData:function(t,e,i){this.bx=t.bx,this.by=t.by,this.old=e,this.val=i,this.property="qnums"},decode:function(t){if("CR"!==t.shift())return!1;this.bx=+t.shift(),this.by=+t.shift();t=t.join(","),t=t.substr(1,t.length-2).split(/\],\[/);if(0===t[0].length)this.old=[];else{this.old=t[0].split(/,/);for(var e=0;e<this.old.length;e++)this.old[e]=+this.old[e]}if(0===t[1].length)this.val=[];else{this.val=t[1].split(/,/);for(e=0;e<this.val.length;e++)this.val[e]=+this.val[e]}return!0},toString:function(){return["CR",this.bx,this.by,"["+this.old.join(",")+"]","["+this.val.join(",")+"]"].join(",")},isModify:function(t){return!(t.property!==this.property||t.bx!==this.bx||t.by!==this.by||!this.puzzle.pzpr.util.sameArray(t.val,this.old))&&(t.val=this.val,!0)},undo:function(){this.exec(this.old)},redo:function(){this.exec(this.val)},exec:function(t){var e=this.puzzle,i=e.board.getobj(this.bx,this.by);i.setQnums(t),i.draw(),e.checker.resetCache()}},"BoardClearOperation:Operation":{prefix:"AC",reqReset:!0,decode:function(t){return t[0]===this.prefix},toString:function(){return this.prefix}},"BoardAdjustOperation:Operation":{prefix:"AJ",reqReset:!0,setData:function(t){this.old=this.num=t},decode:function(t){return t[0]===this.prefix&&(this.old=this.num=t[1],!0)},toString:function(){return[this.prefix,this.num].join(",")},undo:function(){var t=this.board.exec.boardtype[this.old][0];this.exec(t)},redo:function(){var t=this.board.exec.boardtype[this.num][1];this.exec(t)},exec:function(t){var e=this.puzzle,i=e.board,s={x1:0,y1:0,x2:2*i.cols,y2:2*i.rows};i.exec.execadjust_main(t,s),e.redraw()}},"BoardFlipOperation:Operation":{prefix:"AT",reqReset:!0,area:{},setData:function(t,e){this.area=t,this.old=this.num=e},decode:function(t){return t[0]===this.prefix&&(this.old=this.num=t[1],this.area.x1=+t[2],this.area.y1=+t[3],this.area.x2=+t[4],this.area.y2=+t[5],!0)},toString:function(){var t=this.area;return[this.prefix,this.num,t.x1,t.y1,t.x2,t.y2].join(",")},undo:function(){var t,e=this.area,e={x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2},i=this.board.exec.boardtype[this.old][0];i&this.board.exec.TURN&&(t=e.x1,e.x1=e.y1,e.y1=t,t=e.x2,e.x2=e.y2,e.y2=t),this.exec(i,e)},redo:function(){var t=this.area,t={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2},e=this.board.exec.boardtype[this.num][1];this.exec(e,t)},exec:function(t,e){var i=this.puzzle;i.board.exec.execadjust_main(t,e),i.redraw()}},"TrialEnterOperation:Operation":{setData:function(t,e){this.old=t,this.num=e},undo:function(){this.manager.position--,this.manager.resumeTrial(),this.manager.position++,this.manager.trialpos.pop(),this.manager.emitTrial(this.old)},redo:function(){this.manager.trialpos.push(this.manager.position),this.manager.emitTrial(this.num)},decode:function(t){return"TE"===t[0]&&(this.old=+t[1],this.num=+t[2],!0)},toString:function(){return["TE",this.old,this.num].join(",")}},"TrialFinalizeOperation:Operation":{num:[],setData:function(t){this.old=t},exec:function(t){this.manager.trialpos=t.concat(),0===t.length?this.board.trialclear():(this.manager.position--,this.manager.resumeTrial(),this.manager.position++),this.manager.emitTrial(t.length),this.puzzle.redraw()},decode:function(t){return"TF"===t[0]&&(t.shift(),this.old=JSON.parse(t.join(",")),!0)},toString:function(){return"TF,["+this.old.join(",")+"]"}},OperationList:{initialize:function(){this.time=this.puzzle.getTime(),this.length=0},push:function(t){this[this.length++]=t},pop:function(){var t;return 0<this.length?(t=this[this.length-1],delete this[this.length-1],this.length--,t):null},some:function(t){return Array.prototype.slice.call(this).some(t)}},OperationManager:{initialize:function(){this.lastope=null,this.history=[],this.position=0,this.trialpos=[],this.disEmitTrial=0,this.savedStarts=[],this.broken=!1,this.initpos=0,this.disrec=0,this.disCombine=!1,this.forceRecord=!1,this.changeflag=!1,this.chainflag=!1,this.enableUndo=!1,this.enableRedo=!1,this.limitTrialUndo=!1,this.undoExec=!1,this.redoExec=!1,this.reqReset=!1,this.enableNetwork=!0;var t=this.klass;this.operationlist=[t.ObjectOperation,t.ObjectOperation2,t.BankEditOperation,t.BankReplaceOperation,t.BankPieceOperation,t.BoardClearOperation,t.BoardAdjustOperation,t.BoardFlipOperation,t.TrialEnterOperation,t.TrialFinalizeOperation],this.addExtraOperation()},addExtraOperation:function(){},getStarts:function(){for(var t=[],e=0;e<this.trialpos.length;e++){var i=this.trialpos[e];i+1<this.history.length&&((i=this.history[i+1][0]).getPiece&&t.push(i.getPiece()))}return t},updateStarts:function(){for(var t=this.savedStarts,e=t.length;0<e&&t[e-1].isnull;e--);var i=this.getStarts();if(e!==i.length){for(var s=0;s<i.length;s++)this.savedStarts[s]=i[s];for(s=i.length;s<this.savedStarts.length;s++)this.savedStarts[s]=new this.puzzle.board.klass.BoardPiece;for(s=0;s<t.length;s++)t[s].draw();for(s=0;s<this.savedStarts.length;s++)this.savedStarts[s].draw()}},disableRecord:function(){this.disrec++},enableRecord:function(){0<this.disrec&&this.disrec--},checkexec:function(){void 0!==this.history&&(this.checkenable(),this.puzzle.emit("history"))},atStartOfTrial:function(){return 0<this.trialpos.length&&this.position<=this.trialpos[this.trialpos.length-1]+1},checkenable:function(){this.limitTrialUndo&&0<this.trialpos.length?this.enableUndo=!this.atStartOfTrial():this.enableUndo=0<this.position,this.enableRedo=this.position<this.history.length,this.board.trialstage=this.trialpos.length},allerase:function(){this.lastope=null,this.history=[],this.position=0,this.broken=!1,this.initpos=0,this.changeflag=!1,this.chainflag=!1,this.checkexec(),this.trialpos=[],this.limitTrialUndo=!1,this.puzzle.checker.resetCache()},newOperation:function(){this.changeflag=!1,this.chainflag=!1},newChain:function(){this.chainflag=!1},isModified:function(){return this.broken||this.initpos<this.position},resetModifiedState:function(){this.broken=!1,this.initpos=this.position},removeDescendant:function(){this.position<this.initpos&&(this.broken=!0);for(var t=this.history.length-1;t>=this.position;t--)this.history.pop();this.position=this.history.length,this.chainflag=!1},add:function(t){var e;!this.puzzle.ready||!this.forceRecord&&0<this.disrec||(t.broadcast(),this.enableRedo&&this.removeDescendant(),e=this.puzzle,!this.disCombine&&this.lastope&&t.isModify&&t.isModify(this.lastope)?this.lastope.isNoop&&this.lastope.isNoop()&&(this.history[this.history.length-1].length<=1?(this.history.pop(),this.position--):this.history[this.history.length-1].pop(),this.lastope=null):(this.chainflag||(this.history.push(new this.klass.OperationList),this.position++,this.chainflag=!0),this.history[this.history.length-1].push(t),this.lastope=t,this.updateStarts()),"qcmp"!==t.property&&"snum"!==t.property&&e.checker.resetCache(),this.changeflag=!0,this.checkexec())},decodeHistory:function(t){this.allerase(),this.initpos=this.position=t.current||0,this.history=[];for(var e=t.datas||[],i=0,s=e.length;i<s;i++){var n=new this.klass.OperationList,r=(this.history.push(n),e[i]);void 0!==r.time&&(n.time=r.time,r=r.ope);for(var o=0,a=r.length;o<a;o++){for(var h=r[o].split(/,/),l=null,c=this.operationlist,u=0;u<c.length;u++){var d=new c[u];if(d.decode(h)){l=d;break}}l&&(n.push(l),this.lastope=l)}}this.checkexec(),this.trialpos=t.trialpos||[],0<this.trialpos.length&&(this.resumeTrial(),this.limitTrialUndo=!0)},encodeHistory:function(t){t=t||{},this.initpos=this.position;var e={type:"pzpr",version:.4};if(t.time&&(e.time=this.puzzle.getTime()),0<this.history.length){e.current=this.position,0<this.trialpos.length&&(e.trialpos=this.trialpos);for(var i=[],s=0;s<this.history.length;++s){var n=Array.prototype.slice.call(this.history[s]);t.time?i.push({ope:n,time:this.history[s].time}):i.push(n)}e.datas=i}return e},undo:function(){if(!this.enableUndo)return!1;var t=this.history[this.position-1];return this.reqReset=this.checkReqReset(t),this.preproc(),this.undoCore(),this.postproc(),this.enableUndo},redo:function(){if(!this.enableRedo)return!1;var t=this.history[this.position];return this.reqReset=this.checkReqReset(t),this.preproc(),this.redoCore(),this.postproc(),this.enableRedo},undoCore:function(){this.undoExec=!0;for(var t=this.history[this.position-1],e=t.length-1;0<=e;e--)t[e]&&t[e].undo();this.position--,this.undoExec=!1},redoCore:function(){this.redoExec=!0;for(var t=this.history[this.position],e=0;e<t.length;++e)t[e]&&t[e].redo();this.position++,this.redoExec=!1},resumeGoto:function(t){if(t<this.position)for(;t<this.position;)this.undoCore();else if(this.position<t)for(;this.position<t;)this.redoCore();this.checkenable()},checkReqReset:function(t){return t.some(function(t){return t.reqReset})},preproc:function(t){var e=this.puzzle,i=e.board;this.disableRecord(),e.painter.suspend(),e.errclear(),this.updateStarts(),this.reqReset&&i.disableInfo()},postproc:function(){var t=this.puzzle,e=t.board;this.reqReset&&(e.setposAll(),e.setminmax(),e.enableInfo(),e.rebuildInfo(),t.redraw(!0),t.emit("adjust")),t.painter.unsuspend(),this.enableRecord(),this.checkexec()},enterTrial:function(){this.atStartOfTrial()||(this.newOperation(),this.add(new this.puzzle.klass.TrialEnterOperation(this.trialpos.length,this.trialpos.length+1)),this.trialpos.push(this.position-1),this.limitTrialUndo=!0,this.checkexec(),this.newOperation(),this.emitTrial())},acceptTrial:function(){this.trialpos[this.trialpos.length-1]+1===this.position&&(this.position--,this.removeDescendant(),this.trialpos.pop()),0<this.trialpos.length&&(this.newOperation(),this.add(new this.puzzle.klass.TrialFinalizeOperation(this.trialpos)),this.board.trialclear()),this.trialpos=[],this.limitTrialUndo=!1,this.removeDescendant(),this.checkexec(),this.newOperation(),this.emitTrial()},rejectTrial:function(t){0!==this.trialpos.length&&(this.disableRecord(),this.board.errclear(),t||1===this.trialpos.length?(t=this.trialpos[0],this.board.trialclear(),this.trialpos=[],this.limitTrialUndo=!1,this.resumeGoto(t)):(this.resumeGoto(this.trialpos[this.trialpos.length-1]),this.resumeTrial()),this.enableRecord(),this.removeDescendant(),this.checkexec(),this.newOperation(),this.emitTrial())},resumeTrial:function(){var t;0<this.trialpos.length&&(this.disEmitTrial++,t=this.position,this.checkenable(),this.resumeGoto(this.trialpos[0]),this.board.trialclear(!0),this.position<t&&(this.board.trialstage=1,this.resumeGoto(t)),this.disEmitTrial--)},emitTrial:function(t){0===this.disEmitTrial&&this.puzzle.emit("trial",void 0===t?this.trialpos.length:t)}}}),p.classmgr.makeCommon({Bank:{enabled:!1,allowAdd:!1,presets:[],pieces:null,addButton:null,init:function(){this.addButton=new this.klass.BankAddButton},defaultPreset:function(){return[]},applyPreset:function(t,e){var i;if(t.func)i=this[t.func](e);else{if(!t.constant)return;i=t.constant}e=new this.klass.BankReplaceOperation(i);e.isNoop()||(this.ansclear(),e.redo(),this.puzzle.opemgr.add(e))},initialize:function(t){if(this.pieces=[],t){for(var e in t){var i=new this.klass.BankPiece;i.deserialize(t[e]),this.pieces.push(i)}this.rebuildExtraData(),this.performLayout()}},width:1,height:1,shouldDrawBank:function(){return!0},performLayout:function(){if(this.pieces&&this.width){for(var t=0,e=0,i=0,s=!this.puzzle.playeronly&&!!this.allowAdd,n=this.pieces.length,r=0;r<n+(s?1:0);r++){var o=r<n?this.pieces[r]:this.addButton;t+o.w+1>this.width&&(t=0,e=i),o.x=t,o.y=e,i=Math.max(i,e+o.h+1),o.index=r,t+=o.w+1}s||(this.addButton.index=null),this.height=i}},rebuildExtraData:function(){},draw:function(){this.puzzle.painter.range.bank=!0,this.puzzle.painter.prepaint()},errclear:function(){for(var t=0;t<this.pieces.length;t++)this.pieces[t].seterr(0)},setPiece:function(t,e){t=new this.klass.BankEditOperation(t,e);t.isNoop()||(e<this.pieces.length&&this.pieces[e].setQcmp(0),t.redo(),this.puzzle.opemgr.add(t))},ansclear:function(){this.subclear()},subclear:function(){for(var t=0;t<this.pieces.length;t++)this.pieces[t].setQcmp(0)}},BankPiece:{count:1,mincount:1,maxcount:1,deserialize:function(t){},canonize:function(){return this.serialize()},serialize:function(){return""},w:1,h:1,index:0,x:0,y:0,error:0,qcmp:0,seterr:function(t){this.board.isenableSetError()&&(this.error=t)},setQcmp:function(t){this.addOpe("qcmp",t)},draw:function(){this.puzzle.painter.range.bankPieces.push(this),this.puzzle.painter.prepaint()},addOpe:function(t,e){t=new this.klass.BankPieceOperation(this.index,t,this[t],e);t.isNoop()||(t.redo(),this.puzzle.opemgr.add(t))}},"BankAddButton:BankPiece":{isadd:!0,w:2,h:2,serialize:function(){return""},addOpe:function(){}},"BankEditOperation:Operation":{old:null,num:null,index:null,setData:function(t,e){var i=this.board.bank.pieces.length;if(e<0||i<e)throw Error("Index out of range");this.old=e<i?this.board.bank.pieces[e].serialize():null,this.num=t,this.index=e},undo:function(){var t=new this.klass.BankPiece;null!==this.old?(t.deserialize(this.old),null!==this.num?this.board.bank.pieces[this.index]=t:this.board.bank.pieces.splice(this.index,0,t)):(t=this.board.bank.pieces.pop())&&(t.index=null),this.board.bank.rebuildExtraData(),this.board.bank.performLayout(),this.puzzle.painter.resizeCanvas(),this.puzzle.emit("adjust")},redo:function(){var t=new this.klass.BankPiece;null!==this.num&&t.deserialize(this.num),this.index<this.board.bank.pieces.length?null!==this.num?this.board.bank.pieces[this.index]=t:(this.board.bank.pieces[this.index].index=null,this.board.bank.pieces.splice(this.index,1)):this.board.bank.pieces.push(t),this.board.bank.rebuildExtraData(),this.board.bank.performLayout(),this.puzzle.painter.resizeCanvas(),this.puzzle.emit("adjust")},isNoop:function(){return null!==this.num&&this.old===this.num},toString:function(){return["PP",this.index,this.num,this.old].join(",")},decode:function(t){return"PP"===t[0]&&(this.index=+t[0],this.num=t[1]||null,this.old=t[2]||null,!0)}},"BankReplaceOperation:Operation":{old:[],num:[],setData:function(t,e){this.old=this.board.bank.pieces.map(function(t){return t.serialize()}),t&&"string"!=typeof t?this.num=t:(this.num=this.old.concat(),t?e===this.old.length?this.num.push(t):this.num[e]=t:this.num.splice(e,1))},exec:function(t){this.board.bank.initialize(t),this.puzzle.painter.resizeCanvas(),this.puzzle.emit("adjust")},isNoop:function(){return this.puzzle.pzpr.util.sameArray(this.old,this.num)},toString:function(){return["PR",this.num.join("/"),this.old.join("/")].join(",")},decode:function(t){return"PR"===t[0]&&(this.num=t[1].split("/"),this.old=t[2].split("/"),!0)}},"BankPieceOperation:Operation":{index:0,num:0,old:0,property:"",STRPROP:{K:"qcmp"},isNoop:function(){return this.num===this.old},setData:function(t,e,i,s){this.index=t,this.property=e,this.old=i,this.num=s},exec:function(t){var e=this.board.bank.pieces[this.index];e[this.property]=t,e.draw()},toString:function(){var t,e="P";for(t in this.STRPROP)if(this.property===this.STRPROP[t]){e+=t;break}return[e,this.index,this.num,this.old].join(",")},decode:function(t){return this.property=this.STRPROP[t[0].charAt(1)],!(!this.property||"P"!==t[0].charAt(0))&&(this.index=+t[1],this.num=+t[2],this.old=+t[3],!0)}}}),p.classmgr.makeCommon({Graphic:{paintPost:function(){this.drawTrialStarts()},drawQuesCells:function(){this.vinc("cell_front","crispEdges",!0),this.drawCells_common("c_fullf_",this.getQuesCellColor)},getQuesCellColor:function(t){return null},getQuesCellColor_ques:function(t){return 1!==t.ques?null:1===(t.error||t.qinfo)?this.errcolor1:this.quescolor},getQuesCellColor_qnum:function(t){return-1===t.qnum?null:1===(t.error||t.qinfo)?this.errcolor1:this.quescolor},drawShadedCells:function(){this.vinc("cell_shaded","crispEdges",!0),this.drawCells_common("c_fulls_",this.getShadedCellColor)},getShadedCellColor:function(t){if(1!==t.qans)return null;var e=this.board.haserror||this.board.hasinfo,i=t.error||t.qinfo;return 1===i?this.errcolor1:2===i?this.errcolor2:t.trial?this.trialcolor:this.puzzle.execConfig("irowakeblk")&&!e?t.sblk.color:this.shadecolor},drawBGCells:function(){this.vinc("cell_back","crispEdges",!0),this.drawCells_common("c_fullb_",this.getBGCellColor)},getBGCellColor:function(t){return null},getBGCellColor_error1:function(t){return 1===t.error||1===t.qinfo?this.errbcolor1:null},getBGCellColor_error2:function(t){t=t.error||t.qinfo;return 1===t?this.errbcolor1:2===t?this.errbcolor2:null},getBGCellColor_qcmp:function(t){return 1===t.error||1===t.qinfo?this.errbcolor1:this.puzzle.execConfig("autocmp")&&t.room&&t.room.cmp?this.qcmpbgcolor:null},getBGCellColor_qcmp1:function(t){return 1===t.error||1===t.qinfo?this.errbcolor1:1===t.qsub?this.bcolor:this.puzzle.execConfig("autocmp")&&t.room&&t.room.cmp?this.qcmpbgcolor:null},getBGCellColor_qsub1:function(t){return 1===(t.error||t.qinfo)?this.errbcolor1:1===t.qsub?this.bcolor:null},getBGCellColor_qsub2:function(t){return this.bcolor="silver",1===(t.error||t.qinfo)?this.errbcolor1:1===t.qsub?this.qsubcolor1:2===t.qsub?this.qsubcolor2:null},getBGCellColor_qsub3:function(t){return 1===(t.error||t.qinfo)?this.errbcolor1:1===t.qsub?this.qsubcolor1:2===t.qsub?this.qsubcolor2:3===t.qsub?this.qsubcolor3:null},getBGCellColor_icebarn:function(t){return 1===t.error||1===t.qinfo?6===t.ques?this.erricecolor:this.errbcolor1:6===t.ques?this.icecolor:null},drawCells_common:function(t,e){for(var i=this.context,s=this.range.cells,n=0;n<s.length;n++){var r=s[n],o=e.call(this,r);i.vid=t+r.id,o?(i.fillStyle=o,i.fillRectCenter(r.bx*this.bw+this.getCellHorizontalOffset(r),r.by*this.bh,this.bw+.5,this.bh+.5)):i.vhide()}},getCellHorizontalOffset:function(t){return 0},drawBGExCells:function(){for(var t=this.vinc("excell_back","crispEdges",!0),e=this.range.excells,i=0;i<e.length;i++){var s=e[i],n=this.getBGExCellColor(s);t.vid="ex_full_"+s.id,n?(t.fillStyle=n,t.fillRectCenter(s.bx*this.bw,s.by*this.bh,this.bw+.5,this.bh+.5)):t.vhide()}},getBGExCellColor:function(t){if(1===t.error||1===t.qinfo)return this.errbcolor1},drawDotCells:function(){for(var t=this.vinc("cell_dot","auto",!0),e=Math.max(.06*this.cw,2),i=this.range.cells,s=0;s<i.length;s++){var n=i[s];t.vid="c_dot_"+n.id,n.isDot()?(t.fillStyle=n.trial?this.trialcolor:this.qanscolor,t.fillCircle(n.bx*this.bw,n.by*this.bh,e)):t.vhide()}},drawCellArrows:function(t){var e,i,s=this.vinc("cell_arrow","auto"),n=t?.5===t?(e=.35*this.cw,r=.1*this.cw,i=0,.27*this.cw):(e=.35*this.cw,r=.12*this.cw,i=0,.35*this.cw):(e=.4*this.cw,r=.03*this.cw,i=.16*this.cw,.16*this.cw),r=1<=r?r:1;n=5<=n?n:5;for(var o=this.range.cells,a=0;a<2;a++){var h=1===a?this.getCellArrowOutline:this.getCellArrowColor;if(h)for(var l=0;l<o.length;l++){var c=o[l],u=c.getArrow?c.getArrow():c.numberAsObject?c.getNum():c.qdir,d=1<=u&&u<=4?h.call(this,c):null;if(s.vid="c_arrow_"+a+"_"+c.id,d){s.lineWidth=1.5,s.strokeStyle=s.fillStyle=d,s.beginPath();var f=c.bx*this.bw,b=c.by*this.bh;switch(u){case c.UP:s.setOffsetLinePath(f,b,0,-e,-n,-i,-r,-i,-r,e,r,e,r,-i,n,-i,!0);break;case c.DN:s.setOffsetLinePath(f,b,0,e,-n,i,-r,i,-r,-e,r,-e,r,i,n,i,!0);break;case c.LT:s.setOffsetLinePath(f,b,-e,0,-i,-n,-i,-r,e,-r,e,r,-i,r,-i,n,!0);break;case c.RT:s.setOffsetLinePath(f,b,e,0,i,-n,i,-r,-e,-r,-e,r,i,r,i,n,!0)}1===a?s.stroke():s.fill()}else s.vhide()}}},getCellArrowOutline:null,getCellArrowColor:function(t){var e=t.numberAsObject?t.getNum():t.qdir;return 1<=e&&e<=4?t.numberAsObject&&-1===t.qnum?t.trial?this.trialcolor:this.qanscolor:this.quescolor:null},drawSlashes:function(){for(var t=this.vinc("cell_slash","auto"),e=Math.max(this.bw/4,2),i=this.puzzle.execConfig("irowake"),s=this.range.cells,n=0;n<=1;n++)for(var r=0;r<s.length;r++){var o,a,h,l=s[r],c=(t.vid="c_slash_"+n+"_"+l.id,31<=l.ques&&l.ques<=33),u=c?l.ques:l.qans;33===u||u===(n?32:31)?(h=l.qinfo||l.error,o=0,c||l.trial&&this.puzzle.execConfig("irowake")?o=-e/2:"gokigen"!==this.pid&&"wagiri"!==this.pid||1!==h&&3!==h||(o=e/2),c?a=this.quescolor:"kinkonkan"!==this.pid&&0<h?h&(n?4:8)?a=this.noerrcolor:1&h?a=this.errcolor1:2&h&&(a=this.errcolor2):a=-1===h?this.noerrcolor:i&&33===u?(!!n===l.parity()?l.path:l.path2).color:i&&l.path&&l.path.color?l.path.color:i&&l.path2&&l.path2.color?l.path2.color:l.trial?this.linetrialcolor:this.linecolor,t.lineWidth=e+o,t.strokeStyle=a,t.beginPath(),c=l.bx*this.bw,h=l.by*this.bh,n?t.setOffsetLinePath(c,h,this.bw,-this.bh,-this.bw,this.bh,!0):t.setOffsetLinePath(c,h,-this.bw,-this.bh,this.bw,this.bh,!0),t.stroke()):t.vhide()}},drawQuesNumbers:function(){this.vinc("cell_number","auto"),this.drawNumbers_com(this.getQuesNumberText,this.getQuesNumberColor,"cell_text_",this.textoption)},drawAnsNumbers:function(){this.vinc("cell_ans_number","auto"),this.drawNumbers_com(this.getAnsNumberText,this.getAnsNumberColor,"cell_ans_text_",{})},drawHatenas:function(){this.vinc("cell_number","auto"),this.drawNumbers_com(function(t){return-2===t.ques||-2===t.qnum?"?":""},this.getQuesNumberColor_qnum,"cell_text_",this.textoption)},drawNumbers_com:function(t,e,i,s){for(var n=this.context,r=this.range.cells,o=0;o<r.length;o++){var a,h=r[o],l=t.call(this,h);n.vid=i+h.id,l?(n.fillStyle=e.call(this,h),a=h.bx*this.bw+this.getCellHorizontalOffset(h),h=h.by*this.bh+this.getNumberVerticalOffset(h),this.disptext(l,a,h,s)):n.vhide()}},getNumberVerticalOffset:function(t){return 0},getQuesNumberText:function(t){return this.getNumberText(t,(this.puzzle.execConfig("dispmove")?t.base:t).qnum)},getAnsNumberText:function(t){return this.getNumberText(t,t.anum)},getNumberText:function(t,e){return t.numberAsLetter?this.getNumberTextCore_letter(e):this.getNumberTextCore(e)},getNumberTextCore:function(t){return 0<=t?""+t:this.hideHatena||-2!==t?"":"?"},getNumberTextCore_letter:function(t){var e=""+t;return-1===t?e="":-2===t?e="?":0<t&&t<=26?e=(t+9).toString(36).toUpperCase():26<t&&t<=52&&(e=(t-17).toString(36).toLowerCase()),e},getQuesNumberColor:function(t){return null},getQuesNumberColor_fixed:function(t){return this.quescolor},getQuesNumberColor_fixed_shaded:function(t){return this.fontShadecolor},getQuesNumberColor_qnum:function(t){return 1===(t.error||t.qinfo)?this.errcolor1:this.quescolor},getQuesNumberColor_move:function(t){var e=this.puzzle,i=t.error||t.qinfo;return 1===i||4===i?this.errcolor1:e.execConfig("dispmove")&&e.mouse.mouseCell===t?this.movecolor:this.quescolor},getQuesNumberColor_mixed:function(t){var e=t.error||t.qinfo;return 1<=t.ques&&t.ques<=5||1===t.qans?this.fontShadecolor:1===e||4===e?this.errcolor1:this.quescolor},getAnsNumberColor:function(t){return 1===(t.error||t.qinfo)?this.errcolor1:t.trial?this.trialcolor:this.qanscolor},drawNumbersExCell:function(){for(var t=this.vinc("excell_number","auto"),e=this.range.excells,i=0;i<e.length;i++){var s=e[i],n=this.getQuesNumberText(s);t.vid="excell_text_"+s.id,n?(t.fillStyle=this.getQuesNumberColor(s),this.disptext(n,s.bx*this.bw,s.by*this.bh)):t.vhide()}},drawSubNumbers:function(t){for(var e=this.vinc("cell_subnumber","auto"),i=[5,4,2,3],s=this.range.cells,n=0;n<s.length;n++)for(var r=s[n],o=0;o<4;o++){var a,h=r.numberAsLetter?this.getNumberTextCore_letter(r.snum[o]):this.getNumberTextCore(r.snum[o]);e.vid="cell_subtext_"+r.id+"_"+o,h?(e.fillStyle=t&&r.isShade()?this.subshadecolor:r.trial?this.trialcolor:this.subcolor,a=r.bx*this.bw+this.getCellHorizontalOffset(r),this.disptext(h,a,r.by*this.bh,{position:i[o],ratio:.33,hoffset:.8})):e.vhide()}},drawArrowNumbers:function(t){for(var e=this.vinc("cell_arrownumber","auto"),i=t&&t.scale||1,s=.4*this.cw*i,n=.03*this.cw*i,r=.16*this.cw*i,o=.12*this.cw*i,a=.6*-this.bh,h=[.6*this.bw,.7*this.bw,.8*this.bw,.85*this.bw],l=(t&&t.bottom&&(a*=-1),this.range.cells),c=0;c<l.length;c++){var u,d=l[c],f=d.qdir,b=this.getQuesNumberText(d),p=d.bx*this.bw,m=d.by*this.bh,g=b.length-1;if(b&&(e.fillStyle=this.getQuesNumberColor(d)),e.vid="cell_arrow_"+d.id,b&&f!==d.NDIR){switch(e.beginPath(),f){case d.UP:e.setOffsetLinePath(p+h[g]*i,m,0,-s,-o,-r,-n,-r,-n,s,n,s,n,-r,o,-r,!0);break;case d.DN:e.setOffsetLinePath(p+h[g]*i,m,0,s,-o,r,-n,r,-n,-s,n,-s,n,r,o,r,!0);break;case d.LT:e.setOffsetLinePath(p,m+a,-s,0,-r,-o,-r,-n,s,-n,s,n,-r,n,-r,o,!0);break;case d.RT:e.setOffsetLinePath(p,m+a,s,0,r,-o,r,-n,-s,-n,-s,n,r,n,r,o,!0)}e.fill()}else e.vhide();e.vid="cell_arnum_"+d.id,b?(u={ratio:this.fontsizeratio},f!==d.NDIR&&(u.ratio=t&&t.arrowfontsize?t.arrowfontsize:.7),f===d.UP||f===d.DN?p-=.1*this.cw:f!==d.LT&&f!==d.RT||(m+=.1*this.ch*(t&&t.bottom?-.5:1)),this.disptext(b,p,m,u)):e.vhide()}},drawCircledNumbers:function(){this.drawCircles(),this.vinc("cell_number","auto"),this.drawNumbers_com(this.getQuesNumberText,this.getQuesNumberColor,"cell_text_",{ratio:.65})},drawTapaNumbers:function(){for(var t=this.vinc("cell_tapanum","auto"),e=this.bw,i=this.bh,s=[{option:{},pos:[{x:0,y:0}]},{option:{ratio:.56},pos:[{x:-.4,y:-.4},{x:.4,y:.4}]},{option:{ratio:.48},pos:[{x:-.5,y:-.4},{x:.5,y:-.4},{x:0,y:.4}]},{option:{ratio:.4},pos:[{x:-.55,y:0},{x:0,y:-.5},{x:.55,y:0},{x:0,y:.5}]}],n=this.range.cells,r=0;r<n.length;r++)for(var o,a,h,l,c=n[r],u=c.bx,d=c.by,f=c.qnums,b=f.length,p=0;p<4;p++)t.fillStyle=this.getQuesNumberColor(c,p),t.vid="cell_text_"+c.id+"_"+p,p<b&&-1!==f[p]&&b<=4?(a=(u+(o=s[b-1]).pos[p].x)*e,h=(d+o.pos[p].y)*i,l=0<=f[p]?""+f[p]:"?",this.disptext(l,a,h,o.option)):t.vhide()},drawCrosses:function(){for(var t=this.vinc("cross_base","auto",!0),e=this.cw*this.crosssize+1,i=(t.lineWidth=1,{ratio:.6}),s=this.range.crosses,n=0;n<s.length;n++){var r=s[n],o=r.bx*this.bw,a=r.by*this.bh;t.vid="x_cp_"+r.id,-1!==r.qnum?(t.fillStyle=1===r.error||1===r.qinfo?this.errcolor1:"white",t.strokeStyle="black",t.shapeCircle(o,a,e)):t.vhide(),t.vid="cross_text_"+r.id,0<=r.qnum?(t.fillStyle=this.quescolor,this.disptext(""+r.qnum,o,a,i)):t.vhide()}},drawCrossMarks:function(){for(var t=this.vinc("cross_mark","auto",!0),e=this.cw*this.crosssize,i=this.range.crosses,s=0;s<i.length;s++){var n=i[s];t.vid="x_cm_"+n.id,1===n.qnum?(t.fillStyle=1===n.error||1===n.qinfo?this.errcolor1:this.quescolor,t.fillCircle(n.bx*this.bw,n.by*this.bh,e)):t.vhide()}},drawCrossErrors:function(t){for(var e=this.vinc("cross_error","auto"),i=(e.strokeStyle=this.errcolor1,e.lineWidth=Math.max(.04*this.cw,1),this.cw/4),s=this.range.crosses,n=0;n<s.length;n++){var r=s[n];e.vid="x_ce_"+r.id,r.error?(e.fillStyle=2===r.lcnt?this.errbcolor1:"white",e.shapeCircle(r.bx*this.bw,r.by*this.bh,i/2)):e.vhide()}},drawBorders:function(){this.vinc("border","crispEdges",!0),this.drawBorders_common("b_bd_")},drawBorders_common:function(t){for(var e=this.context,i=this.range.borders,s=0;s<i.length;s++){var n,r,o,a=i[s],h=this.getBorderColor(a);e.vid=t+a.id,h?(n=a.bx*this.bw+this.getBorderHorizontalOffset(a),r=a.by*this.bh,o=(this.lw+this.addlw)/2,e.fillStyle=h,a.isVert()?e.fillRectCenter(n,r,o,this.bh+o):e.fillRectCenter(n,r,this.bw+o,o)):e.vhide()}},getBorderHorizontalOffset:function(t){return 0},getBorderColor:function(t){return null},getBorderColor_ques:function(t){return t.isBorder()?this.quescolor:null},getBorderColor_qans:function(t){var e=t.error||t.qinfo;return t.isBorder()?1===e?this.errcolor1:-1===e?this.noerrcolor:t.trial?this.linetrialcolor:this.qanscolor:t.isCmp&&t.isCmp()?this.qcmpcolor:null},getBorderColor_ice:function(t){var e=t.sidecell[0],i=t.sidecell[1];return t.inside&&!e.isnull&&!i.isnull&&e.ice()^i.ice()?this.quescolor:null},drawQuesBorders:function(){this.vinc("border_question","crispEdges",!0),this.getBorderColor=this.getQuesBorderColor,this.drawBorders_common("b_bdques_")},drawQansBorders:function(){this.vinc("border_answer","crispEdges",!0),this.getBorderColor=this.getQansBorderColor,this.drawBorders_common("b_bdans_")},getQuesBorderColor:function(t){return 1<=t.ques?this.getBorderColor_ques(t):null},getQansBorderColor:function(t){return 1<=t.qans?this.getBorderColor_qans(t):null},drawBorderQsubs:function(){for(var t=this.vinc("border_qsub","crispEdges",!0),e=.15*this.cw,i=this.range.borders,s=0;s<i.length;s++){var n,r,o=i[s];t.vid="b_qsub1_"+o.id,1===o.qsub?(n=o.bx*this.bw+this.getBorderHorizontalOffset(o),r=o.by*this.bh,t.fillStyle=o.trial?this.linetrialcolor:this.pekecolor,o.isHorz()?t.fillRectCenter(n,r,.5,this.bh-e):t.fillRectCenter(n,r,this.bw-e,.5)):t.vhide()}},drawBoxBorders:function(t){for(var e=this.vinc("boxborder","crispEdges"),i=this.lm,s=this.cw,n=this.ch,r=(e.strokeStyle=this.bbcolor,e.lineWidth=1,this.range.cells),o=0;o<r.length;o++){var a,h,l,c,u,d,f,b,p,m,g,v,y,x,k=r[o],w=1===k.qans;"stostone"===this.pid&&this.board.falling&&(w=!1),e.vid="c_bb_"+k.id,w?(a=(w=(k.bx-1)*this.bw)-.5,h=w+i+.5,l=w+s-i-.5,w=w+s+.5,c=(f=(k.by-1)*this.bh)-.5,u=f+i+.5,d=f+n-i-.5,f=f+n+.5,v=k.adjborder,b=2<k.by,p=k.by<2*this.board.rows-2,m=2<k.bx,g=k.bx<2*this.board.cols-2,b=!b||v.top.isBorder(),p=!p||v.bottom.isBorder(),m=!m||v.left.isBorder(),g=!g||v.right.isBorder(),v=b||m||k.relbd(-2,-1).isBorder()||k.relbd(-1,-2).isBorder(),y=b||g||k.relbd(2,-1).isBorder()||k.relbd(1,-2).isBorder(),x=p||m||k.relbd(-2,1).isBorder()||k.relbd(-1,2).isBorder(),k=p||g||k.relbd(2,1).isBorder()||k.relbd(1,2).isBorder(),e.beginPath(),(b||v)&&e.moveTo(h,u),!b&&v&&e.lineTo(h,c),!b&&y&&e.moveTo(l,c),b||y?e.lineTo(l,u):(g||y)&&e.moveTo(l,u),!g&&y&&e.lineTo(w,u),!g&&k&&e.moveTo(w,d),g||k?e.lineTo(l,d):(p||k)&&e.moveTo(l,d),!p&&k&&e.lineTo(l,f),!p&&x&&e.moveTo(h,f),p||x?e.lineTo(h,d):(m||x)&&e.moveTo(h,d),!m&&x&&e.lineTo(a,d),!m&&v&&e.moveTo(a,u),(m||v)&&e.lineTo(h,u),e.stroke()):e.vhide()}},drawLines:function(){for(var t=this.vinc("line","crispEdges"),e=this.range.borders,i=0;i<e.length;i++){var s,n,r,o=e[i],a=this.getLineColor(o);t.vid="b_line_"+o.id,a?(s=o.bx*this.bw,n=o.by*this.bh,o=this.board.borderAsLine===o.isVert(),r=this.lm+this.addlw/2,t.fillStyle=a,o?t.fillRectCenter(s,n,r,this.bh+r):t.fillRectCenter(s,n,this.bw+r,r)):t.vhide()}this.addlw=0},getLineColor:function(t){var e,i,s,n;return this.addlw=0,t.isLine()?(e=t.error||t.qinfo,s=(i=this.puzzle).execConfig("irowake")&&t.path&&t.path.color,n=i.execConfig("dispmove"),t.trial&&i.execConfig("irowake")?this.addlw=-this.lm:1===e&&(this.addlw=1),1===e?this.errlinecolor:-1===e?this.noerrcolor:n?t.trial?this.movetrialcolor:this.movelinecolor:s?t.path.color:t.trial?this.linetrialcolor:this.linecolor):null},drawTip:function(){for(var t=this.vinc("cell_linetip","auto"),e=.3*this.cw,i=.05*this.cw,s=this.range.cells,n=0;n<s.length;n++){var r,o=s[n],a=0,h=null;1===o.lcnt&&!this.puzzle.execConfig("dispmove")&&-1===o.qnum&&-1===o.path.departure.anum^o.path.departure===o&&((r=o.adjborder).top.isLine()?(a=2,h=r.top):r.bottom.isLine()?(a=1,h=r.bottom):r.left.isLine()?(a=4,h=r.left):r.right.isLine()&&(a=3,h=r.right)),t.vid="c_tip_"+o.id,0!==a?(t.strokeStyle=this.getLineColor(h)||this.linecolor,t.lineWidth=this.lw+this.addlw,t.beginPath(),r=o.bx*this.bw+1,h=o.by*this.bh+1,1===a?t.setOffsetLinePath(r,h,-e,e,0,-i,e,e,!1):2===a?t.setOffsetLinePath(r,h,-e,-e,0,i,e,-e,!1):3===a?t.setOffsetLinePath(r,h,e,-e,-i,0,e,e,!1):4===a&&t.setOffsetLinePath(r,h,-e,-e,i,0,-e,e,!1),t.stroke()):t.vhide()}},drawPekes:function(){for(var t=this.vinc("border_peke","auto",!0),e=.15*this.cw+1,i=(e<4&&(e=4),t.lineWidth=1+this.cw/40|0,this.range.borders),s=0;s<i.length;s++){var n=i[s];t.vid="b_peke_"+n.id,2===n.qsub?(t.strokeStyle=n.trial?this.trialcolor:this.pekecolor,t.strokeCross(n.bx*this.bw,n.by*this.bh,e-1)):t.vhide()}},drawBaseMarks:function(t){for(var e=this.vinc("cross_mark","auto",!0),i=(e.fillStyle=this.quescolor,this.cw/10),s=this.range.crosses,n=0;n<s.length;n++){var r=s[n];e.vid="x_cm_"+r.id,!1!==t?e.fillCircle(r.bx*this.bw,r.by*this.bh,i/2):e.vhide()}},drawTriangle:function(){for(var t=this.vinc("cell_triangle","crispEdges"),e=this.range.cells,i=0;i<e.length;i++){var s=e[i],n=0!==s.ques?s.ques:s.qans;t.vid="c_tri_"+s.id,2<=n&&n<=5?(t.fillStyle=this.getTriangleColor(s),this.drawTriangle1(s.bx*this.bw,s.by*this.bh,n)):t.vhide()}},getTriangleColor:function(t){return this.quescolor},drawTriangle1:function(t,e,i){var s=this.context,n="reflect"===this.pid?1:.5,r=this.bw+1-n,o=this.bh+1-n;switch(s.beginPath(),i){case 2:s.setOffsetLinePath(t,e,-r,-o,-r,o,r,o,!0);break;case 3:s.setOffsetLinePath(t,e,r,-o,-r,o,r,o,!0);break;case 4:s.setOffsetLinePath(t,e,-r,-o,r,-o,r,o,!0);break;case 5:s.setOffsetLinePath(t,e,-r,-o,r,-o,-r,o,!0)}s.fill()},drawTriangle2:function(t,e,i){var s=this.context,n=this.bw+1,r=this.bh+1;switch(s.beginPath(),i){case 1:s.setOffsetLinePath(t,e,0,0,-n,-r,n,-r,!0);break;case 2:s.setOffsetLinePath(t,e,0,0,-n,r,n,r,!0);break;case 3:s.setOffsetLinePath(t,e,0,0,-n,-r,-n,r,!0);break;case 4:s.setOffsetLinePath(t,e,0,0,n,-r,n,r,!0)}s.fill()},drawMBs:function(){for(var t=this.vinc("cell_mb","auto",!0),e=(t.lineWidth=1,.35*this.cw),i=this.range.cells,s=0;s<i.length;s++){var n,r,o=i[s];0<o.qsub&&(n=o.bx*this.bw,r=o.by*this.bh,t.strokeStyle=o.trial?"rgb(192, 192, 192)":this.mbcolor),t.vid="c_MB1_"+o.id,1===o.qsub?t.strokeCircle(n,r,e):t.vhide(),t.vid="c_MB2_"+o.id,2===o.qsub?t.strokeCross(n,r,e):t.vhide()}},drawBorderAuxDir:function(){for(var t=this.vinc("border_dirsub","crispEdges"),e=.1*this.cw,i=(t.lineWidth=.1*this.cw,this.range.borders),s=0;s<i.length;s++){var n=i[s],r=n.bx*this.bw,o=n.by*this.bh,a=n.qsub-10;t.vid="b_daux_"+n.id,1<=a&&a<=8?(t.strokeStyle=n.trial?this.linetrialcolor:"rgb(64,64,64)",this.strokeSingleAuxDir(t,a,r,o,e)):t.vhide()}},strokeSingleAuxDir:function(t,e,i,s,n){var r=this.board.emptycell;switch(e){case r.UP:t.setOffsetLinePath(i,s,2*-n,+n,0,-n,2*+n,+n,!1);break;case r.DN:t.setOffsetLinePath(i,s,2*-n,-n,0,+n,2*+n,-n,!1);break;case r.LT:t.setOffsetLinePath(i,s,+n,2*-n,-n,0,+n,2*+n,!1);break;case r.RT:t.setOffsetLinePath(i,s,-n,2*-n,+n,0,-n,2*+n,!1)}t.stroke()},drawCircles:function(){for(var t=this.vinc("cell_circle","auto",!0),e=this.circleratio,i=this.cw*(e[0]+e[1])/2,s=this.cw*e[0],n=this.range.cells,r=0;r<n.length;r++){var o=n[r],a=this.getCircleFillColor(o);t.vid="c_cirb_"+o.id,a?(t.fillStyle=a,t.fillCircle(o.bx*this.bw+this.getCellHorizontalOffset(o),o.by*this.bh,s)):t.vhide()}(t=this.vinc("cell_circle_stroke","auto",!0)).lineWidth=Math.max(this.cw*(e[0]-e[1]),1);for(r=0;r<n.length;r++){o=n[r],a=this.getCircleStrokeColor(o);t.vid="c_cira_"+o.id,a?(t.strokeStyle=a,t.strokeCircle(o.bx*this.bw+this.getCellHorizontalOffset(o),o.by*this.bh,i)):t.vhide()}},getCircleStrokeColor:function(t){return null},getCircleStrokeColor_qnum:function(t){var e=this.puzzle,i=t.error||t.qinfo,s=e.execConfig("dispmove");return-1!==(s?t.base:t).qnum?s&&e.mouse.mouseCell===t?this.movecolor:1===i||4===i?this.errcolor1:this.quescolor:null},getCircleStrokeColor_qnum2:function(t){return 1===t.qnum?1===t.error?this.errcolor1:this.quescolor:null},getCircleFillColor:function(t){return null},getCircleFillColor_qnum:function(t){return-1!==t.qnum?1===(t=t.error||t.qinfo)||4===t?this.errbcolor1:this.circlebasecolor:null},getCircleFillColor_qnum2:function(t){return 1===t.qnum?1===t.error?this.errbcolor1:"white":2===t.qnum?1===t.error?this.errcolor1:this.quescolor:null},getCircleFillColor_qcmp:function(t){var e=this.puzzle,i=t.error||t.qinfo;return-1!==(e.execConfig("dispmove")?t.base:t).qnum?1===i||4===i?this.errbcolor1:t.isCmp()?this.qcmpcolor:this.circlebasecolor:null},drawDepartures:function(){for(var t=this.vinc("cell_depart","auto",!0),e=(t.fillStyle=this.movelinecolor,.15*this.cw),i=this.puzzle.execConfig("dispmove"),s=this.range.cells,n=0;n<s.length;n++){var r,o=s[n];t.vid="c_dcir_"+o.id,i&&o.isDeparture()?(r=o.bx*this.bw,o=o.by*this.bh,t.fillCircle(r,o,e)):t.vhide()}},drawLineParts:function(){for(var t=this.vinc("cell_lineparts","crispEdges"),e=(t.fillStyle=this.quescolor,this.lm),i=this.bw,s=this.bh,n=this.range.cells,r=0;r<n.length;r++){var o,a,h,l,c,u,d,f=n[r],b=f.ques;t.vid="c_lp_"+f.id,11<=b&&b<=17?(o=(l=f.bx*this.bw)-i-.5,a=l-e,h=l+e,l=l+i+.5,c=(f=f.by*this.bh)-s-.5,u=f-e,d=f+e,f=f+s+.5,b={11:15,12:3,13:12,14:9,15:5,16:6,17:10}[b],t.beginPath(),t.moveTo(a,u),1&b&&(t.lineTo(a,c),t.lineTo(h,c)),t.lineTo(h,u),8&b&&(t.lineTo(l,u),t.lineTo(l,d)),t.lineTo(h,d),2&b&&(t.lineTo(h,f),t.lineTo(a,f)),t.lineTo(a,d),4&b&&(t.lineTo(o,d),t.lineTo(o,u)),t.closePath(),t.fill()):t.vhide()}},drawTateyokos:function(){for(var t=this.vinc("cell_tateyoko","crispEdges"),e=Math.max(this.cw/6,3)/2,i=this.range.cells,s=0;s<i.length;s++){var n=i[s],r=n.bx*this.bw,o=n.by*this.bh,a=n.qans;t.vid="c_bar1_"+n.id,11===a||12===a?(t.fillStyle=this.getBarColor(n,!0),t.fillRectCenter(r,o,e+this.addlw/2,this.bh)):t.vhide(),t.vid="c_bar2_"+n.id,11===a||13===a?(t.fillStyle=this.getBarColor(n,!1),t.fillRectCenter(r,o,this.bw,e+this.addlw/2)):t.vhide()}this.addlw=0},getBarColor:function(t,e){var i=t.error,e=1===i||4===i||5===i&&e||6===i&&!e,s="";return this.addlw=0,e?(s=this.errlinecolor,this.addlw=1):s=0!==i?this.noerrcolor:t.trial?this.linetrialcolor:this.linecolor,s},drawQues51:function(){this.drawExCellGrid(),this.drawTargetTriangle(),this.drawSlash51Cells(),this.drawSlash51ExCells()},drawSlash51Cells:function(){for(var t=this.vinc("cell_ques51","crispEdges",!0),e=(t.strokeStyle=this.quescolor,t.lineWidth=1,this.range.cells),i=0;i<e.length;i++){var s,n,r=e[i];t.vid="c_slash51_"+r.id,51===r.ques?(s=r.bx*this.bw,n=r.by*this.bh,t.strokeLine(s-this.bw,n-this.bh,s+this.bw,n+this.bh)):t.vhide(),t.vid="c_slash51b_"+r.id,51===r.ques&&4===r.dirs51?(s=r.bx*this.bw,n=r.by*this.bh,t.strokeLine(s-this.bw,n+this.bh,s+this.bw,n-this.bh)):t.vhide()}},drawSlash51ExCells:function(){for(var t=this.vinc("excell_ques51","crispEdges",!0),e=(t.strokeStyle=this.quescolor,t.lineWidth=1,this.range.excells),i=0;i<e.length;i++){var s=e[i],n=s.bx*this.bw,r=s.by*this.bh;t.vid="ex_slash51_"+s.id,t.strokeLine(n-this.bw,r-this.bh,n+this.bw,r+this.bh)}},drawExCellGrid:function(){for(var t=this.vinc("grid_excell","crispEdges",!0),e=(t.fillStyle=this.quescolor,this.range.excells),i=0;i<e.length;i++){var s=e[i],n=s.bx*this.bw,r=s.by*this.bh;t.vid="ex_bdx_"+s.id,-1===s.by&&s.bx<this.board.maxbx?t.fillRectCenter(n+this.bw,r,.5,this.bh):t.vhide(),t.vid="ex_bdy_"+s.id,-1===s.bx&&s.by<this.board.maxby?t.fillRectCenter(n,r+this.bh,this.bw,.5):t.vhide()}},drawQuesNumbersOn51:function(){this.vinc("cell_number51","auto");for(var t=this.range,e=1|t.x1;e<=t.x2;e+=2)for(var i=1|t.y1;i<=t.y2;i+=2){var s=this.board.getobj(e,i);s.isnull||(4===s.dirs51?this.drawQuesNumbersOn51_2(s):this.drawQuesNumbersOn51_1(s))}},drawQuesNumbersOn51_1:function(t){var e,i,s=this.context,n=t.bx*this.bw,r=t.by*this.bh,o={ratio:.45};s.fillStyle=1===t.error||1===t.qinfo?this.errcolor1:this.quescolor,i=t.relcell(2,0),e=51===t.ques?t.qnum:-1,s.vid=[t.group,t.id,"text_ques51_rt"].join("_"),0<=e&&!i.isnull&&51!==i.ques?(o.position=this.TOPRIGHT,this.disptext(""+e,n,r,o)):s.vhide(),i=t.relcell(0,2),e=51===t.ques?t.qnum2:-1,s.vid=[t.group,t.id,"text_ques51_dn"].join("_"),0<=e&&!i.isnull&&51!==i.ques?(o.position=this.BOTTOMLEFT,this.disptext(""+e,n,r,o)):s.vhide()},drawQuesNumbersOn51_2:function(t){var e,i=this.context,s=t.bx*this.bw,n=t.by*this.bh,r={ratio:.4,width:[.35,.23,.15]};i.fillStyle=1===t.error||1===t.qinfo?this.errcolor1:this.quescolor;for(var o=1;o<=4;o++)e=t.getQnumDir(o),i.vid=[t.group,t.id,"text_ques51",o].join("_"),0<=e?(r.position=o+5,this.disptext(""+e,s,n,r)):i.vhide()},drawTarget:function(){this.drawCursor(!0,this.puzzle.editmode)},drawCursor:function(t,e){this.drawRawCursor("target_cursor","",this.puzzle.cursor,t,!1!==e&&this.puzzle.getConfig("cursor"),this.puzzle.editmode?this.targetColorEdit:this.targetColorPlay)},drawTrialStarts:function(){for(var t=this.puzzle.opemgr.savedStarts,e=0;e<t.length;e++){var i=t[e];this.drawRawCursor("trial_cursor","trial_"+e,i,!1,!i.isnull&&this.puzzle.getConfig("trialmarker"),this.targetColorTrial)}},drawRawCursor:function(t,e,i,s,n,r){var o,a,t=this.vinc(t,"crispEdges"),h=i.bx*this.bw,l=i.by*this.bh,c=i.group?i:i.getobj();c&&"cell"===c.group?h+=this.getCellHorizontalOffset(c):c&&"border"===c.group&&(h+=this.getBorderHorizontalOffset(c)),s=c=!1!==s?(o=0|Math.max(this.cw/16,2),this.bw-.5):(o=0|Math.max(this.cw/24,1),.56*this.bw),"number"==typeof i.bankpiece&&(a=this.board.bank.pieces[i.bankpiece],(a=i.bankpiece===this.board.bank.pieces.length?this.board.bank.addButton:a)?(i=this.puzzle.painter.bankratio,h=(a.x+.25+a.w/2)*this.cw*i,l=(a.y+.25+a.h/2)*this.ch*i,l+=(this.board.rows+this.bankVerticalOffset)*this.ch,c=(a.w+.25)*this.cw*i*.5,s=(a.h+.25)*this.ch*i*.5):n=!1),n=!1!==n&&!this.outputImage,t.fillStyle=r,t.vid=e+"ti1_",n?t.fillRect(h-c,l-s,2*c,o):t.vhide(),t.vid=e+"ti2_",n?t.fillRect(h-c,l-s,o,2*s):t.vhide(),t.vid=e+"ti3_",n?t.fillRect(h-c,l+s-o,2*c,o):t.vhide(),t.vid=e+"ti4_",n?t.fillRect(h+c-o,l-s,o,2*s):t.vhide()},drawTargetSubNumber:function(t){var e,i,s,n,r=this.vinc("target_subnum","crispEdges"),o=this.range,a=this.puzzle.cursor;a.bx<o.x1||o.x2<a.bx||a.by<o.y1||o.y2<a.by||(o=a.targetdir,i=a.getc(),a.disableAnum&&-1===this.puzzle.mouse.inputMode.indexOf("number")&&(o=0),r.vid="target_subnum",r.fillStyle=t&&i&&i.isShade()?this.ttshadecolor:this.ttcolor,this.puzzle.playmode&&0!==o?(t=this.bw,e=this.bh,i=a.bx*t+.5+this.getCellHorizontalOffset(i),a=a.by*e+.5,s=.8*t,n=.8*e,5===o?r.fillRect(i-t,a-e,s,n):4===o?r.fillRect(i+t-s,a-e,s,n):2===o?r.fillRect(i-t,a+e-n,s,n):3===o&&r.fillRect(i+t-s,a+e-n,s,n)):r.vhide())},drawTargetTriangle:function(){var t=this.vinc("target_triangle","auto"),e=this.range,i=this.puzzle.cursor;i.bx<e.x1||e.x2<i.bx||i.by<e.y1||e.y2<i.by||(e=i.detectTarget(),t.vid="target_triangle",t.fillStyle=this.ttcolor,this.puzzle.editmode&&0!==e?4===i.targetdirs?this.drawTriangle2(i.bx*this.bw,i.by*this.bh,e):this.drawTriangle1(i.bx*this.bw,i.by*this.bh,4===e?4:2):t.vhide())},drawStartGoal:function(){var t=this.vinc("cell_sg","auto"),e=this.board,i=this.range,s=(t.vid="text_stpos",e.startpos?e.startpos.getc():e.emptycell);s.bx>=i.x1&&i.x2>=s.bx&&s.by>=i.y1&&i.y2>=s.by&&(s.isnull?t.vhide():(t.fillStyle=this.puzzle.mouse.draggingSG&&10===this.puzzle.mouse.inputData?"red":1===s.qans?this.fontShadecolor:this.quescolor,this.disptext("S",s.bx*this.bw,s.by*this.bh))),t.vid="text_glpos",(s=e.goalpos.getc()).bx>=i.x1&&i.x2>=s.bx&&s.by>=i.y1&&i.y2>=s.by&&(s.isnull?t.vhide():(t.fillStyle=this.puzzle.mouse.draggingSG&&11===this.puzzle.mouse.inputData?"red":1===s.qans?this.fontShadecolor:this.quescolor,this.disptext("G",s.bx*this.bw,s.by*this.bh)))},fillStar:function(t,e,i,s,n){var r=[0,.235,.95,.38,.588,0,-.588,-.38,-.95,-.235],o=[-1,-.309,-.309,.124,.809,.4,.809,.124,-.309,-.309];t.beginPath(),t.moveTo(e,i-n);for(var a=1;a<10;a++)t.lineTo(e+s*r[a],i+n*o[a]);t.closePath(),t.fill()},getDotFillColor:function(t){return 1===t.getDot()?"white":2===t.getDot()?t.iserror()?this.errcolor1:this.quescolor:null},getDotOutlineColor:function(t){return 1===t.getDot()?t.iserror()?this.errcolor1:this.quescolor:null},getDotRadius:function(t){return.18},drawDots:function(){for(var t=this.vinc("dot","auto"),e=(t.lineWidth=Math.max(.04*this.cw,1),this.range),i=this.board.dotinside(e.x1,e.y1,e.x2,e.y2),s=0;s<i.length;s++){var n=i[s],r=n.bx,o=n.by,a=(t.vid="s_dot_"+n.id,this.getDotOutlineColor(n)),h=this.getDotFillColor(n);h||a?(t.strokeStyle=a,t.fillStyle=h,t.shapeCircle(r*this.bw,o*this.bh,this.cw*this.getDotRadius(n))):t.vhide()}},drawDashedCenterLines:function(){var t=this.vinc("centerline","crispEdges",!0),e=this.board,i=this.range.x1,s=this.range.y1,n=this.range.x2,r=this.range.y2,o=(i<e.minbx+1&&(i=e.minbx+1),n>e.maxbx-1&&(n=e.maxbx-1),s<e.minby+1&&(s=e.minby+1),r>e.maxby-1&&(r=e.maxby-1),i-=1&~i,s-=1&~s,n+=1&~n,r+=1&~r,this.getDashArray());t.lineWidth=1,t.strokeStyle=this.gridcolor;for(var a=i;a<=n;a+=2){var h=a*this.bw,l=s*this.bh,c=r*this.bh;t.vid="cliney_"+a,t.strokeDashedLine(h,l,h,c,o)}for(a=s;a<=r;a+=2){var u=a*this.bh,d=i*this.bw,f=n*this.bw;t.vid="clinex_"+a,t.strokeDashedLine(d,u,f,u,o)}},getDashArray:function(){var t=Math.max(Math.round(this.cw/10),4),e=this.cw/t,i=5/8*e,s=e-i,n=[];n.push(i/2,s);for(var r=0;r<t-1;r++)n.push(i,s);return n.push(i/2),n.push(0),n},drawGrid:function(t,e){var i=this.vinc("grid","crispEdges",!0),s=this.board,n=Math.max(s.minbx,0),r=Math.min(s.maxbx,2*s.cols),o=Math.max(s.minby,0),a=Math.min(s.maxby,2*s.rows),h=this.range.x1,l=this.range.y1,c=this.range.x2,u=this.range.y2;if(h<n&&(h=n),l<o&&(l=o),a<u&&(u=a),l-=1&l,!((c=r<c?r:c)<=(h-=1&h)||u<=l)){var s=2!==s.hasborder&&!1!==t?2:0,d=this.bw,f=this.bh,t=Math.max(h,n+s),b=Math.min(c,r-s),n=Math.max(l,o+s),p=Math.min(u,a-s);i.lineWidth=this.gw,i.strokeStyle=this.gridcolor;for(var m,g=t;g<=b;g+=2)i.vid="bdy_"+g,!1!==e?i.strokeLine(m=g*d,l*f,m,u*f):i.vhide();for(var v,g=n;g<=p;g+=2)i.vid="bdx_"+g,!1!==e?i.strokeLine(h*d,v=g*f,c*d,v):i.vhide()}},drawDashedGrid:function(t){var e=this.vinc("grid","crispEdges",!0),i=this.board,s=Math.max(i.minbx,0),n=Math.min(i.maxbx,2*i.cols),r=Math.max(i.minby,0),i=Math.min(i.maxby,2*i.rows),o=this.range.x1,a=this.range.y1,h=this.range.x2,l=this.range.y2,c=(o<s&&(o=s),n<h&&(h=n),a<r&&(a=r),i<l&&(l=i),o-=1&o,a-=1&a,h+=1&h,l+=1&l,this.getDashArray()),t=!1!==t?2:0,u=this.bw,d=this.bh,s=Math.max(o,s+t),f=Math.min(h,n-t),n=Math.max(a,r+t),b=Math.min(l,i-t);e.lineWidth=this.gw,e.strokeStyle=this.gridcolor;for(var p=s;p<=f;p+=2){var m=p*u,g=a*d,v=l*d;e.vid="bdy_"+p,e.strokeDashedLine(m,g,m,v,c)}for(p=n;p<=b;p+=2){var y=p*d,x=o*u,k=h*u;e.vid="bdx_"+p,e.strokeDashedLine(x,y,k,y,c)}},drawChassis:function(t){var e=this.vinc("chassis","crispEdges",!0),i=this.board,s=t?-.5*i.minbx*this.cw:0,t=t?-.5*i.minby*this.ch:0,n=i.cols*this.cw,i=i.rows*this.ch,r=this.lw,o=this.lm;"bosanowa"===this.pid&&(r=1,o=.5),e.fillStyle=this.quescolor,e.vid="chs1_",e.fillRect(-o,-t-o,r,i+t+r),e.vid="chs2_",e.fillRect(n-o,-t-o,r,i+t+r),e.vid="chs3_",e.fillRect(-s-o,-o,n+s+r,r),e.vid="chs4_",e.fillRect(-s-o,i-o,n+s+r,r)},drawChassis_ex1:function(t){var e=this.vinc("chassis_ex1","crispEdges",!0),i=this.board,s=this.range.x1,n=this.range.y1,r=this.range.x2,o=this.range.y2,a=(s<=0&&i.minbx,r>i.maxbx&&i.maxbx,n<=0&&i.minby,o>i.maxby&&i.maxby,this.lw),h=this.lm,s=i.cols*this.cw,r=i.rows*this.ch;if(e.fillStyle=this.quescolor,e.vid="chsex1_1_",e.fillRect(-this.cw-h,-this.ch-h,a,r+this.ch+a),e.vid="chsex1_2_",e.fillRect(s-h,-this.ch-h,a,r+this.ch+a),e.vid="chsex1_3_",e.fillRect(-this.cw-h,-this.ch-h,s+this.cw+a,a),e.vid="chsex1_4_",e.fillRect(-this.cw-h,r-h,s+this.cw+a,a),t)e.vid="chs1_",e.fillRect(-h,-h,a,r+a-1),e.vid="chs2_",e.fillRect(-h,-h,s+a-1,a);else{e.vid="chs1_",e.fillRect(-.5,-.5,1,r),e.vid="chs2_",e.fillRect(-.5,-.5,s,1);for(var l=this.range.cells,c=0;c<l.length;c++){var u=l[c],d=(u.bx-1)*this.bw,f=(u.by-1)*this.bh;1===u.bx&&(e.vid="chs1_sub_"+u.by,51!==u.ques?e.fillRect(-h,f-h,a,this.ch+a):e.vhide()),1===u.by&&(e.vid="chs2_sub_"+u.bx,51!==u.ques?e.fillRect(d-h,-h,this.cw+a,a):e.vhide())}}},lastBankPieceCount:0,drawBank:function(){if(this.showBank&&(this.range.bank||0!==this.range.bankPieces.length)){for(var t=this.vinc("piecebank"),e=this.board,i=Math.max(e.bank.pieces.length,this.lastBankPieceCount),s=0;s<i;s++){var n=e.bank.pieces[s];!this.range.bank&&-1===this.range.bankPieces.indexOf(n)||this.drawBankPiece(t,n,s)}this.drawBankAddButton(),this.lastBankPieceCount=e.bank.pieces.length}},drawBankPiece:function(t,e,i){},getBankPieceColor:function(t){return t.error?this.errcolor1:t.qcmp?this.qcmpcolor:this.quescolor},drawBankAddButton:function(){var t=this.vinc("piecebank_add","crispEdges"),e=this.board.bank.addButton,i=this.puzzle.editmode&&!this.outputImage&&null!==e.index&&(this.range.bank||-1!==this.range.bankPieces.indexOf(e));if(null!==e.index&&(this.range.bank||-1!==this.range.bankPieces.indexOf(e))){for(var s=this.bankratio,n=this.cw*s*(e.x+.25)+1,r=this.ch*s*(e.y+.25)+1,o=(r+=(this.board.rows+this.bankVerticalOffset)*this.ch,n+this.cw*s*e.w-1),a=r+this.ch*s*e.h-1,h=0;h<4;h++)t.vid="pb_piece_add_"+h,i?(t.strokeStyle="blue",t.strokeDashedLine(h<2?n:o,h<2?r:a,h%2?n:o,h%2?a:r,[3])):t.vhide();t.vid="pb_piece_add_symbol",i?(t.fillStyle="blue",this.disptext("+",n+.5*s*this.cw*e.w,r+.5*s*this.ch*e.h,{style:"bold"})):t.vhide()}}}}),p.classmgr.makeCommon({KeyEvent:{key_inputcross:function(t){var e=this.cursor.getx(),i=e.getmaxnum(),s=-1;if("0"<=t&&t<="9"){var n=+t,r=e.qnum;if(i<(s=10*(r=r<=0||i<10*r+n?0:r)+n))return}else if("-"===t)s=-2!==e.qnum?-2:-1;else{if(" "!==t&&"BS"!==t)return;s=-1}e.setQnum(s),e.draw()},key_inputqnum:function(t){var e=this.cursor.getc();e.enableSubNumberArray&&this.puzzle.playmode&&"shift"===t&&e.noNum()?this.cursor.chtarget():this.key_inputqnum_main(e,t)},key_inputqnum_main:function(t,e){var i=t,s=this.puzzle,n=s.board;if(s.editmode&&n.roommgr.hastop)i=t=t.room.top;else if(s.execConfig("dispmove"))if(t.isDestination())t=t.base;else if(0<t.lcnt)return;if(t.enableSubNumberArray&&2<=this.cursor.targetdir){var r,n=[-1,-1,2,3,1,0][this.cursor.targetdir];if(-1===n)return;if(null===(r=this.getNewNumber(t,e,t.snum[n])))return;t.setSnum(n,r)}else{if(null===(r=this.getNewNumber(t,e,t.getNum())))return;t.setNum(r),t.numberWithMB&&t.enableSubNumberArray&&" "===e&&t.clrSnum()}s.execConfig("dispmove")&&t.noNum()&&t.eraseMovedLines(),i.draw(),this.prev=t,this.cancelDefault=!0},getNewNumber:function(t,e,i){var s=t.getmaxnum(),n=t.getminnum(),r=null;if("0"<=e&&e<="9"&&!t.numberAsLetter){var o=+e;(s<(r=10*(i=i<=0||s<10*i+o||this.prev!==t?0:i)+o)||0<n&&0===r)&&(r=null)}else if("a"<=e&&e<="z"&&1===e.length&&t.numberAsLetter){if(1<e.length&&"BS"!==e)return null;o=parseInt(e,36)-10;(s<(r=0<i&&(i-1)%26===o?i<=26?i+26:-1:o+1)||0<n&&0===r)&&(r=null)}else r="BS"===e?i<10||t.numberAsLetter?-1:i/10|0:"-"===e?this.puzzle.editmode&&!t.disInputHatena?-2:-1:" "===e?-1:"s1"===e?-2:"s2"===e?-3:"s3"===e?-4:"s4"===e?-5:null;return r},key_inputqnums:function(t){var e=this.cursor.getc(),i=e.qnums,s=[];if("0"<=t&&t<="9"||"-"===t){var n="-"!==t?+t:-2;if(-2!=n&&(n<e.getminnum()||n>e.getmaxnum()))return;this.prev===e&&(s=i.slice());var r=e.distinctQnums&&-2!=n?s.indexOf(n):-1;0<=r?s.splice(r,1):s.push(n),e.isValidQnums(s)||(s=[n])}else if("BS"===t){if(1<i.length)for(var o=0;o<i.length-1;o++)s.push(i[o])}else{if(" "!==t)return;s=[]}e.setQnums(s),e.setQans(0),e.setQsub(0),(this.prev=e).draw()},key_inputexcell:function(t){var e=this.cursor.getex();if(!e.isnull){var i=e.qnum,s=e.getmaxnum();if("0"<=t&&t<="9"){var n=+t;!(i<=0||this.prev!==e)&&10*i+n<=s?e.setQnum(10*i+n):n<=s&&e.setQnum(n)}else{if(" "!==t&&"-"!==t)return;e.setQnum(-1)}this.prev=e,this.cursor.draw()}},key_inputarrow:function(t){return this.key_inputdirec_common(t,!1)},key_inputdirec:function(t){return this.key_inputdirec_common(t,!0)},key_inputdirec_common:function(t,e){var i=this.cursor.getc();if(e&&-1===i.getNum())return!1;var s=i.NDIR;switch(t){case"shift+up":s=i.UP;break;case"shift+down":s=i.DN;break;case"shift+left":s=i.LT;break;case"shift+right":s=i.RT}return s!==i.NDIR&&(i.setQdir(i.qdir!==s?s:i.NDIR),!1===e?i.setNum(-1):-1===i.getNum()&&i.setNum(-2),this.cursor.draw(),!0)},inputnumber51:function(t){var e=this.cursor;if("shift"===t)e.chtarget();else{var i=e.getobj(),s=e.detectTarget(i);if((0===s||"cell"===i.group&&i.is51cell())&&"q"===t&&!i.isnull)return i.is51cell()?i.remove51cell():i.set51cell(),void e.drawaround();if(0!==s){var n=this.klass.Cell.prototype[s===i.RT?"qnum":"qnum2"],r=i.getmaxnum(),o=n;if("0"<=t&&t<="9"){var a=+t;if(r<(o=10*(h=(h=this.getnum51(i,s))<=0||r<10*h+a||this.prev!==i?0:h)+a))return}else if("BS"===t)var h,o=10<=(h=this.getnum51(i,s))?h/10|0:n;else{if("-"!==t&&" "!==t)return;o=n}this.setnum51(i,s,o),this.prev=i,e.draw()}}},setnum51:function(t,e,i){t.setQnumDir(e,i)},getnum51:function(t,e){return t.getQnumDir(e)}}}),p.classmgr.makeCommon({MouseEvent:{inputShade:function(){this.inputcell()},inputcell:function(){var t=this.getcell();if(!t.isnull&&t!==this.mouseCell){null===this.inputData&&this.decIC(t),this.mouseCell=t,this.initFirstCell(t);if((1!==this.inputData||t.allowShade())&&(2!==this.inputData||t.allowUnshade())){if(this.RBShadeCell&&1===this.inputData){var e=this.firstCell;if((2&e.bx^2&e.by)!=(2&t.bx^2&t.by))return}this.RBShadeCell&&1!==this.inputData&&1!==this.firstState&&1===t.qans&&"right"===this.btn||(t.setQans(1===this.inputData?1:0),t.setQsub(2===this.inputData?1:0),t.draw())}}},initFirstCell:function(t){this.firstCell.isnull&&(this.firstCell=t,this.firstState=t.qans)},decIC:function(t){"shade"===this.inputMode?this.inputData=1!==t.qans?1:0:"unshade"===this.inputMode?this.inputData=1!==t.qsub?2:0:1===this.puzzle.getConfig("use")&&"patchwork"!==this.pid?"left"===this.btn?this.inputData=1!==t.qans?1:0:"right"===this.btn&&(this.inputData=1!==t.qsub?2:0):t.allowShade()?t.allowUnshade()?"left"===this.btn?1===t.qans?this.inputData=2:1===t.qsub?this.inputData=0:this.inputData=1:"right"===this.btn&&(1===t.qans?this.inputData=0:1===t.qsub?this.inputData=1:this.inputData=2):this.inputData=1!==t.qans?1:0:this.inputData=1!==t.qsub?2:0},inputclean_cell:function(){var t,e=this.getcell();e.isnull||e===this.mouseCell||(this.mouseCell=e,t=new this.klass.CellList([e]),this.puzzle.playmode?t.ansclear():t.allclear(),e.draw())},inputqnum:function(){var t=this.getcell();t.isnull||t===this.mouseCell||(this.cursor.modesnum&&this.puzzle.playmode&&!this.cursor.checksnum(this.inputPoint)&&t.noNum()?this.setcursorsnum(t):t!==this.cursor.getc()?this.setcursor(t):this.inputqnum_main(t),this.mouseCell=t)},inputqnum_main:function(t){var e=t,i=this.puzzle;if(!i.playmode||t.qnum===i.klass.Cell.prototype.qnum||i.klass.Cell.prototype.supportQnumAnum){if(i.editmode&&i.board.roommgr.hastop)e=t=t.room.top;else if(i.execConfig("dispmove"))if(t.isDestination())t=t.base;else if(0<t.lcnt)return;if(t.enableSubNumberArray&&i.playmode&&2<=this.cursor.targetdir){var s=[-1,-1,2,3,1,0][this.cursor.targetdir];if(-1===s)return;t.setSnum(s,this.getNewNumber(t,t.snum[s]))}else i.editmode&&51===t.ques?(s=i.cursor.detectTarget(t),i.key.setnum51(t,s,this.getNewNumber(t,i.key.getnum51(t,s)))):t.setNum(this.getNewNumber(t,t.getNum()));i.execConfig("dispmove")&&t.noNum()&&t.eraseMovedLines(),e.draw()}},getNewNumber:function(t,e){var i=this.puzzle,s=i.editmode&&!t.disInputHatena,n=t.getmaxnum(),r=t.getminnum(),o=-1,a=t.qsub,h=0;return i.editmode?(h=-1,this.puzzle.painter.enablebcolor&&(a=0)):2<=this.cursor.targetdir?a=h=0:t.numberWithMB?(h=2,a=t.qsub):"roma"===i.pid||"arrowflow"===i.pid||"yinyang"===i.pid?h=0:!t.numberAsObject&&"hebi"!==i.pid||(h=1),"left"===this.btn?o=n<=e?1<=h?-2:-1:1===a?2<=h?-3:-1:2===a?-1:-1===e?s?-2:r:e<r?r:e+1:"right"===this.btn&&(o=1===a?n:2===a?-2:-1===e?1===h?-2:2===h?-3:n:n<e?n:e<=r&&-2!==e?s?-2:-1:-2===e?-1:e-1),o},inputFixedNumber:function(t){var e,i=this.getcell();i.isnull||i===this.mouseCell||(-1===(e=i.getNum())&&0<i.qsub&&(e=-1-i.qsub),null===this.inputData&&(this.inputData=e===t?-1:t),e===t&&-1!==this.inputData||(i.setNum(this.inputData),i.draw()),this.mouseCell=i)},inputQues:function(t){var e=this.getcell();e.isnull||(e!==this.cursor.getc()&&"auto"===this.inputMode?this.setcursor(e):this.inputQues_main(t,e))},inputQues_main:function(t,e){var i=e.ques,s=t.length;if("left"===this.btn){for(var n=0;n<=s-1;n++)if(i===t[n]){e.setQues(t[n<s-1?n+1:0]);break}}else for(n=s-1;0<=n;n--)if(i===t[n]){e.setQues(t[0<n?n-1:s-1]);break}e.draw()},inputMB:function(){var t=this.getcell();t.isnull||(t.setQsub(("left"===this.btn?[1,2,0]:[2,0,1])[t.qsub]),t.draw())},inputFixedQsub:function(t){var e=this.getcell();e.isnull||e.is51cell()||e===this.mouseCell||(null===this.inputData&&(this.inputData=e.qsub!==t?t:0),e.setQsub(this.inputData),e.draw(),this.mouseCell=e)},inputBGcolor:function(){var t=this.getcell();t.isnull||t.is51cell()||t===this.mouseCell||(null===this.inputData&&("bgcolor1"===this.inputMode?this.inputMode=1!==t.qsub?11:10:"bgcolor2"===this.inputMode?this.inputMode=2!==t.qsub?12:10:"left"===this.btn?0===t.qsub?this.inputData=11:1===t.qsub?this.inputData=12:this.inputData=10:0===t.qsub?this.inputData=12:1===t.qsub?this.inputData=10:this.inputData=11),t.setQsub(this.inputData-10),t.draw(),this.mouseCell=t)},inputdirec:function(){var t,e,i=this.getpos(0);this.prevPos.equals(i)||((t=this.prevPos.getc()).isnull||-1===t.qnum||(e=this.prevPos.getdir(i,2))!==t.NDIR&&(t.setQdir(t.qdir!==e?e:0),t.draw()),this.prevPos=i)},inputarrow_cell:function(){var t=this.getpos(0);if(!this.prevPos.equals(t)||1!==this.inputData){t.NDIR;var e,i=this.prevPos.getc();if(!i.isnull)if((e=this.prevPos.getdir(t,2))!==t.NDIR)return this.inputarrow_cell_main(i,e),i.draw(),void this.mousereset();this.prevPos=t}},inputarrow_cell_main:function(t,e){t.numberAsObject?t.setNum(e):t.setQdir(e)},inputtile:function(){var t=this.getcell();if(!t.isnull&&!t.is51cell()&&t!==this.mouseCell){null===this.inputData&&this.decIC(t);for(var e=(this.mouseCell=t).room.clist,i=0;i<e.length;i++){var s=e[i];1!==this.inputData&&3===s.qsub||((1===this.inputData?s.setShade:s.clrShade).call(s),s.setQsub(2===this.inputData?1:0))}e.draw()}},inputIcebarn:function(){var t=this.getcell();t.isnull||t===this.mouseCell||(null===this.inputData&&(this.inputData=t.ice()?0:6),t.setQues(this.inputData),t.drawaround(),this.mouseCell=t)},input51:function(){var t,e=this.getcell_excell();e.isnull||("excell"===(t=e.group)||"cell"===t&&e!==this.cursor.getc()?this.setcursor(e):"cell"===t&&this.input51_main(e))},input51_main:function(t){var e,i;"right"===this.btn?t.remove51cell():"left"===this.btn&&(t.is51cell()?(e=this.inputPoint.bx-t.bx,i=this.inputPoint.by-t.by,this.cursor.chtarget(!0,e,i)):t.set51cell()),t.drawaround()},input51_fixed:function(){var t=this.getcell();t.isnull||t===this.mouseCell||("clear"===this.inputMode?(t.remove51cell(),this.inputData=0):"cell51"!==this.inputMode||t.is51cell()||(t.set51cell(),this.inputData=51),t.drawaround(),this.mouseCell=t)},inputqnum_cell51:function(){var t=this.getcell_excell();t.isnull||this.mouseCell===t&&!this.mouseend||(!this.mousestart||t===this.cursor.getobj()&&51===t.ques?this.mousestart&&this.cursor.getNumOfTarget(t)<2||this.mouseend?(this.inputqnum_main(t),this.mousereset()):(this.mouseCell=t,this.inputselect_cell51(t)):(this.setcursor(t),this.mousereset()))},inputselect_cell51:function(t){var e;this.mousestart?this.prevPos=this.getpos(0):this.mousemove&&((e=this.prevPos.getdir(this.getpos(0),2))!==t.RT&&e!==t.DN||e===this.cursor.targetdir||(this.cursor.targetdir=e,this.cursor.draw()),e!==t.NDIR&&this.mousereset())},inputqnum_cross:function(){var t=this.getcross();t.isnull||t===this.mouseCell||(t!==this.cursor.getx()?this.setcursor(t):this.inputqnum_main(t),this.mouseCell=t)},inputcross_main:function(t){"left"===this.btn?t.setQnum(4!==t.qnum?t.qnum+1:-2):"right"===this.btn&&t.setQnum(-2!==t.qnum?t.qnum-1:4),t.draw()},inputcrossMark:function(){var t,e,i=this.getpos(.24);i.oncross()&&(t=2===(e=this.board).hascross?0:2,i.bx<e.minbx+t||i.bx>e.maxbx-t||i.by<e.minby+t||i.by>e.maxby-t||((e=i.getx()).isnull||(this.puzzle.opemgr.disCombine=!0,e.setQnum(1===e.qnum?-1:1),this.puzzle.opemgr.disCombine=!1,e.draw())))},inputclean_cross:function(){var t,e=this.getcross();e.isnull||e===this.mouseCell||(this.mouseCell=e,t=new this.klass.CrossList([e]),this.puzzle.playmode?t.ansclear():t.allclear(),e.draw())},inputborder:function(){var t,e=this.getpos(.35);this.prevPos.equals(e)||((t=this.prevPos.getborderobj(e)).isnull||(null===this.inputData&&(this.inputData=t.isBorder()?0:1),1===this.inputData?t.setBorder():0===this.inputData&&t.removeBorder(),t.draw()),this.prevPos=e)},inputQsubLine:function(){var t,e=this.getpos(0);this.prevPos.equals(e)||((t=this.prevPos.getnb(e)).isnull||(null===this.inputData&&(this.inputData=0===t.qsub?1:0),1===this.inputData?t.setQsub(1):0===this.inputData&&t.setQsub(0),t.draw()),this.prevPos=e)},inputLine:function(){if(this.puzzle.execConfig("dispmove"))this.inputMoveLine();else{var t,e,i=this.getcell();if(this.initFirstCell(i),this.board.borderAsLine){if(t=this.getpos(.35),this.prevPos.equals(t))return;e=this.prevPos.getborderobj(t)}else{if(t=this.getpos(0),this.prevPos.equals(t))return;e=this.prevPos.getnb(t)}e.isnull||(null===this.inputData&&(this.inputData=e.isLine()?0:1),1===this.inputData?e.setLine():0===this.inputData&&e.removeLine(),e.draw()),this.prevPos=t}},inputMoveLine:function(){for(var t=!0,e=this.getcell();t;){var t=!1,i=this.mouseCell&&!this.mousestart?this.mouseCell.getOrthogonalCell(e):e;if(i.isnull)return;var s=this.mouseCell,n=i.getaddr();if(this.mousestart&&i.isDestination())this.mouseCell=i,this.prevPos=n,i.draw();else if(this.mousemove&&!s.isnull){if(s.path&&i.path&&i.path!==s.path){if(i.isDeparture()&&!i.isDestination())return;if(-1===s.base.qnum==(-1===i.base.qnum))return}var r=this.prevPos.getnb(n);!r.isnull&&(!r.isLine()&&i.lcnt<=1||r.isLine()&&1===s.lcnt)&&((s=r.isLine())?r.removeLine():r.setLine(),this.puzzle.opemgr.changeflag=!0,s!==r.isLine()&&(i.isDestination()?(this.mouseCell=i,this.prevPos=n,t=!0):(this.mouseCell=this.board.emptycell,i.base.draw(),i.path.destination.draw()),r.draw()))}}},inputpeke:function(){var t,e=this.getpos(.22);this.prevPos.equals(e)||((t=e.getb()).isnull||(null===this.inputData&&(this.inputData=2!==t.qsub?2:3),2===this.inputData&&t.isLine()&&this.puzzle.execConfig("dispmove")||(2===this.inputData?t.setPeke():3===this.inputData&&this.puzzle.execConfig("dispmove")?t.setQsub(0):3===this.inputData&&t.removeLineAndQsub()),t.draw()),this.prevPos=e)},inputpeke_ifborder:function(){var t=this.getpos(.22).getb();return"border"===t.group&&!t.isnull&&(this.inputpeke(),!0)},inputdiraux_mousedown:function(){var t=this.getpos(.22).getb();t.isnull||(this.inputData=t.isnull||2!==t.qsub?2:3,this.inputpeke())},inputdiraux_mousemove:function(){var t,e,i,s=this.getpos(0);s.getc().isnull||((t=this.prevPos.getnb(s)).isnull||(e=null,i=this.prevPos.getdir(s,2),null===this.inputData&&(this.inputData=t.qsub!==10+i?11:0),11===this.inputData?e=10+i:0===this.inputData&&t.qsub===10+i&&(e=0),null!==e&&(t.setQsub(e),t.draw())),this.prevPos=s)},clickdiraux:function(){var t,e,i=this.getpos(.22);this.prevPos.equals(i)||((i=i.getb()).isnull||(t={0:2,2:0},e=i.qsub,e=(t=i.isvert?"left"===this.btn?{0:2,2:13,13:14,14:0}:{0:14,14:13,13:2,2:0}:"left"===this.btn?{0:2,2:11,11:12,12:0}:{0:12,12:11,11:2,2:0})[e]||0,"diraux"===this.inputMode&&2===e&&(e=t[e]||0),i.setQsub(e),i.draw()))},inputTateyoko:function(){var t,e,i,s;this.mouseend&&this.notInputted()&&this.clickTateyoko?this.clickTateyoko():(t=this.getcell()).isnull||("amibo"!==this.pid&&1===t.ques||"amibo"===this.pid&&t.isNum()||(this.mouseCell!==t?this.firstPoint.set(this.inputPoint):null!==this.firstPoint.bx&&(e=null,s=this.inputPoint.bx-this.firstPoint.bx,(i=this.inputPoint.by-this.firstPoint.by)<=-.5||.5<=i?e=1:(s<=-.5||.5<=s)&&(e=2),null!==e&&(i="amibo"===this.pid||"tatamibari"===this.pid,s=0,s=this.puzzle.playmode?{0:0,11:3,12:1,13:2}[t.qans]:{"-1":0,1:3,2:1,3:2}[t.qnum],(null===this.inputData?s&e:this.inputData<=0)&&(e=i?-e:0),i?0<e?s|=e:s&=~-e:s=e,this.puzzle.playmode?t.setQans([0,12,13,11][s]):t.setQnum([-1,2,3,1][s]),t.draw(),this.inputData=+(0<e),this.firstPoint.reset(),"tatamibari"!==this.pid&&"ladders"!==this.pid||this.mousereset()))),this.mouseCell=t)},inputempty:function(){var t=this.getcell();t.isnull||t===this.mouseCell||(null===this.inputData&&(this.inputData=t.isEmpty()?0:7),t.setValid(this.inputData),this.mouseCell=t)},mouseinputAutoEdit_qnum:function(){this.mousestart&&this.inputqnum()},mouseinputAutoEdit_areanum:function(){this.mousestart||this.mousemove?this.inputborder():this.mouseend&&this.notInputted()&&this.inputqnum()},mouseinputAutoPlay_cell:function(){this.inputcell()},mouseinputAutoPlay_cellpeke:function(){this.mousestart&&(this.isDraggingPeke=this.puzzle.key.isALT),this.isDraggingPeke?this.inputpeke():this.inputcell()},mouseinputAutoPlay_qnum:function(){this.mousestart&&this.inputqnum()},mouseinputAutoPlay_border:function(){(this.mousestart||this.mousemove)&&("left"===this.btn&&this.isBorderMode()?this.inputborder():this.inputQsubLine())},mouseinputAutoPlay_line:function(t){"left"===this.btn?(this.mousestart||this.mousemove)&&this.inputLine():"right"===this.btn&&(this.mousestart||this.mousemove)&&this.inputpeke(),this.mouseend&&this.notInputted()&&(this.prevPos=new this.klass.Address,!this.inputpeke_ifborder()&&t&&this.inputMB())},mouseinputAutoPlay_lineMB:function(){this.mouseinputAutoPlay_line(!0)},dispInfoBlk:function(){var t=this.getcell();this.mousereset(),!t.isnull&&t.isShade()&&(this.RBShadeCell?this.dispInfoBlk8(t):t.sblk.clist.setinfo(1),this.board.hasinfo=!0,this.puzzle.redraw())},dispInfoUblk:function(){var t=this.getcell();this.mousereset(),!t.isnull&&t.isUnshade()&&(t.ublk.clist.setinfo(1),this.board.hasinfo=!0,this.puzzle.redraw())},dispInfoBlk8:function(t){for(var e=[t];0<e.length;){var i=e.pop();if(0===i.qinfo){i.setinfo(1);for(var s=i.bx,i=i.by,n=this.board.cellinside(s-2,i-2,s+2,i+2),r=0;r<n.length;r++){var o=n[r];0===o.qinfo&&o.isShade()&&e.push(o)}}}},dispInfoLine:function(){var t=this.board,e=this.getborder(.15);if(this.mousereset(),!e.isnull){if(!e.isLine()){var i=t.borderAsLine?this.getcross():this.getcell();if(i.isnull||t.linegraph.isLineCross&&(3===i.lcnt||4===i.lcnt))return;i=i.adjborder;if(i.left.isLine())e=i.left;else if(i.right.isLine())e=i.right;else if(i.top.isLine())e=i.top;else{if(!i.bottom.isLine())return;e=i.bottom}}e.isnull||(t.border.setinfo(-1),e.path.setedgeinfo(1),t.hasinfo=!0,this.puzzle.redraw())}}}}),p.classmgr.makeCommon({AnsCheck:{checkAllCell:function(t,e){for(var i=0;i<this.board.cell.length;i++){var s=this.board.cell[i];if(7!==s.ques&&t(s)){if(this.failcode.add(e),this.checkOnly)break;s.seterr(1)}}},checkNoNumCell:function(){this.checkAllCell(function(t){return 0===t.ques&&t.noNum()},"ceNoNum")},checkIceLines:function(){this.checkAllCell(function(t){return t.ice()&&t.isLineCurve()},"lnCurveOnIce")},checkNotCrossOnMark:function(){this.checkAllCell(function(t){return 4!==t.lcnt&&11===t.ques},"lnNotCrossMk")},checkLineOnShadeCell:function(){this.checkAllCell(function(t){return(1===t.ques||1===t.qans)&&0<t.lcnt},"lnOnShade")},checkNoLineObject:function(){this.checkAllCell(function(t){return 0===t.lcnt&&t.isNum()},"nmNoLine")},checkLineOverLetter:function(){this.checkAllCell(function(t){return 2<=t.lcnt&&t.isNum()},this.board.linegraph.moveline?"laOnNum":"lcOnNum")},checkNumberHasArrow:function(){this.checkAllCell(function(t){return 0<=t.qnum&&t.qdir===t.NDIR},"anNoArrow")},checkDir4Cell:function(t,e,i){for(var s=0;s<this.board.cell.length;s++){var n=this.board.cell[s];if(n.isValidNum()){var r=n.getNum(),o=n.countDir4Cell(t);if(!(0===e&&r===o||1===e&&r<=o||2===e&&o<=r)){if(this.failcode.add(i),this.checkOnly)break;n.seterr(1)}}}},checkSideCell:function(t,e,i){for(var s=!0,n=this.board,r=0;r<n.cell.length;r++){var o=n.cell[r],a=o.adjacent.right;if(o.bx<n.maxbx-1&&t(o,a)){if(s=!1,this.checkOnly)break;!1!==i&&(o.seterr(1),a.seterr(1))}if(a=o.adjacent.bottom,o.by<n.maxby-1&&t(o,a)){if(s=!1,this.checkOnly)break;!1!==i&&(o.seterr(1),a.seterr(1))}}s||this.failcode.add(e)},checkAdjacentShadeCell:function(){this.checkSideCell(function(t,e){return t.isShade()&&e.isShade()},"csAdjacent")},checkAdjacentDiffNumber:function(){this.checkSideCell(function(t,e){return t.sameNumber(e)},"nmAdjacent")},checkAroundCell:function(t,e){for(var i=this.board,s=0;s<i.cell.length;s++){var n=i.cell[s],r=null,o=new this.klass.CellList;if(o.add(n),r=n.relcell(2,0),t(n,r)&&o.add(r),r=n.relcell(0,2),t(n,r)&&o.add(r),r=n.relcell(-2,2),t(n,r)&&o.add(r),r=n.relcell(2,2),t(n,r)&&o.add(r),!(o.length<=1)){if(this.failcode.add(e),this.checkOnly)break;o.seterr(1)}}},check2x2Block:function(t,e){for(var i=this.board,s=0;s<i.cell.length;s++){var n=i.cell[s];if(!(n.bx>=i.maxbx-1||n.by>=i.maxby-1)){var r=n.bx,n=n.by,r=i.cellinside(r,n,r+2,n+2).filter(t);if(!(r.length<4)){if(this.failcode.add(e),this.checkOnly)break;r.seterr(1)}}}},check2x2ShadeCell:function(){this.check2x2Block(function(t){return t.isShade()},"cs2x2")},check2x2UnshadeCell:function(){this.check2x2Block(function(t){return t.isUnshade()},"cu2x2")},checkSameColorTile:function(){this.checkSameObjectInRoom(this.board.roommgr,function(t){return t.isShade()?1:2},"bkMixed")},checkConnectShade:function(){this.checkOneArea(this.board.sblkmgr,"csDivide")},checkConnectUnshade:function(){this.checkOneArea(this.board.ublkmgr,"cuDivide")},checkConnectNumber:function(){this.checkOneArea(this.board.nblkmgr,"nmDivide")},checkOneArea:function(t,e){1<t.components.length&&(this.failcode.add(e),t.components[0].getnodeobjs().seterr(1))},checkConnectUnshadeRB:function(){if(1<this.board.ublkmgr.components.length){this.failcode.add("cuDivideRB");for(var t=new this.klass.CellList,e=this.board.cell.filter(function(t){return t.isShade()}),i=0;i<e.length;i++)for(var s=e[i],n=s.getdir4clist(),r=null,o=0;o<n.length;o++){var a=n[o][0];if(null===r)r=a.ublk;else if(r!==a.ublk){t.add(s);break}}t.seterr(1)}},checkShadeCellExist:function(){var t=this.board;if(t.sblkmgr.enabled){if(0<t.sblkmgr.components.length)return}else if(t.ublkmgr.enabled){if(0===t.ublkmgr.components.length||t.ublkmgr.components[0].nodes.length!==t.cell.length)return}else if(t.cell.some(function(t){return t.isShade()}))return;this.failcode.add("brNoShade")},doneShadingDecided:function(){this.board.cell.some(function(t){return!t.isShadeDecided()})&&this.failcode.setUndecided()},checkOneLoop:function(){this.checkOneLineBase("lnPlLoop")},checkOneLine:function(){this.checkOneLineBase("lnPlLine")},checkOneLineBase:function(t){var e=this.board,i=e.linegraph.components;1<i.length&&(this.failcode.add(t),e.border.setnoerr(),i[0].setedgeerr(1))},checkNumberExist:function(){this.board.cell.some(function(t){return t.isValidNum()})||this.failcode.add("brNoValidNum")},checkConnectAllNumber:function(){var t=this.board,e=t.linegraph.components;1<e.length&&(this.failcode.add("lcDivided"),t.border.setnoerr(),e[0].setedgeerr(1),e[0].clist.seterr(4))},checkLineExist:function(){var t=this.board;t.linegraph.ltotal[0]===(t.borderAsLine?t.cross:t.cell).length&&this.failcode.add("brNoLine")},checkCrossLine:function(){this.checkLineCount(4,"lnCross")},checkBranchLine:function(){this.checkLineCount(3,"lnBranch")},checkDeadendLine:function(){this.checkLineCount(1,"lnDeadEnd")},checkNoLine:function(){this.checkLineCount(0,this.board.borderAsLine?"cxNoLine":"ceNoLine")},checkNoLineIfVariant:function(){(this.puzzle.getConfig("slither_full")||this.puzzle.getConfig("loop_full"))&&this.checkNoLine()},checkLineCount:function(e,t){var i=!0,s=this.board;if(s.linegraph.ltotal[e])if(s.borderAsLine){for(var n=s.cross,r=0;r<n.length;r++){var o=n[r];if(o.lcnt===e){if(i=!1,this.checkOnly)break;0===e&&o.seterr(1),s.borderinside(o.bx-1,o.by-1,o.bx+1,o.by+1).seterr(1)}}i||(this.failcode.add(t),s.border.setnoerr())}else this.checkAllCell(function(t){return t.lcnt===e},t)},checkCrossConnectLine:function(){this.checkConnectLineCount(4,"lnCross")},checkBranchConnectLine:function(){this.checkConnectLineCount(3,"lnBranch")},checkDeadendConnectLine:function(){this.checkConnectLineCount(1,"lnDeadEnd")},checkConnectLineCount:function(e,t){this.board.linegraph.ltotal[e]&&this.checkAllCell(function(t){return t.noNum()&&t.lcnt===e},t)},checkenableLineParts:function(){for(var t=this.board,e=0;e<t.cell.length;e++){var i=t.cell[e],s=i.adjborder;if(s.top.isLine()&&i.noLP(i.UP)||s.bottom.isLine()&&i.noLP(i.DN)||s.left.isLine()&&i.noLP(i.LT)||s.right.isLine()&&i.noLP(i.RT)){if(this.failcode.add("ceAddLine"),this.checkOnly)break;i.seterr(1)}}},checkAllArea:function(t,e,i){this.checkAllBlock(t,null,e,i)},checkAllBlock:function(t,e,i,s){for(var n=t.components,r=0;r<n.length;r++){var o=n[r],a=o.clist,h=o.top||a.getQnumCell(),l=a.getRectSize(),c=(e?a.filter(e):a).length,h=h&&!h.isnull?h.qnum:-1;if(!i(l.cols,l.rows,c,h)){if(this.failcode.add(s),this.checkOnly)break;t.seterr?t.seterr(o,1):n!==this.board.linegraph?a.seterr("tateyoko"!==this.pid?1:4):(this.board.border.setnoerr(),o.objs.seterr(1))}}},checkNumberAndSize:function(){this.checkAllArea(this.board.roommgr,function(t,e,i,s){return s<=0||s===i},"bkSizeNe")},checkRoomRect:function(){this.checkAllArea(this.board.roommgr,function(t,e,i,s){return t*e===i},"bkNotRect")},checkNoNumber:function(){this.checkAllBlock(this.board.roommgr,function(t){return t.isNum()},function(t,e,i,s){return 0!==i},"bkNoNum")},checkDoubleNumber:function(){this.checkAllBlock(this.board.roommgr,function(t){return t.isNum()},function(t,e,i,s){return i<2},"bkNumGe2")},checkShadeCellCount:function(){this.checkAllBlock(this.board.roommgr,function(t){return t.isShade()},function(t,e,i,s){return s<0||s===i},"bkShadeNe")},checkNoShadeCellInArea:function(){this.checkAllBlock(this.board.roommgr,function(t){return t.isShade()},function(t,e,i,s){return 0<i||0===s},"bkNoShade")},checkLinesInArea:function(t,e,i){this.checkAllBlock(t,function(t){return 0<t.lcnt},e,i)},checkNoMovedObjectInRoom:function(t){this.checkAllBlock(t,function(t){return-1!==t.base.qnum},function(t,e,i,s){return 0!==i},"bkNoNum")},checkDisconnectLine:function(){this.checkConnectObjectCount(function(t){return 0<t},this.board.linegraph.moveline?"laIsolate":"lcIsolate")},checkConnectObject:function(){this.checkConnectObjectCount(function(t){return t<2},"nmConnected")},checkTripleObject:function(){this.checkConnectObjectCount(function(t){return t<3},"lcTripleNum")},checkConnectObjectCount:function(t,e){for(var i=!0,s=this.board.linegraph.components,n=0;n<s.length;n++){var r=s[n].clist;if(!t(r.filter(function(t){return-1!==t.qnum}).length)){if(i=!1,this.checkOnly)break;this.board.border.setnoerr(),s[n].setedgeerr(1),s[n].clist.seterr(4)}}i||(this.failcode.add(e),this.board.border.setnoerr())},checkSideAreaSize:function(t,e,i){for(var s=t.getSideAreaInfo(),n=0;n<s.length;n++){var r=e(s[n][0]),o=e(s[n][1]);if(!(r<=0||o<=0||r!==o)){if(this.failcode.add(i),this.checkOnly)break;s[n][0].clist.seterr(1),s[n][1].clist.seterr(1)}}},checkSideAreaCell:function(t,e,i){for(var s=0;s<this.board.border.length;s++){var n=this.board.border[s];if(n.isBorder()){var r=n.sidecell[0],o=n.sidecell[1];if(!r.isnull&&!o.isnull&&t(r,o,n)){if(this.failcode.add(i),this.checkOnly)break;e?(r.room.clist.seterr(1),o.room.clist.seterr(1)):(r.seterr(1),o.seterr(1))}}}},checkSameObjectInRoom:function(t,e,i){var s=t.components;t:for(var n=0;n<s.length;n++)for(var r=s[n].clist,o=-1,a=0;a<r.length;a++){var h=e(r[a]);if(-1!==h&&o!==h)if(-1===o)o=h;else{if(this.failcode.add(i),this.checkOnly)break t;s!==this.board.linegraph.components?r.seterr(1):(this.board.border.setnoerr(),s[n].setedgeerr(1))}}},checkGatheredObjectInGraph:function(e,t,i){for(var s={},n=this.board,r=0;r<n.cell.length;r++){var o=t(n.cell[r]);if(-1!==o){var a=e.getComponentRefs(n.cell[r]);if(void 0===s[o])s[o]=a;else if(a&&s[o]!==a){this.failcode.add(i),n.cell.filter(function(t){t=e.getComponentRefs(t);return a===t||s[o]===t}).seterr(1);break}}}},checkDifferentNumberInRoom:function(){this.checkDifferentNumberInRoom_main(this.board.roommgr,this.isDifferentNumberInClist)},checkDifferentNumberInRoom_main:function(t,e){for(var i=t.components,s=0;s<i.length;s++){var n=i[s].clist;if(!e.call(this,n)){if(this.failcode.add("bkDupNum"),this.checkOnly)break;n.seterr(1)}}},isDifferentNumberInClist:function(t){return this.isIndividualObject(t,function(t){return t.getNum()})},isDifferentAnsNumberInClist:function(t){return this.isIndividualObject(t,function(t){return t.anum})},isIndividualObject:function(t,e){if(t.length<=0)return!0;for(var i=!0,s=[],n=[],r=-1,o=t[0].getminnum(),a=0;a<t.length;a++)r<e(t[a])&&(r=e(t[a]));for(var h=o;h<=r;h++)s[h]=0;for(a=0;a<t.length;a++)n[t[a].id]=e(t[a]);for(a=0;a<t.length;a++)n[t[a].id]>=o&&s[n[t[a].id]]++;var l=t.filter(function(t){return n[t.id]>=o&&2<=s[n[t.id]]});return 0<l.length&&(l.seterr(1),i=!1),i},checkRowsCols:function(t,e){var i=!0,s=this.board;t:do{for(var n=1;n<=s.maxby;n+=2){var r=s.cellinside(s.minbx+1,n,s.maxbx-1,n);if(!t.call(this,r)&&(i=!1,this.checkOnly))break t}for(var o=1;o<=s.maxbx;o+=2){r=s.cellinside(o,s.minby+1,o,s.maxby-1);if(!t.call(this,r)&&(i=!1,this.checkOnly))break t}}while(0);i||this.failcode.add(e)},checkDifferentNumberInLine:function(){this.checkRowsCols(this.isDifferentNumberInClist,"nmDupRow")},checkRowsColsPartly:function(t,e,i){var s=!0,n=this.board;t:do{for(var r={keycell:null,key51num:-1,isvert:!1},o=1;o<=n.maxby;o+=2)for(var a=1;a<=n.maxbx;a+=2){for(var h=a;h<=n.maxbx&&!e(n.getc(h,o),!1);h+=2);if(r.keycell=n.getobj(a-2,o),r.key51num=r.keycell.qnum,a<h&&!t.call(this,n.cellinside(a,o,h-2,o),r)&&(s=!1,this.checkOnly))break t;a=h}r={keycell:null,key51num:-1,isvert:!0};for(a=1;a<=n.maxbx;a+=2)for(o=1;o<=n.maxby;o+=2){for(var l=o;l<=n.maxby&&!e(n.getc(a,l),!0);l+=2);if(r.keycell=n.getobj(a,o-2),r.key51num=r.keycell.qnum2,o<l&&!t.call(this,n.cellinside(a,o,a,l-2),r)&&(s=!1,this.checkOnly))break t;o=l}}while(0);s||this.failcode.add(i)},checkRowsColsFor51cell:function(t,e){this.checkRowsColsPartly(t,function(t){return t.is51cell()},e)},checkShadeCount:function(){this.checkRowsCols(this.isExCellCount,"exShadeNe")},getRowsColsValue:function(t){return t.filter(function(t){return t.isShade()}).length},isExCellCount:function(t){var e,i=t.getRectSize(),s=this.board,n=this.getRowsColsValue(t),r=!0;return i.x1===i.x2&&-1!==(e=s.getex(i.x1,-1)).qnum&&e.qnum!==n&&(e.seterr(1),r=!1),i.y1===i.y2&&-1!==(e=s.getex(-1,i.y1)).qnum&&e.qnum!==n&&(e.seterr(1),r=!1),r||t.seterr(1),r},checkBorderCross:function(){this.checkBorderCount(4,0,"bdCross")},checkBorderDeadend:function(){this.checkBorderCount(1,0,"bdDeadEnd")},checkBorderCount:function(t,e,i){for(var s=!0,n=this.board,r=2===n.hascross?n.cross:n.crossinside(n.minbx+2,n.minby+2,n.maxbx-2,n.maxby-2),o=0;o<r.length;o++){var a=r[o];if(!(a.lcnt!==t||1===e&&1!==a.qnum||2===e&&1===a.qnum)){if(s=!1,this.checkOnly)break;a.setCrossBorderError()}}s||(this.failcode.add(i),n.border.setnoerr())},checkLineShape:function(t,e){for(var i=!0,s=this.getLineShapeInfo(),n=0;n<s.length;n++){var r=s[n];if(r&&t(r)){if(i=!1,this.checkOnly)break;var o=r.cells;o[0]&&!o[0].isnull&&o[0].seterr(1),o[1]&&!o[1].isnull&&o[1].seterr(1),r.objs.seterr(1)}}i||(this.failcode.add(e),this.board.border.setnoerr())},checkLineShapeDeadend:function(){this.checkLineShape(function(t){return t.cells[1].isnull},"lcDeadEnd")},getLineShapeInfo:function(){if(this._info.num)return this._info.num;for(var t=this.board,e=[],i=[],s=0;s<t.border.length;s++)i[s]=!1;for(var n=t.cell.filter(function(t){return t.isLineShapeEndpoint()}),r=0;r<n.length;r++)for(var o,a=n[r],h=a.adjborder,l=[h.top,h.bottom,h.left,h.right],c=0;c<4;c++)l[c].isnull||(o=this.searchLineShapeInfo(a,c+1,i))&&e.push(o);return this._info.num=e},searchLineShapeInfo:function(t,e,i){for(var s={objs:new this.klass.BorderList,cells:[t,null],ccnt:0,length:[],dir1:e,dir2:0},n=t.getaddr();;)if(n.movedir(e,1),n.oncell()){var r=n.getc(),o=r.adjborder;if(r.isnull||t===r||r.isLineShapeEndpoint())break;this.board.linegraph.iscrossing(r)&&3<=r.lcnt||(1!==e&&o.bottom.isLine()?(2!==e&&s.ccnt++,e=2):2!==e&&o.top.isLine()?(1!==e&&s.ccnt++,e=1):3!==e&&o.right.isLine()?(4!==e&&s.ccnt++,e=4):4!==e&&o.left.isLine()&&(3!==e&&s.ccnt++,e=3))}else{r=n.getb();if(r.isnull||!r.isLine()||i[r.id])break;s.objs.add(r),i[r.id]=!0,isNaN(s.length[s.ccnt])?s.length[s.ccnt]=1:s.length[s.ccnt]++}return 0<s.objs.length?(s.cells[1]=n.getc(),s.dir2=[0,2,1,4,3][e],s):null},isDifferentShapeBlock:function(t,e){if(t.clist.length!==e.clist.length)return!0;t=t.clist.getBlockShapes(),e=e.clist.getBlockShapes();return t.canon!==e.canon},searchloop:function(t,e,i){var s=new(i?this.klass.BorderList:"cross"===e.pointgroup?this.klass.CrossList:this.klass.CellList);if(t.circuits<=0)return s;for(var n=this.board,r=[t.nodes[0].obj],o=null,a={},h=n.maxbx-n.minbx;0<r.length;){var l=r[r.length-1],c=null,u=a[l.by*h+l.bx];if(void 0===u)u=a[l.by*h+l.bx]=r.length-1;else if(r.length-1>u)for(var d=r.length-2;0<=d&&("border"===r[d].group==!!i&&s.add(r[d]),r[d]!==l);d--);if("border"!==l.group)for(o=l,d=0;d<e.getObjNodeList(l)[0].nodes.length;d++){var f=e.getObjNodeList(l)[0].nodes[d].obj,f=n.getb(l.bx+f.bx>>1,l.by+f.by>>1);if(void 0===a[f.by*h+f.bx]){c=f;break}}else for(var b="cross"===e.pointgroup?l.sidecross:l.sidecell,d=0;d<b.length;d++){var p=b[d];if(p!==o&&p!==r[r.length-2]){c=p;break}}c?r.push(c):r.pop()}return s},getBoardPiecesMap:function(){if(this._info.boardpiecesmap)return this._info.boardpiecesmap;this._info.boardpieces||(this._info.boardpieces=this.board.getBankPiecesInGrid());var e={};return this._info.boardpieces.forEach(function(t){t[0]in e?e[t[0]].push(t[1]):e[t[0]]=[t[1]]}),this._info.boardpiecesmap=e},checkBankPiecesInvalid:function(){var t,e=this.getBoardPiecesMap();for(t in e){for(var i=!1,s=0;s<this.board.bank.pieces.length&&!i;s++)t===this.board.bank.pieces[s].canonize()&&(i=!0);if(!i){if(this.failcode.add("bankInvalid"),this.checkOnly)break;e[t].forEach(function(t){t.seterr(1)})}}},checkBankPiecesAvailable:function(){for(var e,t=this.getBoardPiecesMap(),i={},s=0;s<this.board.bank.pieces.length;s++)(e=this.board.bank.pieces[s].canonize())in i||(i[e]=0),i[e]+=this.board.bank.pieces[s].count;for(e in t)if(e in i&&i[e]<t[e].length){if(this.failcode.add("bankGt"),this.checkOnly)break;this.board.bank.pieces.forEach(function(t){t.canonize()===e&&t.seterr(1)}),t[e].forEach(function(t){t.seterr(1)})}},checkBankPiecesUsed:function(){for(var e,t=this.getBoardPiecesMap(),i={},s=0;s<this.board.bank.pieces.length;s++)(e=this.board.bank.pieces[s].canonize())in i||(i[e]=0),i[e]+=this.board.bank.pieces[s].count;for(e in i){var n=e in t?t[e].length:0;if(i[e]>n){if(this.failcode.add("bankLt"),this.checkOnly)break;var r=n;this.board.bank.pieces.forEach(function(t){t.canonize()===e&&r--<=0&&t.seterr(1)})}}}}}),p.classmgr.makeCommon({BoardExec:{adjustNumberArrow:function(t,e){this.adjustCellArrowField(t,e,"qdir")},adjustCellArrow:function(t,e){this.klass.Cell.prototype.numberAsObject?(this.adjustCellArrowField(t,e,"qnum"),this.adjustCellArrowField(t,e,"anum")):this.adjustCellArrowField(t,e,"qdir")},adjustCellArrowField:function(t,e,i){if(t&this.TURNFLIP)for(var s=this.getTranslateDir(t),n=this.board.cellinside(e.x1,e.y1,e.x2,e.y2),r=0;r<n.length;r++){var o=n[r],a=s[o[i]];a&&(o[i]=a)}},adjustBorderArrow:function(t,e){if(t&this.TURNFLIP)for(var i=this.getTranslateDir(t),s=this.board.borderinside(e.x1,e.y1,e.x2,e.y2),n=0;n<s.length;n++){var r=s[n],o=i[r.qdir];o&&(r.qdir=o)}},getTranslateDir:function(t){var e={};switch(t){case this.FLIPY:e={1:2,2:1};break;case this.FLIPX:e={3:4,4:3};break;case this.TURNR:e={1:4,2:3,3:1,4:2};break;case this.TURNL:e={1:3,2:4,3:2,4:1}}return e},adjustQues51_1:function(t,e){for(var i=1|e.x1,s=1|e.y1,n=(this.qnumw=[],this.qnumh=[],this.board),r=s;r<=e.y2;r+=2){this.qnumw[r]=[n.getex(-1,r).qnum];for(var o=i;o<=e.x2;o+=2)(a=n.getc(o,r)).is51cell()&&this.qnumw[r].push(a.qnum)}for(o=i;o<=e.x2;o+=2){this.qnumh[o]=[n.getex(o,-1).qnum2];for(var a,r=s;r<=e.y2;r+=2)(a=n.getc(o,r)).is51cell()&&this.qnumh[o].push(a.qnum2)}},adjustQues51_2:function(t,e){var i,s=e.x1+e.x2,n=e.y1+e.y2,r=1|e.x1,o=1|e.y1,a=this.board;switch(a.disableInfo(),t){case this.FLIPY:for(var h=r;h<=e.x2;h+=2){i=1,this.qnumh[h]=this.qnumh[h].reverse(),a.getex(h,-1).setQnum2(this.qnumh[h][0]);for(var l=o;l<=e.y2;l+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum2(this.qnumh[h][i]),i++)}break;case this.FLIPX:for(l=o;l<=e.y2;l+=2){i=1,this.qnumw[l]=this.qnumw[l].reverse(),a.getex(-1,l).setQnum(this.qnumw[l][0]);for(h=r;h<=e.x2;h+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum(this.qnumw[l][i]),i++)}break;case this.TURNR:for(l=o;l<=e.y2;l+=2){i=1,this.qnumh[l]=this.qnumh[l].reverse(),a.getex(-1,l).setQnum(this.qnumh[l][0]);for(h=r;h<=e.x2;h+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum(this.qnumh[l][i]),i++)}for(h=r;h<=e.x2;h+=2){a.getex(h,-(i=1)).setQnum2(this.qnumw[s-h][0]);for(l=o;l<=e.y2;l+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum2(this.qnumw[s-h][i]),i++)}break;case this.TURNL:for(l=o;l<=e.y2;l+=2){a.getex(-(i=1),l).setQnum(this.qnumh[n-l][0]);for(h=r;h<=e.x2;h+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum(this.qnumh[n-l][i]),i++)}for(h=r;h<=e.x2;h+=2){i=1,this.qnumw[h]=this.qnumw[h].reverse(),a.getex(h,-1).setQnum2(this.qnumw[h][0]);for(var c,l=o;l<=e.y2;l+=2)(c=a.getc(h,l)).is51cell()&&(c.setQnum2(this.qnumw[h][i]),i++)}}a.enableInfo()},adjustExCellTopLeft_1:function(t,e){for(var i=1|e.x1,s=1|e.y1,n=(this.qnumw=[],this.qnumh=[],this.board),r=-2*n.excellRows(n.cols,n.rows)+1,o=-2*n.excellCols(n.cols,n.rows)+1,a=s;a<=e.y2;a+=2){this.qnumw[a]=[];for(var h=o;h<=-1;h+=2)this.qnumw[a].push(n.getex(h,a).qnum)}for(h=i;h<=e.x2;h+=2){this.qnumh[h]=[];for(a=r;a<=-1;a+=2)this.qnumh[h].push(n.getex(h,a).qnum)}},adjustExCellTopLeft_2:function(t,e,i){var s=e.x1+e.x2,n=e.y1+e.y2,r=1|e.x1,o=1|e.y1;if(!i){if(t===this.FLIPX||t===this.TURNL)for(var a in this.qnumw)this.qnumw[a].reverse();if(t===this.FLIPY||t===this.TURNR)for(var a in this.qnumh)this.qnumh[a].reverse()}var h=this.board,l=(h.disableInfo(),-2*h.excellRows(h.cols,h.rows)+1),c=-2*h.excellCols(h.cols,h.rows)+1;switch(t){case this.FLIPY:for(var u=r;u<=e.x2;u+=2)for(var d=-1;l<=d;d-=2)h.getex(u,d).setQnum(this.qnumh[u].pop());break;case this.FLIPX:for(d=o;d<=e.y2;d+=2)for(u=-1;c<=u;u-=2)h.getex(u,d).setQnum(this.qnumw[d].pop());break;case this.TURNR:for(d=o;d<=e.y2;d+=2)for(u=-1;c<=u;u-=2)h.getex(u,d).setQnum(this.qnumh[d].pop());for(u=r;u<=e.x2;u+=2)for(d=-1;l<=d;d-=2)h.getex(u,d).setQnum(this.qnumw[s-u].pop());break;case this.TURNL:for(d=o;d<=e.y2;d+=2)for(u=-1;c<=u;u-=2)h.getex(u,d).setQnum(this.qnumh[n-d].pop());for(u=r;u<=e.x2;u+=2)for(d=-1;l<=d;d-=2)h.getex(u,d).setQnum(this.qnumw[u].pop())}h.enableInfo()},getAfterPos:function(t,e,i){var s,n,r=this.puzzle,o=r.board,a=e.x1+e.x2,h=e.y1+e.y2,l=i.bx,c=i.by;switch(t){case this.FLIPY:s=l,n=h-c;break;case this.FLIPX:s=a-l,n=c;break;case this.TURNR:s=h-c,n=l;break;case this.TURNL:s=c,n=a-l;break;case this.EXPANDUP:s=l,n=c+(c===o.minby?0:2);break;case this.EXPANDDN:s=l,n=c+(c===o.maxby?2:0);break;case this.EXPANDLT:s=l+(l===o.minbx?0:2),n=c;break;case this.EXPANDRT:s=l+(l===o.maxbx?2:0),n=c;break;case this.REDUCEUP:s=l,n=c-(c<=o.minby+2?0:2);break;case this.REDUCEDN:s=l,n=c-(c>=o.maxby-2?2:0);break;case this.REDUCELT:s=l-(l<=o.minbx+2?0:2),n=c;break;case this.REDUCERT:s=l-(l>=o.maxbx-2?2:0),n=c;break;default:s=l,n=c}return{pos:new r.klass.Address(s,n),isdel:this.isdel(t,i)}}}}),p.classmgr.makeCommon({Encode:{include:function(t,e,i){return e<=t&&t<=i},decode4Cell:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,e=0;e<i.length;e++){var n=s.cell[t],r=i.charAt(e);if(this.include(r,"0","4")?n.qnum=parseInt(r,16):this.include(r,"5","9")?(n.qnum=parseInt(r,16)-5,t++):this.include(r,"a","e")?(n.qnum=parseInt(r,16)-10,t+=2):this.include(r,"g","z")?t+=parseInt(r,36)-16:"."===r&&(n.qnum=-2),t++,!s.cell[t])break}this.outbstr=i.substr(e+1)},encode4Cell:function(){for(var t=0,e="",i=this.board,s=0;s<i.cell.length;s++){var n="",r=i.cell[s].qnum;0<=r?i.cell[s+1]&&-1!==i.cell[s+1].qnum?n=""+r.toString(16):i.cell[s+2]&&-1!==i.cell[s+2].qnum?(n=""+(5+r).toString(16),s++):(n=""+(10+r).toString(16),s+=2):-2===r?n=".":t++,0===t?e+=n:!n&&20!==t||(e+=(t+15).toString(36)+n,t=0)}0<t&&(e+=(t+15).toString(36)),this.outbstr+=e},decode1Cell:function(t){for(var e=0,i=0,s=this.outbstr,n=this.board,i=0;i<s.length;i++){var r=n.cell[e],o=s.charAt(i);if(this.include(o,"0","h")?(r.qnum=t,e+=parseInt(o,36)):e+=parseInt(o,36)-18,e++,!n.cell[e])break}this.outbstr=s.substr(i+1)},encode1Cell:function(t){for(var e=-1,i=!1,s="",n=this.board,r=0;r<n.cell.length;r++)n.cell[r].qnum===t?(0<=e&&(s+=(i?e:e+18).toString(36)),i=!0,e=0):17===++e&&(s+=(i?e:e+18).toString(36),i=!1,e=-1);0<=e&&(s+=(i?e:e+18).toString(36)),this.outbstr+=s},decode4Cross:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,e=0;e<i.length;e++){var n=s.cross[t],r=i.charAt(e);if(this.include(r,"0","4")?n.qnum=parseInt(r,16):this.include(r,"5","9")?(n.qnum=parseInt(r,16)-5,t++):this.include(r,"a","e")?(n.qnum=parseInt(r,16)-10,t+=2):this.include(r,"g","z")?t+=parseInt(r,36)-16:"."===r&&(n.qnum=-2),t++,!s.cross[t])break}this.outbstr=i.substr(e+1)},encode4Cross:function(){for(var t=0,e="",i=this.board,s=0;s<i.cross.length;s++){var n="",r=i.cross[s].qnum;0<=r?i.cross[s+1]&&-1!==i.cross[s+1].qnum?n=""+r.toString(16):i.cross[s+2]&&-1!==i.cross[s+2].qnum?(n=""+(5+r).toString(16),s++):(n=""+(10+r).toString(16),s+=2):-2===r?n=".":t++,0===t?e+=n:!n&&20!==t||(e+=(t+15).toString(36)+n,t=0)}0<t&&(e+=(t+15).toString(36)),this.outbstr+=e},decodeNumber10:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,e=0;e<i.length;e++){var n=s.cell[t],r=i.charAt(e);if("."===r?n.qnum=-2:this.include(r,"0","9")?n.qnum=parseInt(r,10):this.include(r,"a","z")&&(t+=parseInt(r,36)-10),t++,!s.cell[t])break}this.outbstr=i.substr(e+1)},maybeEncodeNumber10:function(){for(var t="",e=0,i=this.board,s=0;s<i.cell.length;s++){var n="",r=i.cell[s].qnum;if(-2===r)n=".";else if(0<=r&&r<10)n=r.toString(10);else{if(10<=r)return"";e++}0===e?t+=n:!n&&26!==e||(t+=(9+e).toString(36)+n,e=0)}return 0<e&&(t+=(9+e).toString(36)),t},encodeNumber10:function(){var t=this.maybeEncodeNumber10();if(!t)throw Error("Grid contains number higher than 9");this.outbstr+=t},readNumber16:function(t,e){var i=t.charAt(e);return this.include(i,"0","9")||this.include(i,"a","f")?[parseInt(i,16),1]:"-"===i?[parseInt(t.substr(e+1,2),16),3]:"+"===i?[parseInt(t.substr(e+1,3),16),4]:"="===i?[parseInt(t.substr(e+1,3),16)+4096,4]:"%"===i||"@"===i?[parseInt(t.substr(e+1,3),16)+8192,4]:"*"===i?[parseInt(t.substr(e+1,4),16)+12240,5]:"$"===i?[parseInt(t.substr(e+1,5),16)+77776,6]:"."===i?[-2,1]:[-1,0]},decodeOneNumber16:function(){var t=this.readNumber16(this.outbstr,0);return this.outbstr=this.outbstr.substr(t[1]),t[0]},decodeNumber16:function(){var i=this.board;this.genericDecodeNumber16(i.cell.length,function(t,e){i.cell[t].qnum=e})},genericDecodeNumber16:function(t,e){for(var i=0,s=0,n=this.outbstr;s<n.length&&i<t;){var r=n.charAt(s),o=this.readNumber16(n,s);-1!==o[0]?(e(i,o[0]),s+=o[1],i++):("g"<=r&&r<="z"&&(i+=parseInt(r,36)-15),s++)}this.outbstr=n.substr(s)},writeNumber16:function(t){return-2===t?".":0<=t&&t<16?t.toString(16):16<=t&&t<256?"-"+t.toString(16):256<=t&&t<4096?"+"+t.toString(16):4096<=t&&t<8192?"="+(t-4096).toString(16).padStart(3,0):8192<=t&&t<12240?"@"+(t-8192).toString(16).padStart(3,0):12240<=t&&t<77776?"*"+(t-12240).toString(16).padStart(4,0):77776<=t?"$"+(t-77776).toString(16).padStart(5,0):""},encodeNumber16:function(){var e=this.board;this.genericEncodeNumber16(e.cell.length,function(t){return e.cell[t].qnum})},genericEncodeNumber16:function(t,e){for(var i=0,s="",n=0;n<t;n++){var r=e(n),r=this.writeNumber16(r);""===r&&i++,0===i?s+=r:!r&&20!==i||(s+=(15+i).toString(36)+r,i=0)}0<i&&(s+=(15+i).toString(36)),this.outbstr+=s},decodeNumber10or16:function(){var t=this.outbstr;0!==t.length&&("-"===t.charAt(0)?(this.outbstr=t.substr(1),this.decodeNumber16()):this.decodeNumber10())},encodeNumber10or16:function(){var t=this.maybeEncodeNumber10();0<t.length?this.outbstr+=t:(this.outbstr+="-",this.encodeNumber16())},decodeNumber16ExCell:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,e=0;e<i.length;e++){var n=i.charAt(e),r=s.excell[t];if(this.include(n,"0","9")||this.include(n,"a","f")?r.qnum=parseInt(i.substr(e,1),16):"-"===n?(r.qnum=parseInt(i.substr(e+1,2),16),e+=2):"."===n?r.qnum=-2:"g"<=n&&n<="z"&&(t+=parseInt(n,36)-16),++t>=s.excell.length)break}this.outbstr=i.substr(e+1)},encodeNumber16ExCell:function(){var e=this.board;this.genericEncodeNumber16(e.excell.length,function(t){return e.excell[t].qnum})},encodeNumber16ExCellFlushed:function(){var t=this.board,e=t.cols,i=t.rows,s=t.excell.map(function(t){return t.qnum});t.genericFlush(t.excellCols(e,i),t.excellRows(e,i),e,i,function(t){return s[t]},function(t,e){s[t]=e}),this.genericEncodeNumber16(s.length,function(t){return s[t]})},decodeRoomNumber16:function(){var t=this.board,i=(t.roommgr.rebuild(),t.roommgr.components);this.genericDecodeNumber16(i.length,function(t,e){i[t].top.qnum=e})},encodeRoomNumber16:function(){var e=this.board;e.roommgr.rebuild(),this.genericEncodeNumber16(e.roommgr.components.length,function(t){return e.roommgr.components[t].top.qnum})},decodeArrowNumber16:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,e=0;e<i.length;e++){var n,r=i.charAt(e),o=s.cell[t];if("+"===r?(o.qdir=0,o.qnum=-3):this.include(r,"0","4")?(n=i.charAt(e+1),o.qdir=parseInt(r,16),o.qnum="."!==n?parseInt(n,16):-2,e++):this.include(r,"5","9")?(o.qdir=parseInt(r,16)-5,o.qnum=parseInt(i.substr(e+1,2),16),e+=2):"-"===r?(o.qdir=parseInt(i.substr(e+1,1),16),o.qnum=parseInt(i.substr(e+2,3),16),e+=4):"a"<=r&&r<="z"&&(t+=parseInt(r,36)-10),t++,!s.cell[t])break}this.outbstr=i.substr(e+1)},encodeArrowNumber16:function(){for(var t="",e=0,i=this.board,s=0;s<i.cell.length;s++){var n="",r=i.cell[s].qdir,o=i.cell[s].qnum;-2===o?n=r+".":-3===o?n="+":0<=o&&o<16?n=r+o.toString(16):16<=o&&o<256?n=r+5+o.toString(16):256<=o&&o<4096?n="-"+r+o.toString(16):e++,0===e?t+=n:!n&&26!==e||(t+=(e+9).toString(36)+n,e=0)}0<e&&(t+=(e+9).toString(36)),this.outbstr+=t},decodeBorder:function(){for(var t,e=this.outbstr,i=[16,8,4,2,1],s=this.board,n=e?(t=Math.min(((s.cols-1)*s.rows+4)/5|0,e.length),Math.min(((s.cols*(s.rows-1)+4)/5|0)+t,e.length)):t=0,r=0,o=0;o<t;o++)for(var a=parseInt(e.charAt(o),32),h=0;h<5;h++)r<(s.cols-1)*s.rows&&(s.border[r].ques=a&i[h]?1:0,r++);r=(s.cols-1)*s.rows;for(o=t;o<n;o++)for(a=parseInt(e.charAt(o),32),h=0;h<5;h++){var l=s.border[r];l&&l.inside&&(l.ques=a&i[h]?1:0,r++)}s.roommgr.rebuild(),this.outbstr=e.substr(n)},encodeBorder:function(){for(var t="",e=[16,8,4,2,1],i=0,s=0,n=this.board,r=0;r<(n.cols-1)*n.rows;r++)s+=n.border[r].ques*e[i],5===++i&&(t+=s.toString(32),s=i=0);0<i&&(t+=s.toString(32));for(i=0,s=0,r=(n.cols-1)*n.rows;r<2*n.cols*n.rows-n.cols-n.rows;r++)s+=n.border[r].ques*e[i],5===++i&&(t+=s.toString(32),s=i=0);0<i&&(t+=s.toString(32)),this.outbstr+=t},decodeCrossMark:function(){for(var t=0,e=0,i=this.outbstr,s=this.board,n=2===s.hascross?1:0,r=n<<1,o=s.rows-1+r,a=s.cols-1+r,e=0;e<i.length;e++){var h=i.charAt(e);if(this.include(h,"0","9")||this.include(h,"a","z")){var l=(t+=parseInt(h,36))%a+(1-n)<<1,c=1-n+(t/a|0)<<1;if(c>s.maxby-2*(1-n)){e++;break}s.getx(l,c).qnum=1}else"."===h&&(t+=35);if(a*o<=++t){e++;break}}this.outbstr=i.substr(e)},encodeCrossMark:function(){for(var t="",e=0,i=this.board,s=2===i.hascross?1:0,n=s<<1,r=i.rows-1+n,o=i.cols-1+n,a=0,h=o*r;a<h;a++){var l="";1===i.getx(a%o+(1-s)<<1,1-s+(a/o|0)<<1).qnum?l=".":e++,l?(t+=e.toString(36),e=0):36===e&&(t+=".",e=0)}(0<e||""===t)&&(t+=e.toString(36)),this.outbstr+=t},genericDecodeThree:function(t){for(var e=this.board,i=this.outbstr,s=0,n=[9,3,1],r=i?Math.min((e.cols*e.rows+2)/3|0,i.length):0,o=0;o<r;o++)for(var a,h=parseInt(i.charAt(o),27),l=0;l<3;l++)e.cell[s]&&(0<(a=(h/n[l]|0)%3)&&t(e.cell[s],a),s++);this.outbstr=i.substr(r)},decodeCircle:function(){this.genericDecodeThree(function(t,e){t.qnum=e})},genericEncodeThree:function(t){for(var e=this.board,i="",s=0,n=0,r=[9,3,1],o=0;o<e.cell.length;o++)n+=t(e.cell[o])*r[s],3===++s&&(i+=n.toString(27),n=s=0);0<s&&(i+=n.toString(27)),this.outbstr+=i},encodeCircle:function(){this.genericEncodeThree(function(t){return Math.max(0,t.qnum)})},decodeBinary:function(i,s){var n=this.board;this.genericDecodeBinary(n.cell.length,function(t,e){e&&(n.cell[t][i]=s)})},genericDecodeBinary:function(t,e){for(var i=this.outbstr,s=0,n=[16,8,4,2,1],r=0;r<i.length;r++){for(var o=parseInt(i.charAt(r),32),a=0;a<5;a++)s<t&&(e(s,!!(o&n[a])),s++);if(t<=s)break}this.outbstr=i.substr(r+1)},encodeBinary:function(e,i,t){var s=this.board;this.genericEncodeBinary(s.cell.length,function(t){return s.cell[t][e]===i},t)},genericEncodeBinary:function(t,e,i){for(var s="",n=0,r=0,o=[16,8,4,2,1],a=!1,h=0;h<t;h++)e(h)&&(r+=o[n],a=!0),5===++n&&(s+=r.toString(32),r=n=0);return 0<n&&(s+=r.toString(32)),!(!a&&i)&&(this.outbstr+=s,!0)},decodeIce:function(){this.decodeBinary("ques",6)},encodeIce:function(){this.encodeBinary("ques",6)},decodeEmpty:function(){this.decodeBinary("ques",7)},encodeEmpty:function(){return this.encodeBinary("ques",7,!0)},decodecross_old:function(){for(var t=this.outbstr,e=0,i=this.board,s=0;s<t.length;s++){var n=t.charAt(s);if(this.include(n,"0","4")&&(i.cross[e].qnum=parseInt(n,10)),e++,!i.cross[e]){s++;break}}this.outbstr=t.substr(s)},decodeDot:function(t){for(var e=this.board,i=(e.disableInfo(),0),t=this.outbstr,s=0;s<t.length;s++){var n,r=e.dots[i],o=t.charAt(s);if(this.include(o,"0","f")?(n=parseInt(o,16),r.setDot(n%2+1),i+=1+(n>>1)):this.include(o,"g","z")&&(i+=parseInt(o,36)-15),i>=e.dotsmax)break}e.enableInfo(),this.outbstr=t.substr(s+1)},encodeDot:function(){for(var t=0,e="",i=this.board,s=0;s<i.dotsmax;s++){var n="",r=i.dots[s];if(0<r.getDot()){for(var o=1;o<=7;o++){var a=i.dots[s+o];if(a&&0<a.getDot()){n=""+(2*(o-1)+(r.getDot()-1)).toString(16),s+=o-1;break}}""===n&&(n=(13+r.getDot()).toString(16),s+=7)}else t++;0===t?e+=n:!n&&20!==t||(e+=(t+15).toString(36)+n,t=0)}0<t&&(e+=(t+15).toString(36)),this.outbstr+=e},decodePieceBank:function(){var t=this.board.bank;if("//"===this.outbstr.substr(0,2)){for(var e=this.outbstr[2],i=0;i<t.presets.length;i++)if(t.presets[i].shortkey===e){t.initialize(t.presets[i].constant);break}this.outbstr=this.outbstr.substr(3)}else{this.outbstr=this.outbstr.substr(1);for(var s=this.outbstr.indexOf("/"),n=+this.outbstr.substr(0,s),r=(this.outbstr=this.outbstr.substr(s+1),[]),i=0;i<n;i++)s=this.outbstr.indexOf("/"),r.push(0<=s?this.outbstr.substr(0,s):this.outbstr),this.outbstr=0<=s?this.outbstr.substr(s+1):"";t.initialize(r)}},encodePieceBank:function(){this.outbstr+="/";for(var t=this.board.bank,e=t.pieces.map(function(t){return t.serialize()}).filter(function(t){return t}),i=0;i<t.presets.length;i++)if(t.presets[i].constant&&this.puzzle.pzpr.util.sameArray(t.presets[i].constant,e))return void(this.outbstr+="/"+t.presets[i].shortkey);this.outbstr+=e.length;for(i=0;i<e.length;i++)this.outbstr+="/"+e[i]}}}),p.classmgr.makeCommon({FileIO:{decodeCellQnum:function(){this.decodeCell(function(t,e){"-"===e?t.qnum=-2:"."!==e&&(t.qnum=+e)})},encodeCellQnum:function(){this.encodeCell(function(t){return 0<=t.qnum?t.qnum+" ":-2===t.qnum?"- ":". "})},decodeCellQnumb:function(){this.decodeCell(function(t,e){"5"===e?t.qnum=-2:"."!==e&&(t.qnum=+e)})},encodeCellQnumb:function(){this.encodeCell(function(t){return 0<=t.qnum?t.qnum+" ":-2===t.qnum?"5 ":". "})},decodeCellQnumAns:function(){this.decodeCell(function(t,e){"#"===e?t.qans=1:"+"===e?t.qsub=1:"-"===e?t.qnum=-2:"."!==e&&(t.qnum=+e)})},encodeCellQnumAns:function(){this.encodeCell(function(t){return 0<=t.qnum?t.qnum+" ":-2===t.qnum?"- ":1===t.qans?"# ":1===t.qsub?"+ ":". "})},decodeCellDirecQnum:function(){this.decodeCell(function(t,e){"#"===e?(t.qdir=0,t.qnum=-3):"."!==e&&(e=e.split(","),t.qdir="0"!==e[0]?+e[0]:0,t.qnum="-"!==e[1]?+e[1]:-2)})},encodeCellDirecQnum:function(){this.encodeCell(function(t){return-3===t.qnum?"# ":-1!==t.qnum?[0!==t.qdir?""+t.qdir:"0",",",-2!==t.qnum?""+t.qnum:"-"," "].join(""):". "})},decodeCellAns:function(){this.decodeCell(function(t,e){"#"===e?t.qans=1:"+"===e&&(t.qsub=1)})},encodeCellAns:function(){this.encodeCell(function(t){return 1===t.qans?"# ":1===t.qsub?"+ ":". "})},decodeCellQanssub:function(){this.decodeCell(function(t,e){"+"===e?t.qsub=1:"-"===e?t.qsub=2:"="===e?t.qsub=3:"%"===e?t.qsub=4:"."!==e&&(t.qans=+e)})},encodeCellQanssub:function(){this.encodeCell(function(t){return 0!==t.qans?t.qans+" ":1===t.qsub?"+ ":2===t.qsub?"- ":3===t.qsub?"= ":4===t.qsub?"% ":". "})},decodeCellAnumsub:function(){this.decodeCell(function(t,e){"c"===(e=t.enableSubNumberArray&&0<=e.indexOf("[")?this.setCellSnum(t,e):e)?t.qcmp=1:"+"===e?t.qsub=1:"-"===e?t.qsub=2:"="===e?t.qsub=3:"%"===e?t.qsub=4:"."!==e&&(t.anum=+e)})},encodeCellAnumsub:function(){this.encodeCell(function(t){var e=".",e=-1!==t.anum?""+t.anum:1===t.qcmp?"c":1===t.qsub?"+":2===t.qsub?"-":3===t.qsub?"=":4===t.qsub?"%":".";return t.enableSubNumberArray&&-1===t.anum&&(e+=this.getCellSnum(t)),e+" "})},setCellSnum:function(t,e){for(var i=e.substring(e.indexOf("[")+1,e.indexOf("]")).split(/,/),s=0;s<i.length;++s)t.snum[s]=i[s]?+i[s]:-1;return e.substr(0,e.indexOf("["))},getCellSnum:function(t){for(var e=[],i=0;i<t.snum.length;++i)e[i]=-1!==t.snum[i]?""+t.snum[i]:"";var s=e.join(",");return",,,"!==s?"["+s+"]":""},decodeCellSnum:function(){this.decodeCell(function(t,e){this.setCellSnum(t,e)})},encodeCellSnum:function(t){if(!t){for(var e=!1,i=this.board.cell,s=0;s<i.length&&!e;s++)for(var n=i[s],r=0;r<n.snum.length;++r)-1!==n.snum[r]&&(e=!0);if(!e)return}this.encodeCell(function(t){t=this.getCellSnum(t);return t?t+" ":". "})},decodeCellQsub:function(){this.decodeCell(function(t,e){"0"!==e&&(t.qsub=+e)})},encodeCellQsub:function(){this.encodeCell(function(t){return 0<t.qsub?t.qsub+" ":"0 "})},decodeCrossNum:function(){this.decodeCross(function(t,e){"-"===e?t.qnum=-2:"."!==e&&(t.qnum=+e)})},encodeCrossNum:function(){this.encodeCross(function(t){return 0<=t.qnum?t.qnum+" ":-2===t.qnum?"- ":". "})},decodeBorderQues:function(){this.decodeBorder(function(t,e){"1"===e&&(t.ques=1)})},encodeBorderQues:function(){this.encodeBorder(function(t){return(1===t.ques?"1":"0")+" "})},decodeBorderAns:function(t){this.decodeBorder(function(t,e){"2"===e?(t.qans=1,t.qsub=1):"1"===e?t.qans=1:"-1"===e&&(t.qsub=1)},t)},encodeBorderAns:function(t){this.encodeBorder(function(t){return 1===t.qans&&1===t.qsub?"2 ":1===t.qans?"1 ":1===t.qsub?"-1 ":"0 "},t)},decodeBorderArrowAns:function(){this.decodeBorder(function(t,e){var i=e.charAt(e.length-1);"a"<=i&&i<="z"&&("u"===i?t.qsub=11:"d"===i?t.qsub=12:"l"===i?t.qsub=13:"r"===i&&(t.qsub=14),e=e.substr(0,e.length-1)),""!==e&&"0"!==e&&("-"===e.charAt(0)?(t.line=-e-1,t.qsub=2):t.line=+e)})},encodeBorderArrowAns:function(){this.encodeBorder(function(t){var e="";return 2===t.qsub?e+=""+(-1-t.line):0<t.line&&(e+=""+t.line),11<=t.qsub&&(e+=["u","d","l","r"][t.qsub-11]),""!==e?e+" ":"0 "})},decodeBorderLine:function(){this.decodeBorder(function(t,e){"-1"===e?t.qsub=2:"0"!==e&&(t.line=+e)})},encodeBorderLineIfPresent:function(){this.board.border.some(function(t){return 0<t.line||2===t.qsub})&&this.encodeBorderLine()},encodeBorderLine:function(){this.encodeBorder(function(t){return 0<t.line?t.line+" ":2===t.qsub?"-1 ":"0 "})},decodeAreaRoom:function(){this.decodeAreaRoom_com(!0)},encodeAreaRoom:function(){this.encodeAreaRoom_com(!0)},decodeAreaRoom_com:function(t){this.readLine(),this.rdata2Border(t,this.getItemList(this.board.rows)),this.board.roommgr.rebuild()},encodeAreaRoom_com:function(t){for(var e=this.board,i=(e.roommgr.rebuild(),e.roommgr.components),s=(this.writeLine(i.length),""),n=0;n<e.cell.length;n++){var r=i.indexOf(e.cell[n].room);s+=(0<=r?r:".")+" ",(n+1)%e.cols==0&&(this.writeLine(s),s="")}},rdata2Border:function(t,e){for(var i=this.board,s=0;s<i.border.length;s++){var n=i.border[s],r=n.sidecell[0],o=n.sidecell[1],r=!r.isnull&&!o.isnull&&e[r.id]!==e[o.id];n[t?"ques":"qans"]=r?1:0}},decodeCellQnum51:function(){var t=this.board;t.disableInfo(),this.decodeCellExCell(function(t,e){"."!==e&&("excell"===t.group?-1!==t.bx&&-1===t.by?t.qnum2=+e:-1===t.bx&&-1!==t.by&&(t.qnum=+e):"cell"===t.group&&(e=e.split(","),t.set51cell(),t.qnum=+e[0],t.qnum2=+e[1]))}),t.enableInfo()},encodeCellQnum51:function(){this.encodeCellExCell(function(t){return"excell"===t.group?-1===t.bx&&-1===t.by?"0 ":(-1===t.by?t.qnum2:t.qnum)+" ":"cell"===t.group&&51===t.ques?t.qnum+","+t.qnum2+" ":". "})},decodeDotFile:function(){for(var t=this.board,e=0,i="",s=0,n=2*t.rows-1;s<n;s++)i+=this.readLine();t.disableInfo();for(e=0;e<i.length;++e){var r=t.dots[e],o=i.charAt(e),a=+o;1<=a&&a<=9?r.setDot(a):"-"===o?r.setDot(-2):"X"===o&&(r.piece.ques=7)}t.enableInfo()},encodeDotFile:function(){for(var t=this.board,e=0,i=1;i<=2*t.rows-1;i++){for(var s="",n=1;n<=2*t.cols-1;n++){var r=t.dots[e];1<=r.getDot()&&r.getDot()<=9?s+=r.getDot():7===r.piece.ques?s+="X":-2===r.getDot()?s+="-":s+=".",e++}this.writeLine(s)}},decodeQnums:function(){this.decodeCell(function(t,e){if("."!==e){t.qnums=[];for(var i=e.split(/,/),s=0;s<i.length;s++)t.qnums.push("-"!==i[s]?+i[s]:-2)}})},encodeQnums:function(){this.encodeCell(function(t){if(0<t.qnums.length){for(var e=[],i=0;i<t.qnums.length;i++)e.push(0<=t.qnums[i]?""+t.qnums[i]:"-");return e.join(",")+" "}return". "})},decodePieceBank:function(){var t=this.board.bank,e=this.readLine();if(isNaN(e)){for(var i=0;i<t.presets.length;i++)if(t.presets[i].shortkey===e){t.initialize(t.presets[i].constant);break}}else{for(var s=[],i=0;i<+e;i++)s.push(this.readLine());t.initialize(s)}},encodePieceBank:function(){for(var t=this.board.bank,e=t.pieces.map(function(t){return t.serialize()}),i=0;i<t.presets.length;i++)if(t.presets[i].constant&&this.puzzle.pzpr.util.sameArray(t.presets[i].constant,e))return void this.writeLine(t.presets[i].shortkey);this.writeLine(""+e.length);for(i=0;i<e.length;i++)this.writeLine(e[i])},decodePieceBankQcmp:function(){for(var t=(this.readLine()||"").split(" "),e=Math.min(t.length,this.board.bank.pieces.length),i=0;i<e;i++)this.board.bank.pieces[i].qcmp=+t[i]},encodePieceBankQcmp:function(){var t=this.board.bank.pieces.map(function(t){return t.qcmp+" "}).join("");this.writeLine(t)},decodeCellQnum_kanpen:function(){this.decodeCell(function(t,e){"."!==e&&(t.qnum=+e)})},encodeCellQnum_kanpen:function(){this.encodeCell(function(t){return 0<=t.qnum?t.qnum+" ":". "})},decodeCellAnum_kanpen:function(){this.decodeCell(function(t,e){"."!==e&&"0"!==e&&(t.anum=+e)})},encodeCellAnum_kanpen:function(){this.encodeCell(function(t){return-1!==t.qnum?". ":-1===t.anum?"0 ":t.anum+" "})},decodeCellQnumAns_kanpen:function(){this.decodeCell(function(t,e){"#"===e?t.qans=1:"+"===e?t.qsub=1:"?"===e?t.qnum=-2:"."!==e&&(t.qnum=+e)})},encodeCellQnumAns_kanpen:function(){this.encodeCell(function(t){return 0<=t.qnum?t.qnum+" ":-2===t.qnum?"? ":1===t.qans?"# ":1===t.qsub?"+ ":". "})},UNDECIDED_NUM_XML:-1,decodeCellQnum_XMLBoard:function(){var i=0<this.board.cell[0].getminnum()?1:0,s=this.UNDECIDED_NUM_XML;this.decodeCellXMLBoard(function(t,e){e===s?t.qnum=-2:i<=e&&(t.qnum=e)})},encodeCellQnum_XMLBoard:function(){var i=0<this.board.cell[0].getminnum()?1:0,s=this.UNDECIDED_NUM_XML;this.encodeCellXMLBoard(function(t){var e=null;return-2===t.qnum?e=s:t.qnum>=i&&(e=t.qnum),e})},decodeCellQnum_XMLBoard_Brow:function(){var i=this.UNDECIDED_NUM_XML;this.decodeCellXMLBrow(function(t,e){e==="n"+i?t.qnum=-2:"s"!==e&&(t.qnum=+e.substr(1))})},encodeCellQnum_XMLBoard_Brow:function(){var e=this.UNDECIDED_NUM_XML;this.encodeCellXMLBrow(function(t){return-2===t.qnum?"n"+e:0<=t.qnum?"n"+t.qnum:"s"})},decodeCellAnum_XMLAnswer:function(){this.decodeCellXMLArow(function(t,e){"n0"===e?t.anum=-1:"s"!==e&&(t.anum=+e.substr(1))})},encodeCellAnum_XMLAnswer:function(){this.encodeCellXMLArow(function(t){return 0<t.anum?"n"+t.anum:-1===t.anum?"n0":"s"})},decodeAreaRoom_XMLBoard:function(){var i=[];this.decodeCellXMLBrow(function(t,e){i.push(+e.substr(1))}),this.rdata2Border(!0,i),this.board.roommgr.rebuild()},encodeAreaRoom_XMLBoard:function(){var t=this.board,e=(t.roommgr.rebuild(),t.roommgr.components);this.xmldoc.querySelector("board").appendChild(this.createXMLNode("areas",{N:e.length})),this.encodeCellXMLBrow(function(t){t=e.indexOf(t.room);return"n"+(0<t?t:-1)})},decodeCellAns_XMLAnswer:function(){this.decodeCellXMLArow(function(t,e){"w"===e?t.qans=1:"s"===e&&(t.qsub=1)})},encodeCellAns_XMLAnswer:function(){this.encodeCellXMLArow(function(t){return 1===t.qans?"w":1===t.qsub?"s":"u"})},decodeBorderLine_XMLAnswer:function(){this.decodeCellXMLArow(function(t,e){var i=0,s=t.adjborder.bottom,t=t.adjborder.right;"n"===e.charAt(0)?i=+e.substr(1):(e.match(/h/)&&(i+=1),e.match(/v/)&&(i+=2)),1&i&&(s.line=1),2&i&&(t.line=1),4&i&&(s.qsub=2),8&i&&(t.qsub=2)})},encodeBorderLine_XMLAnswer:function(){this.encodeCellXMLArow(function(t){var e=0,i=t.adjborder.bottom,t=t.adjborder.right;return 1===i.line&&(e+=1),1===t.line&&(e+=2),2===i.qsub&&(e+=4),2===t.qsub&&(e+=8),0===e?"s":1===e?"h":2===e?"v":3===e?"hv":"n"+e})}}}),p.classmgr.makeCommon({"StartGoalOperation:Operation":{setData:function(t,e,i,s,n){this.property=t,this.bx1=e,this.by1=i,this.bx2=s,this.by2=n},decode:function(t){return("PS"===t[0]||"PG"===t[0])&&(this.property="PS"===t[0]?"start":"goal",this.bx1=+t[1],this.by1=+t[2],this.bx2=+t[3],this.by2=+t[4],!0)},toString:function(){return["start"===this.property?"PS":"PG",this.bx1,this.by1,this.bx2,this.by2].join(",")},isModify:function(t){return!(!this.manager.changeflag||t.bx2!==this.bx1||t.by2!==this.by1||t.property!==this.property)&&(t.bx2=this.bx2,t.by2=this.by2,!0)},undo:function(){this.exec(this.bx1,this.by1)},redo:function(){this.exec(this.bx2,this.by2)},exec:function(t,e){var i=this.board,t=i.getc(t,e);"start"===this.property?i.startpos.set(t):"goal"===this.property&&i.goalpos.set(t)}}}),p.classmgr.makeCommon({"StartGoalAddress:Address":{type:"",partner:null,init:function(t,e){return this.bx=t,this.by=e,this},input:function(t){this.partner&&this.partner.equals(t)?this.board.exchangestartgoal():this.equals(t)?this.draw():this.set(t)},set:function(t,e){var i=this.getaddr();!1!==e&&this.addOpe(t.bx,t.by),this.bx=t.bx,this.by=t.by,i.draw(),this.draw()},addOpe:function(t,e){this.bx===t&&this.by===e||this.puzzle.opemgr.add(new this.klass.StartGoalOperation(this.type,this.bx,this.by,t,e))}},"StartAddress:StartGoalAddress":{type:"start"},"GoalAddress:StartGoalAddress":{type:"goal"}})}();
//# sourceMappingURL=pzpr.js.map